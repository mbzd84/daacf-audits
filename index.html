<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DGAC ‚Äî Plateforme de Surveillance</title>
<link rel="icon" href="icon-192.png">
<link rel="apple-touch-icon" href="icon-192.png">
<link rel="manifest" href="manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="DGAC">
<meta name="theme-color" content="#080C18">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet">
<style>
  *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
  :root{--bg:#080C18;--card:#0E1326;--card-hover:#121836;--border:rgba(255,255,255,0.06);--border-light:rgba(255,255,255,0.1);--text:#E2E8F0;--muted:rgba(255,255,255,0.4);--dim:rgba(255,255,255,0.25);--accent:#3B82F6;--accent-dark:#1D4ED8;--red:#EF4444;--orange:#F59E0B;--green:#10B981;--purple:#A78BFA;--cyan:#22D3EE;--teal:#14B8A6;--pink:#EC4899;--safe-bottom:env(safe-area-inset-bottom,0px)}
  body{background:var(--bg);color:var(--text);font-family:'DM Sans',sans-serif;min-height:100vh;overflow-x:hidden}
  .mono{font-family:'JetBrains Mono',monospace}
  ::-webkit-scrollbar{width:6px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.1);border-radius:3px}
  .header{padding:14px 28px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;background:rgba(8,12,24,0.97);backdrop-filter:blur(12px);position:sticky;top:0;z-index:100}
  .header-left{display:flex;align-items:center;gap:12px}
  .logo{width:34px;height:34px;border-radius:9px;background:linear-gradient(135deg,var(--accent),var(--accent-dark));display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0}
  .header-title{font-size:15px;font-weight:700;letter-spacing:-0.3px}
  .header-sub{font-size:10px;color:var(--dim);letter-spacing:0.5px}
  .header-right{display:flex;gap:8px;align-items:center}
  .desktop-tabs{display:flex;align-items:center;gap:2px;background:rgba(255,255,255,0.03);border-radius:10px;padding:3px;flex-wrap:wrap}
  .mobile-nav{display:none;position:fixed;bottom:0;left:0;right:0;background:rgba(8,12,24,0.97);backdrop-filter:blur(12px);border-top:1px solid var(--border);padding:4px 2px;padding-bottom:calc(4px + var(--safe-bottom));z-index:100;justify-content:space-around}
  .mobile-nav-btn{display:flex;flex-direction:column;align-items:center;gap:1px;background:none;border:none;color:var(--muted);font-size:9px;font-family:inherit;font-weight:600;cursor:pointer;padding:4px 3px;border-radius:8px;min-width:42px;position:relative}
  .mobile-nav-btn.active{color:var(--accent)}
  .mobile-nav-btn .nav-icon{font-size:18px}
  .mobile-nav-btn .nav-badge{position:absolute;top:0;right:0;font-size:8px;font-weight:700;background:var(--red);color:#fff;padding:1px 4px;border-radius:8px;font-family:'JetBrains Mono',monospace}
  .tab-btn{padding:6px 12px;border-radius:7px;border:none;font-size:11px;font-weight:600;cursor:pointer;font-family:inherit;display:flex;align-items:center;gap:4px;background:transparent;color:var(--muted);transition:all 0.15s;white-space:nowrap}
  .tab-btn.active{background:rgba(59,130,246,0.2);color:var(--accent)}
  .tab-count{font-size:9px;font-weight:700;font-family:'JetBrains Mono',monospace;padding:1px 5px;border-radius:8px;background:rgba(255,255,255,0.06)}
  .tab-btn.active .tab-count{background:rgba(59,130,246,0.3);color:var(--accent)}
  .btn{padding:8px 18px;border:none;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer;font-family:inherit;transition:opacity 0.15s}
  .btn:hover{opacity:0.85}.btn:disabled{opacity:0.5;cursor:not-allowed}.btn:active{transform:scale(0.97)}
  .btn-primary{background:var(--accent);color:#fff}.btn-orange{background:var(--orange);color:#fff}.btn-green{background:var(--green);color:#fff}.btn-purple{background:var(--purple);color:#fff}.btn-red{background:var(--red);color:#fff}.btn-teal{background:var(--teal);color:#fff}.btn-pink{background:var(--pink);color:#fff}
  .btn-outline{padding:7px 14px;background:transparent;border:1px solid rgba(59,130,246,0.3);border-radius:8px;font-size:12px;font-weight:600;cursor:pointer;font-family:inherit;color:var(--accent)}
  .btn-outline-red{border-color:rgba(239,68,68,0.3);color:var(--red)}
  .btn-sm{padding:5px 12px;font-size:11px}.btn-full{width:100%;padding:12px 0}
  .btn-icon{background:none;border:none;color:var(--dim);cursor:pointer;font-size:14px;padding:8px}
  .btn-fab{position:fixed;bottom:76px;right:16px;width:50px;height:50px;border-radius:50%;border:none;font-size:22px;cursor:pointer;box-shadow:0 4px 20px rgba(0,0,0,0.4);z-index:90;display:none;align-items:center;justify-content:center;color:#fff}
  .input,.select,.textarea{width:100%;padding:10px 12px;background:rgba(255,255,255,0.04);border:1px solid var(--border-light);border-radius:8px;color:var(--text);font-size:14px;outline:none;font-family:inherit}
  .input:focus,.select:focus,.textarea:focus{border-color:var(--accent)}.select{cursor:pointer}.textarea{min-height:70px;resize:vertical}
  .label{font-size:11px;color:var(--muted);margin-bottom:4px;display:block;font-weight:600;letter-spacing:0.5px;text-transform:uppercase}
  .card{background:var(--card);border:1px solid var(--border);border-radius:14px}.card-padded{padding:20px}
  .kpi-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:10px;margin-bottom:20px}
  .kpi{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px 18px;position:relative;overflow:hidden}
  .kpi-bar{position:absolute;top:0;left:0;width:3px;height:100%;border-radius:14px 0 0 14px}
  .kpi-label{font-size:9px;text-transform:uppercase;letter-spacing:1.2px;color:var(--muted);font-weight:600}
  .kpi-value{font-size:26px;font-weight:700;margin-top:3px}.kpi-sub{font-size:11px;color:var(--dim);margin-top:2px}
  .badge{display:inline-block;padding:3px 10px;border-radius:12px;font-size:11px;font-weight:600;white-space:nowrap}
  .table-container{background:var(--card);border:1px solid var(--border);border-radius:12px;overflow:hidden}
  .table-row{display:grid;padding:12px 18px;border-bottom:1px solid var(--border);align-items:center;cursor:pointer;transition:background 0.1s}
  .table-row:hover{background:var(--card-hover)}
  .mobile-card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px;margin-bottom:10px;cursor:pointer}
  .mobile-card:active{border-color:rgba(59,130,246,0.3)}
  .mobile-card-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:6px}
  .mobile-card-title{font-size:14px;font-weight:600}.mobile-card-id{font-size:11px;color:var(--dim);margin-top:2px}
  .mobile-card-meta{display:flex;gap:6px;flex-wrap:wrap;margin-top:8px}
  .mobile-card-footer{display:flex;justify-content:space-between;align-items:center;margin-top:10px;padding-top:10px;border-top:1px solid var(--border)}
  .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.7);backdrop-filter:blur(6px);display:flex;align-items:center;justify-content:center;z-index:1000;padding:10px}
  .modal{background:#111827;border:1px solid var(--border-light);border-radius:16px;padding:24px;max-width:94vw;max-height:90vh;overflow-y:auto;width:540px}
  .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
  .modal-title{font-size:18px;font-weight:700}
  .form-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}.form-span{grid-column:1/-1}
  .filters{display:flex;gap:10px;margin-bottom:18px;flex-wrap:wrap;align-items:center}
  .filter-group{display:flex;gap:3px;background:rgba(255,255,255,0.03);border-radius:8px;padding:3px;flex-wrap:wrap}
  .filter-btn{padding:6px 12px;border-radius:6px;border:none;font-size:11px;font-weight:600;cursor:pointer;font-family:inherit;background:transparent;color:var(--muted);white-space:nowrap}
  .filter-btn.active{background:rgba(59,130,246,0.2);color:var(--accent)}.spacer{flex:1}
  .alert{padding:16px 18px;border-radius:12px;margin-bottom:20px}
  .alert-red{background:rgba(239,68,68,0.06);border:1px solid rgba(239,68,68,0.15)}
  .alert-orange{background:rgba(245,158,11,0.06);border:1px solid rgba(245,158,11,0.15)}
  .alert-title{font-size:14px;font-weight:700;margin-bottom:10px}
  .empty{padding:40px 20px;text-align:center;color:var(--dim);font-size:14px}
  .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:16px}.grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px}.grid-span{grid-column:1/-1}
  .bar-track{height:6px;background:rgba(255,255,255,0.04);border-radius:3px}.bar-fill{height:100%;border-radius:3px;transition:width 0.4s}
  .kanban{display:flex;gap:12px;overflow-x:auto;padding-bottom:10px;-webkit-overflow-scrolling:touch}
  .kanban-col{min-width:170px;flex:1}.kanban-title{font-size:12px;font-weight:700;margin-bottom:10px;padding:0 4px}
  .kanban-card{padding:14px;background:var(--card);border:1px solid var(--border);border-radius:10px;margin-bottom:8px;cursor:pointer}
  .kanban-card:active{border-color:rgba(59,130,246,0.3)}
  .login-page{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px}
  .login-box{width:420px;max-width:100%}.login-header{text-align:center;margin-bottom:32px}
  .login-icon{font-size:48px;margin-bottom:14px}.login-title{font-size:22px;font-weight:700}
  .login-sub{color:var(--muted);font-size:14px;margin-top:6px}
  .error-box{padding:10px 14px;background:rgba(239,68,68,0.08);border:1px solid rgba(239,68,68,0.2);border-radius:8px;color:var(--red);font-size:12px;margin-bottom:14px}
  .user-badge{display:flex;align-items:center;gap:8px;padding:5px 12px;background:rgba(255,255,255,0.04);border-radius:8px;font-size:12px;color:var(--muted)}
  .user-dot{width:8px;height:8px;border-radius:50%;background:var(--green);flex-shrink:0}
  .chart-card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:20px;overflow:hidden}
  .chart-title{font-size:13px;font-weight:700;margin-bottom:16px;display:flex;justify-content:space-between;align-items:center}
  .donut-legend{margin-top:14px}.legend-item{display:flex;align-items:center;gap:8px;margin-bottom:6px;font-size:12px}
  .legend-dot{width:10px;height:10px;border-radius:3px;flex-shrink:0}
  .legend-val{margin-left:auto;font-weight:700;font-family:'JetBrains Mono',monospace;font-size:12px}
  .pipeline{display:flex;gap:2px;align-items:flex-end;height:100px;padding-top:10px}
  .pipeline-label{font-size:9px;color:var(--muted);text-align:center;margin-top:6px;font-weight:600;line-height:1.2}
  .pipeline-count{font-size:13px;font-weight:700;text-align:center;margin-bottom:4px;font-family:'JetBrains Mono',monospace}
  .pipeline-bar{flex:1;border-radius:6px 6px 0 0;transition:height 0.5s;min-width:20px}
  .section-title{font-size:16px;font-weight:700;margin-bottom:16px;margin-top:28px;padding-bottom:8px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:8px}
  .section-title:first-child{margin-top:0}
  .stat-row{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid var(--border)}.stat-row:last-child{border:none}
  .progress-ring{transform:rotate(-90deg);transform-origin:center}
  .renouv-list{margin-top:14px}.renouv-item{padding:10px;background:rgba(255,255,255,0.02);border:1px solid var(--border);border-radius:8px;margin-bottom:6px;font-size:12px}
  .expiry-warn{animation:pulse 2s infinite}@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.6}}
  @media(max-width:768px){
    .header{padding:10px 14px}.header-title{font-size:13px}.header-sub{display:none}
    .desktop-tabs{display:none!important}.header-right .user-badge{display:none}.header-right .btn-outline:not(.btn-outline-red){display:none}
    .mobile-nav{display:flex!important}.btn-fab{display:flex!important}
    main{padding:14px 12px 90px 12px!important}
    .filters{gap:6px}.filter-group{overflow-x:auto;flex-wrap:nowrap;-webkit-overflow-scrolling:touch}
    .filter-btn{padding:5px 9px;font-size:10px;flex-shrink:0}
    .form-grid{grid-template-columns:1fr}.form-span{grid-column:1}
    .grid-2,.grid-3{grid-template-columns:1fr}.grid-span{grid-column:1}
    .modal{padding:20px 16px;width:100%;max-width:100%;border-radius:14px 14px 0 0;position:fixed;bottom:0;left:0;right:0;max-height:92vh}
    .modal-overlay{align-items:flex-end;padding:0}
    .kpi-grid{grid-template-columns:1fr 1fr;gap:8px}.kpi{padding:12px 14px}.kpi-value{font-size:22px}.kpi-label{font-size:8px}
    .desktop-only{display:none!important}.mobile-only{display:block!important}
    .input,.select,.textarea{font-size:16px;padding:12px}.btn{padding:10px 18px;font-size:14px}.btn-full{padding:14px 0}
    .filters .btn{display:none}.alert{padding:12px 14px}.chart-card{padding:16px}
  }
  @media(min-width:769px){.mobile-only{display:none!important}.mobile-nav{display:none!important}.btn-fab{display:none!important}}
</style>
</head>
<body>
<div id="app"></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
<script type="text/babel">
const{useState,useEffect,useCallback}=React;
const SB_URL="https://apfcujkxcxhfrjbafgaa.supabase.co";
const SB_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFwZmN1amt4Y3hoZnJqYmFmZ2FhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEzMjA0NTksImV4cCI6MjA4Njg5NjQ1OX0.S-29PtjyHn1knDIfdVERhLXCDh_JS0tc3oZqAEqwVQ0";
const authApi={async login(e,p){const r=await fetch(`${SB_URL}/auth/v1/token?grant_type=password`,{method:"POST",headers:{apikey:SB_KEY,"Content-Type":"application/json"},body:JSON.stringify({email:e,password:p})});const d=await r.json();if(!r.ok)throw new Error(d.error_description||d.msg||"√âchec");return d},async logout(t){await fetch(`${SB_URL}/auth/v1/logout`,{method:"POST",headers:{apikey:SB_KEY,Authorization:`Bearer ${t}`,"Content-Type":"application/json"}})},async getUser(t){const r=await fetch(`${SB_URL}/auth/v1/user`,{headers:{apikey:SB_KEY,Authorization:`Bearer ${t}`}});if(!r.ok)throw new Error("Expir√©");return r.json()}};
const createApi=(t)=>{const h={apikey:SB_KEY,Authorization:`Bearer ${t}`,"Content-Type":"application/json",Prefer:"return=representation"};const b=`${SB_URL}/rest/v1`;return{async select(tb,q=""){const r=await fetch(`${b}/${tb}?${q}`,{headers:h});if(!r.ok)throw new Error(r.statusText);return r.json()},async insert(tb,d){const r=await fetch(`${b}/${tb}`,{method:"POST",headers:h,body:JSON.stringify(d)});if(!r.ok){const e=await r.json();throw new Error(e.message||r.statusText)}return r.json()},async update(tb,id,d){const r=await fetch(`${b}/${tb}?id=eq.${id}`,{method:"PATCH",headers:h,body:JSON.stringify(d)});if(!r.ok)throw new Error(r.statusText);return r.json()},async remove(tb,id){const r=await fetch(`${b}/${tb}?id=eq.${id}`,{method:"DELETE",headers:h});if(!r.ok)throw new Error(r.statusText);return true}}};

// CONSTANTS
const DOMAINES=["PEL","OPS","AIR","ANS","AIG","LEG","ORG","AGA"];
const TYPES_AUDIT=["Interne","Externe","Suivi","Sp√©cial"];
const STATUTS_AUDIT=["Planifi√©","En cours","Rapport √©mis","En suivi","Cl√¥tur√©"];
const CLASSEMENTS=["NC","PC","OBS","OFI"];
const CRITICITES=["Bloquant","Majeur","Mineur"];
const STATUTS_FINDING=["Ouvert","CAPA demand√©e","CAPA accept√©e","En cours","V√©rification","Cl√¥tur√©"];
const STATUTS_CAPA=["Brouillon","Soumise","Accept√©e","En cours","R√©alis√©e","V√©rifi√©e efficace","Rejet√©e"];
const TYPES_PREUVE=["Proc√©dure","Enregistrement","Formation","Capture","Email","Rapport","Autre"];
const STATUTS_PREUVE=["Soumise","Accept√©e","Refus√©e"];
const TYPES_AGREMENT=["ATO","AMO","AOC","ATCO","AeMC","FSTD","DTO","Autre"];
const STATUTS_AGREMENT=["Actif","Suspendu","R√©voqu√©","Expir√©"];
const TYPES_AUTORISATION=["Exploitation a√©rienne","Formation","Maintenance","Navigation a√©rienne","Travail a√©rien","Transport","Survol","Atterrissage","Autre"];
const STATUTS_AUTORISATION=["Accord√©e","Refus√©e","Expir√©e","Retir√©e","En cours d'examen"];
const DECISIONS_RENOUV=["Renouvel√©","Renouvel√© avec conditions","Refus√©","En attente"];

const SC={"Planifi√©":"#3B82F6","En cours":"#F59E0B","Rapport √©mis":"#A78BFA","En suivi":"#22D3EE","Cl√¥tur√©":"#10B981","Ouvert":"#EF4444","CAPA demand√©e":"#F59E0B","CAPA accept√©e":"#22D3EE","V√©rification":"#A78BFA","Brouillon":"rgba(255,255,255,0.4)","Soumise":"#F59E0B","Accept√©e":"#22D3EE","R√©alis√©e":"#10B981","V√©rifi√©e efficace":"#10B981","Rejet√©e":"#EF4444","Refus√©e":"#EF4444","Actif":"#10B981","Suspendu":"#F59E0B","R√©voqu√©":"#EF4444","Expir√©":"rgba(255,255,255,0.4)","Accord√©e":"#10B981","Retir√©e":"#EF4444","En cours d'examen":"#3B82F6","Expir√©e":"rgba(255,255,255,0.4)"};
const CC={"Bloquant":"#EF4444","Majeur":"#F59E0B","Mineur":"#22D3EE"};
const XC={"NC":"#EF4444","PC":"#F59E0B","OBS":"#3B82F6","OFI":"#10B981"};

// SHARED UI
function Badge({children,color}){return <span className="badge" style={{background:`${color||'#888'}18`,color:color||'#888'}}>{children}</span>}
function Tag({label}){return <Badge color={SC[label]}>{label}</Badge>}
function Empty({text}){return <div className="empty">{text}</div>}
function KPI({label,value,sub,color,pct}){return(<div className="kpi"><div className="kpi-bar" style={{background:color}}/><div className="kpi-label">{label}</div><div style={{display:'flex',alignItems:'flex-end',gap:6}}><div className="kpi-value mono" style={{color}}>{value}</div>{pct!==undefined&&<div style={{fontSize:11,fontWeight:700,marginBottom:4,color:pct>=50?'var(--red)':'var(--green)'}}>{pct}%</div>}</div>{sub&&<div className="kpi-sub">{sub}</div>}</div>)}
function Modal({onClose,title,width,children}){return(<div className="modal-overlay" onClick={onClose}><div className="modal" style={{width:width||540}} onClick={e=>e.stopPropagation()}><div className="modal-header"><h3 className="modal-title">{title}</h3><button className="btn-icon" onClick={onClose} style={{fontSize:20}}>‚úï</button></div>{children}</div></div>)}
function Field({label,span,children}){return <div className={span?"form-span":""}><label className="label">{label}</label>{children}</div>}
function Sel({value,onChange,options}){return(<select className="select" value={value} onChange={e=>onChange(e.target.value)}>{options.map(o=><option key={o} value={o}>{o}</option>)}</select>)}
function ConfirmDelete({item,onConfirm,onCancel}){return(<Modal onClose={onCancel} title="Supprimer ?" width={400}><p style={{color:'var(--muted)',fontSize:14,lineHeight:1.6}}>Supprimer <strong style={{color:'var(--red)'}}>{item}</strong> ?</p><div style={{display:'flex',gap:10,justifyContent:'flex-end',marginTop:20}}><button className="btn btn-outline" onClick={onCancel}>Annuler</button><button className="btn btn-red" onClick={onConfirm}>Supprimer</button></div></Modal>)}
function FAB({onClick,color}){return(<button className="btn-fab" style={{background:color||'var(--accent)'}} onClick={onClick}>+</button>)}

// CHARTS
function DonutChart({data,size=120,thickness=18,centerLabel,centerValue}){const total=data.reduce((s,d)=>s+d.value,0);if(total===0)return(<div style={{textAlign:'center',padding:20}}><span style={{color:'var(--dim)',fontSize:13}}>Aucune donn√©e</span></div>);const r=(size-thickness)/2;const cx=size/2;const cy=size/2;const circ=2*Math.PI*r;let offset=0;return(<div style={{display:'flex',flexDirection:'column',alignItems:'center'}}><svg width={size} height={size} viewBox={`0 0 ${size} ${size}`} style={{overflow:'hidden',display:'block',margin:'0 auto'}}><circle cx={cx} cy={cy} r={r} fill="none" stroke="rgba(255,255,255,0.04)" strokeWidth={thickness}/>{data.filter(d=>d.value>0).map((d,i)=>{const pct=d.value/total;const len=pct*circ;const gap=data.filter(x=>x.value>0).length>1?2:0;const dash=`${Math.max(0,len-gap)} ${circ-Math.max(0,len-gap)}`;const el=<circle key={i} cx={cx} cy={cy} r={r} fill="none" stroke={d.color} strokeWidth={thickness} strokeDasharray={dash} strokeDashoffset={-offset} strokeLinecap="round" className="progress-ring"/>;offset+=len;return el})}{centerLabel&&<><text x={cx} y={cy-6} textAnchor="middle" fill="var(--text)" fontSize="20" fontWeight="700" fontFamily="JetBrains Mono">{centerValue}</text><text x={cx} y={cy+12} textAnchor="middle" fill="var(--muted)" fontSize="9" fontWeight="600" letterSpacing="0.5">{centerLabel}</text></>}</svg><div className="donut-legend">{data.filter(d=>d.value>0).map((d,i)=>(<div key={i} className="legend-item"><div className="legend-dot" style={{background:d.color}}/><span style={{color:'var(--muted)'}}>{d.label}</span><span className="legend-val" style={{color:d.color}}>{d.value}</span></div>))}</div></div>)}
function PipelineChart({data}){const mx=Math.max(...data.map(d=>d.value),1);return(<div><div className="pipeline">{data.map((d,i)=>(<div key={i} style={{flex:1,textAlign:'center'}}><div className="pipeline-count" style={{color:d.color}}>{d.value}</div><div style={{height:80,display:'flex',alignItems:'flex-end',justifyContent:'center'}}><div className="pipeline-bar" style={{width:'100%',height:`${Math.max((d.value/mx)*100,6)}%`,background:d.color,opacity:0.7}}/></div><div className="pipeline-label">{d.label}</div></div>))}</div></div>)}
function ProgressGauge({value,max,label,color}){const pct=max>0?Math.round((value/max)*100):0;return(<div style={{textAlign:'center'}}><svg width={80} height={50} viewBox="0 0 80 50"><path d="M 10 45 A 30 30 0 0 1 70 45" fill="none" stroke="rgba(255,255,255,0.06)" strokeWidth="6" strokeLinecap="round"/><path d="M 10 45 A 30 30 0 0 1 70 45" fill="none" stroke={color} strokeWidth="6" strokeLinecap="round" strokeDasharray={`${(pct/100)*94.25} 94.25`}/><text x="40" y="42" textAnchor="middle" fill={color} fontSize="16" fontWeight="700" fontFamily="JetBrains Mono">{pct}%</text></svg><div style={{fontSize:10,color:'var(--muted)',fontWeight:600,marginTop:2}}>{label}</div></div>)}

// Helper: days until expiry
function daysUntil(date){if(!date)return null;const d=Math.ceil((new Date(date)-new Date())/864e5);return d}
function ExpiryBadge({date}){const d=daysUntil(date);if(d===null)return <span style={{fontSize:11,color:'var(--dim)'}}>‚Äî</span>;if(d<0)return <Badge color="#EF4444">Expir√© {Math.abs(d)}j</Badge>;if(d<=30)return <span className="expiry-warn"><Badge color="#F59E0B">{d}j restants</Badge></span>;if(d<=90)return <Badge color="#22D3EE">{d}j restants</Badge>;return <span style={{fontSize:11,color:'var(--dim)'}}>{date}</span>}

// LOGIN
function LoginScreen({onLogin}){const[email,setEmail]=useState("");const[pw,setPw]=useState("");const[ld,setLd]=useState(false);const[err,setErr]=useState("");const go=async()=>{if(!email||!pw){setErr("Remplissez les deux champs");return}setLd(true);setErr("");try{const d=await authApi.login(email,pw);localStorage.setItem("sb_token",d.access_token);localStorage.setItem("sb_user_email",d.user.email);onLogin(d.access_token,d.user)}catch(e){setErr(e.message==="Invalid login credentials"?"Email ou mot de passe incorrect":e.message)}setLd(false)};return(<div className="login-page"><div className="login-box"><div className="login-header"><div className="login-icon">‚úàÔ∏è</div><h1 className="login-title">DGAC ‚Äî Plateforme de Surveillance</h1><p className="login-sub">Connectez-vous pour acc√©der</p></div><div className="card card-padded"><div style={{marginBottom:16}}><label className="label">Email</label><input className="input" type="email" value={email} onChange={e=>setEmail(e.target.value)} placeholder="votre.email@dgac.tn" onKeyDown={e=>e.key==='Enter'&&go()}/></div><div style={{marginBottom:16}}><label className="label">Mot de passe</label><input className="input" type="password" value={pw} onChange={e=>setPw(e.target.value)} placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" onKeyDown={e=>e.key==='Enter'&&go()}/></div>{err&&<div className="error-box">{err}</div>}<button className="btn btn-primary btn-full" onClick={go} disabled={ld} style={{background:'linear-gradient(135deg,#3B82F6,#1D4ED8)'}}>{ld?"Connexion...":"Se connecter"}</button></div><p style={{textAlign:'center',marginTop:14,fontSize:12,color:'var(--dim)'}}>Direction G√©n√©rale de l'Aviation Civile ‚Äî Tunisie</p></div></div>)}

// ============================================================
// DASHBOARD
// ============================================================
function Dashboard({audits,findings,capa,preuves,agrements,autorisations,onNav}){
  const today=new Date().toISOString().slice(0,10);const open=findings.filter(f=>f.statut!=="Cl√¥tur√©");const closed=findings.filter(f=>f.statut==="Cl√¥tur√©");const overdue=open.filter(f=>f.echeance&&f.echeance<today);const bloq=open.filter(f=>f.criticite==="Bloquant");const actifs=audits.filter(a=>["En cours","Rapport √©mis","En suivi"].includes(a.statut));const closureRate=findings.length>0?Math.round((closed.length/findings.length)*100):0;const overdueRate=open.length>0?Math.round((overdue.length/open.length)*100):0;
  const agrActifs=agrements.filter(a=>a.statut==="Actif");const agrExpSoon=agrements.filter(a=>{const d=daysUntil(a.date_expiration);return a.statut==="Actif"&&d!==null&&d>=0&&d<=90});const autActives=autorisations.filter(a=>a.statut==="Accord√©e");
  const auditStatData=STATUTS_AUDIT.map(s=>({label:s,value:audits.filter(a=>a.statut===s).length,color:SC[s]}));
  const classData=CLASSEMENTS.map(c=>({label:c,value:findings.filter(f=>f.classement===c).length,color:XC[c]}));
  const critData=CRITICITES.map(c=>({label:c,value:open.filter(f=>f.criticite===c).length,color:CC[c]}));
  const agrStatData=STATUTS_AGREMENT.map(s=>({label:s,value:agrements.filter(a=>a.statut===s).length,color:SC[s]}));
  const findPipe=["Ouvert","CAPA demand√©e","En cours","V√©rification","Cl√¥tur√©"].map(s=>({label:s==="CAPA demand√©e"?"CAPA dem.":s,value:findings.filter(f=>f.statut===s).length,color:SC[s]}));
  const capaPipe=["Brouillon","Soumise","Accept√©e","En cours","R√©alis√©e","V√©rifi√©e"].map(s=>{const full=s==="V√©rifi√©e"?"V√©rifi√©e efficace":s;return{label:s,value:capa.filter(c=>c.statut===full).length,color:SC[full]||'#888'}});
  return(<div>
    <div className="kpi-grid">
      <KPI label="Audits actifs" value={actifs.length} sub={`${audits.length} total`} color="#3B82F6"/>
      <KPI label="√âcarts ouverts" value={open.length} sub={`${findings.length} total`} color="#F59E0B"/>
      <KPI label="Bloquants" value={bloq.length} sub="Criticit√© haute" color="#EF4444"/>
      <KPI label="Taux cl√¥ture" value={`${closureRate}%`} sub={`${closed.length}/${findings.length}`} color="#10B981"/>
      <KPI label="Agr√©ments actifs" value={agrActifs.length} sub={`${agrements.length} total`} color="#14B8A6"/>
      <KPI label="Expirent bient√¥t" value={agrExpSoon.length} sub="‚â§ 90 jours" color={agrExpSoon.length>0?"#F59E0B":"#10B981"}/>
      <KPI label="Autorisations" value={autActives.length} sub={`${autorisations.length} total`} color="#EC4899"/>
    </div>
    {overdue.length>0&&(<div className="alert alert-red"><div className="alert-title" style={{color:'var(--red)'}}>‚ö† √âcarts en retard ({overdue.length})</div>{overdue.sort((a,b)=>Math.ceil((new Date(today)-new Date(b.echeance))/864e5)-Math.ceil((new Date(today)-new Date(a.echeance))/864e5)).slice(0,5).map((f,i)=>{const days=Math.ceil((new Date(today)-new Date(f.echeance))/864e5);const au=audits.find(a=>a.id===f.audit_uuid);return(<div key={i} style={{display:'flex',justifyContent:'space-between',alignItems:'center',padding:'5px 0',borderBottom:i<4?'1px solid var(--border)':'none',gap:8}}><div style={{fontSize:12,color:'rgba(255,255,255,0.6)',overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap',minWidth:0}}><span className="mono" style={{color:'var(--dim)',fontSize:10,marginRight:6}}>{f.finding_id}</span>{au?.entite} ‚Äî {f.titre?.slice(0,30)}</div><Badge color="#EF4444">{days}j</Badge></div>)})}</div>)}
    {agrExpSoon.length>0&&(<div className="alert alert-orange"><div className="alert-title" style={{color:'var(--orange)'}}>üîî Agr√©ments expirant bient√¥t ({agrExpSoon.length})</div>{agrExpSoon.sort((a,b)=>daysUntil(a.date_expiration)-daysUntil(b.date_expiration)).slice(0,5).map((a,i)=>{const d=daysUntil(a.date_expiration);return(<div key={i} style={{display:'flex',justifyContent:'space-between',alignItems:'center',padding:'5px 0',borderBottom:i<4?'1px solid var(--border)':'none',gap:8}}><div style={{fontSize:12,color:'rgba(255,255,255,0.6)',overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}><Badge color="#14B8A6">{a.type_agrement}</Badge> <span style={{marginLeft:6}}>{a.entite}</span></div><Badge color={d<=30?"#EF4444":"#F59E0B"}>{d}j</Badge></div>)})}</div>)}
    <div className="section-title">üìä Vue d'ensemble</div>
    <div className="grid-3" style={{marginBottom:20}}>
      <div className="chart-card"><div className="chart-title">Audits</div><DonutChart data={auditStatData} centerLabel="AUDITS" centerValue={audits.length}/></div>
      <div className="chart-card"><div className="chart-title">√âcarts</div><DonutChart data={classData} centerLabel="√âCARTS" centerValue={findings.length}/></div>
      <div className="chart-card"><div className="chart-title">Agr√©ments</div><DonutChart data={agrStatData} centerLabel="AGR√âMENTS" centerValue={agrements.length}/></div>
    </div>
    <div className="grid-2" style={{marginBottom:20}}>
      <div className="chart-card"><div className="chart-title">Pipeline √©carts</div><PipelineChart data={findPipe}/></div>
      <div className="chart-card"><div className="chart-title">Pipeline CAPA</div><PipelineChart data={capaPipe}/></div>
    </div>
    <div className="grid-2">
      <div className="chart-card"><div className="chart-title">Indicateurs</div><div style={{display:'flex',justifyContent:'space-around',flexWrap:'wrap',gap:10,padding:'8px 0'}}><ProgressGauge value={closed.length} max={findings.length} label="Cl√¥ture" color="#10B981"/><ProgressGauge value={preuves.filter(p=>p.statut==="Accept√©e").length} max={preuves.length} label="Preuves OK" color="#22D3EE"/><ProgressGauge value={capa.filter(c=>["R√©alis√©e","V√©rifi√©e efficace"].includes(c.statut)).length} max={capa.length} label="CAPA" color="#A78BFA"/></div></div>
      <div className="chart-card"><div className="chart-title">Audits actifs <button className="btn-outline btn-sm" onClick={()=>onNav("audits")} style={{marginLeft:'auto'}}>‚Üí</button></div>{actifs.length===0&&<div style={{color:'var(--dim)',fontSize:13}}>Aucun</div>}{actifs.slice(0,5).map(a=>{const op=findings.filter(f=>f.audit_uuid===a.id&&f.statut!=="Cl√¥tur√©").length;return(<div key={a.id} style={{display:'flex',justifyContent:'space-between',alignItems:'center',padding:'8px 0',borderBottom:'1px solid var(--border)',gap:6}}><div style={{minWidth:0,overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}><span className="mono" style={{fontSize:10,color:'var(--dim)',marginRight:6}}>{a.audit_id}</span><span style={{fontSize:12}}>{a.entite}</span></div><div style={{display:'flex',gap:4,flexShrink:0}}><Tag label={a.statut}/>{op>0&&<Badge color="#F59E0B">{op}</Badge>}</div></div>)})}</div>
    </div>
  </div>)
}

// ============================================================
// FORMS - AUDIT / FINDING / CAPA / PREUVE (same as before)
// ============================================================
function AuditForm({audit,onClose,onSave}){const[f,setF]=useState(audit||{audit_id:"",domaine:"OPS",entite:"",type_audit:"Interne",date_debut:"",date_fin:"",statut:"Planifi√©",equipe:"",cycle_surveillance:"",notes:""});return(<Modal onClose={onClose} title={audit?`Modifier ${audit.audit_id}`:"Nouvel Audit"}><div className="form-grid"><Field label="Audit ID *"><input className="input" value={f.audit_id} onChange={e=>setF({...f,audit_id:e.target.value})} placeholder="2026-PEL-003"/></Field><Field label="Domaine"><Sel value={f.domaine} onChange={v=>setF({...f,domaine:v})} options={DOMAINES}/></Field><Field label="Entit√© *" span><input className="input" value={f.entite} onChange={e=>setF({...f,entite:e.target.value})}/></Field><Field label="Type"><Sel value={f.type_audit} onChange={v=>setF({...f,type_audit:v})} options={TYPES_AUDIT}/></Field><Field label="Statut"><Sel value={f.statut} onChange={v=>setF({...f,statut:v})} options={STATUTS_AUDIT}/></Field><Field label="Date d√©but"><input type="date" className="input" value={f.date_debut||""} onChange={e=>setF({...f,date_debut:e.target.value})}/></Field><Field label="Date fin"><input type="date" className="input" value={f.date_fin||""} onChange={e=>setF({...f,date_fin:e.target.value})}/></Field><Field label="√âquipe"><input className="input" value={f.equipe||""} onChange={e=>setF({...f,equipe:e.target.value})}/></Field><Field label="Cycle"><input className="input" value={f.cycle_surveillance||""} onChange={e=>setF({...f,cycle_surveillance:e.target.value})} placeholder="Annuel"/></Field><Field label="Notes" span><textarea className="textarea" value={f.notes||""} onChange={e=>setF({...f,notes:e.target.value})}/></Field></div><button className="btn btn-primary btn-full" style={{marginTop:16}} onClick={()=>onSave(f)}>{audit?"Enregistrer":"Cr√©er"}</button></Modal>)}
function FindingForm({finding,audits,onClose,onSave}){const[f,setF]=useState(finding||{finding_id:"",audit_uuid:audits[0]?.id||"",titre:"",constat:"",reference_regl:"",classement:"OBS",criticite:"Mineur",echeance:"",statut:"Ouvert",cause_racine:""});return(<Modal onClose={onClose} title={finding?`Modifier ${finding.finding_id}`:"Nouvel √âcart"} width={580}><div className="form-grid"><Field label="Finding ID *"><input className="input" value={f.finding_id} onChange={e=>setF({...f,finding_id:e.target.value})}/></Field><Field label="Audit"><select className="select" value={f.audit_uuid||""} onChange={e=>setF({...f,audit_uuid:e.target.value})}><option value="">‚Äî</option>{audits.map(a=><option key={a.id} value={a.id}>{a.audit_id} ‚Äî {a.entite}</option>)}</select></Field><Field label="Titre *" span><input className="input" value={f.titre} onChange={e=>setF({...f,titre:e.target.value})}/></Field><Field label="Constat" span><textarea className="textarea" value={f.constat||""} onChange={e=>setF({...f,constat:e.target.value})}/></Field><Field label="R√©f. r√©gl."><input className="input" value={f.reference_regl||""} onChange={e=>setF({...f,reference_regl:e.target.value})}/></Field><Field label="Classement"><Sel value={f.classement} onChange={v=>setF({...f,classement:v})} options={CLASSEMENTS}/></Field><Field label="Criticit√©"><Sel value={f.criticite} onChange={v=>setF({...f,criticite:v})} options={CRITICITES}/></Field><Field label="Statut"><Sel value={f.statut} onChange={v=>setF({...f,statut:v})} options={STATUTS_FINDING}/></Field><Field label="√âch√©ance"><input type="date" className="input" value={f.echeance||""} onChange={e=>setF({...f,echeance:e.target.value})}/></Field><Field label="Cause racine"><input className="input" value={f.cause_racine||""} onChange={e=>setF({...f,cause_racine:e.target.value})}/></Field></div><button className="btn btn-orange btn-full" style={{marginTop:16}} onClick={()=>onSave(f)}>{finding?"Enregistrer":"Cr√©er"}</button></Modal>)}
function CapaForm({capa,findings,onClose,onSave}){const[f,setF]=useState(capa||{action_id:"",finding_uuid:findings[0]?.id||"",action_corrective:"",action_preventive:"",responsable:"",echeance:"",statut:"Brouillon",avancement:0,cause_racine_detail:"",commentaire_verif:""});return(<Modal onClose={onClose} title={capa?`Modifier ${capa.action_id}`:"Nouvelle CAPA"} width={580}><div className="form-grid"><Field label="Action ID *"><input className="input" value={f.action_id} onChange={e=>setF({...f,action_id:e.target.value})}/></Field><Field label="Finding"><select className="select" value={f.finding_uuid||""} onChange={e=>setF({...f,finding_uuid:e.target.value})}><option value="">‚Äî</option>{findings.map(fi=><option key={fi.id} value={fi.id}>{fi.finding_id} ‚Äî {fi.titre}</option>)}</select></Field><Field label="Action corrective" span><textarea className="textarea" value={f.action_corrective||""} onChange={e=>setF({...f,action_corrective:e.target.value})}/></Field><Field label="Action pr√©ventive" span><textarea className="textarea" value={f.action_preventive||""} onChange={e=>setF({...f,action_preventive:e.target.value})}/></Field><Field label="Responsable"><input className="input" value={f.responsable||""} onChange={e=>setF({...f,responsable:e.target.value})}/></Field><Field label="√âch√©ance"><input type="date" className="input" value={f.echeance||""} onChange={e=>setF({...f,echeance:e.target.value})}/></Field><Field label="Statut"><Sel value={f.statut} onChange={v=>setF({...f,statut:v})} options={STATUTS_CAPA}/></Field><Field label="%"><input type="number" className="input" min={0} max={100} value={f.avancement} onChange={e=>setF({...f,avancement:Number(e.target.value)})}/></Field><Field label="Cause racine" span><textarea className="textarea" value={f.cause_racine_detail||""} onChange={e=>setF({...f,cause_racine_detail:e.target.value})}/></Field><Field label="V√©rification" span><textarea className="textarea" value={f.commentaire_verif||""} onChange={e=>setF({...f,commentaire_verif:e.target.value})}/></Field></div><button className="btn btn-green btn-full" style={{marginTop:16}} onClick={()=>onSave(f)}>{capa?"Enregistrer":"Cr√©er"}</button></Modal>)}
function PreuveForm({preuve,findings,capas,onClose,onSave}){const[f,setF]=useState(preuve||{evidence_id:"",finding_uuid:"",capa_uuid:"",type_preuve:"Autre",fichier_url:"",version:"v1.0",date_preuve:new Date().toISOString().slice(0,10),statut:"Soumise",motif_refus:"",date_expiration:""});return(<Modal onClose={onClose} title={preuve?`Modifier ${preuve.evidence_id}`:"Nouvelle Preuve"} width={520}><div className="form-grid"><Field label="Evidence ID *"><input className="input" value={f.evidence_id} onChange={e=>setF({...f,evidence_id:e.target.value})}/></Field><Field label="Type"><Sel value={f.type_preuve} onChange={v=>setF({...f,type_preuve:v})} options={TYPES_PREUVE}/></Field><Field label="Finding"><select className="select" value={f.finding_uuid||""} onChange={e=>setF({...f,finding_uuid:e.target.value})}><option value="">‚Äî</option>{findings.map(fi=><option key={fi.id} value={fi.id}>{fi.finding_id} ‚Äî {fi.titre}</option>)}</select></Field><Field label="CAPA"><select className="select" value={f.capa_uuid||""} onChange={e=>setF({...f,capa_uuid:e.target.value})}><option value="">‚Äî</option>{capas.map(c=><option key={c.id} value={c.id}>{c.action_id}</option>)}</select></Field><Field label="Lien" span><input className="input" value={f.fichier_url||""} onChange={e=>setF({...f,fichier_url:e.target.value})}/></Field><Field label="Version"><input className="input" value={f.version||""} onChange={e=>setF({...f,version:e.target.value})}/></Field><Field label="Date"><input type="date" className="input" value={f.date_preuve||""} onChange={e=>setF({...f,date_preuve:e.target.value})}/></Field><Field label="Statut"><Sel value={f.statut} onChange={v=>setF({...f,statut:v})} options={STATUTS_PREUVE}/></Field><Field label="Expiration"><input type="date" className="input" value={f.date_expiration||""} onChange={e=>setF({...f,date_expiration:e.target.value})}/></Field>{f.statut==="Refus√©e"&&<Field label="Motif" span><textarea className="textarea" value={f.motif_refus||""} onChange={e=>setF({...f,motif_refus:e.target.value})}/></Field>}</div><button className="btn btn-purple btn-full" style={{marginTop:16}} onClick={()=>onSave(f)}>{preuve?"Enregistrer":"Ajouter"}</button></Modal>)}

// ============================================================
// FORMS - AGREMENT / AUTORISATION / RENOUVELLEMENT
// ============================================================
function AgrementForm({agrement,audits,onClose,onSave}){const[f,setF]=useState(agrement||{agrement_id:"",entite:"",type_agrement:"ATO",domaine:"PEL",numero_agrement:"",date_delivrance:"",date_expiration:"",statut:"Actif",autorite_delivrance:"DGAC",notes:"",audit_uuid:""});return(<Modal onClose={onClose} title={agrement?`Modifier ${agrement.agrement_id}`:"Nouvel Agr√©ment"} width={580}><div className="form-grid">
  <Field label="ID Agr√©ment *"><input className="input" value={f.agrement_id} onChange={e=>setF({...f,agrement_id:e.target.value})} placeholder="AGR-2026-001"/></Field>
  <Field label="Type"><Sel value={f.type_agrement} onChange={v=>setF({...f,type_agrement:v})} options={TYPES_AGREMENT}/></Field>
  <Field label="Entit√© *" span><input className="input" value={f.entite} onChange={e=>setF({...f,entite:e.target.value})} placeholder="Silver Wings Training Center"/></Field>
  <Field label="Num√©ro agr√©ment"><input className="input" value={f.numero_agrement||""} onChange={e=>setF({...f,numero_agrement:e.target.value})} placeholder="TN-ATO-2026-001"/></Field>
  <Field label="Domaine"><Sel value={f.domaine||"PEL"} onChange={v=>setF({...f,domaine:v})} options={DOMAINES}/></Field>
  <Field label="Date d√©livrance"><input type="date" className="input" value={f.date_delivrance||""} onChange={e=>setF({...f,date_delivrance:e.target.value})}/></Field>
  <Field label="Date expiration"><input type="date" className="input" value={f.date_expiration||""} onChange={e=>setF({...f,date_expiration:e.target.value})}/></Field>
  <Field label="Statut"><Sel value={f.statut} onChange={v=>setF({...f,statut:v})} options={STATUTS_AGREMENT}/></Field>
  <Field label="Autorit√©"><input className="input" value={f.autorite_delivrance||""} onChange={e=>setF({...f,autorite_delivrance:e.target.value})}/></Field>
  <Field label="Audit li√©"><select className="select" value={f.audit_uuid||""} onChange={e=>setF({...f,audit_uuid:e.target.value})}><option value="">‚Äî Aucun ‚Äî</option>{audits.map(a=><option key={a.id} value={a.id}>{a.audit_id} ‚Äî {a.entite}</option>)}</select></Field>
  <Field label="Notes" span><textarea className="textarea" value={f.notes||""} onChange={e=>setF({...f,notes:e.target.value})}/></Field>
</div><button className="btn btn-teal btn-full" style={{marginTop:16}} onClick={()=>onSave(f)}>{agrement?"Enregistrer":"Cr√©er"}</button></Modal>)}

function AutorisationForm({autorisation,agrements,onClose,onSave}){const[f,setF]=useState(autorisation||{autorisation_id:"",type_autorisation:"Autre",beneficiaire:"",agrement_uuid:"",date_delivrance:"",date_expiration:"",statut:"Accord√©e",conditions:"",reference_regl:"",notes:""});return(<Modal onClose={onClose} title={autorisation?`Modifier ${autorisation.autorisation_id}`:"Nouvelle Autorisation"} width={580}><div className="form-grid">
  <Field label="ID Autorisation *"><input className="input" value={f.autorisation_id} onChange={e=>setF({...f,autorisation_id:e.target.value})} placeholder="AUT-2026-001"/></Field>
  <Field label="Type"><Sel value={f.type_autorisation} onChange={v=>setF({...f,type_autorisation:v})} options={TYPES_AUTORISATION}/></Field>
  <Field label="B√©n√©ficiaire *" span><input className="input" value={f.beneficiaire} onChange={e=>setF({...f,beneficiaire:e.target.value})}/></Field>
  <Field label="Agr√©ment parent"><select className="select" value={f.agrement_uuid||""} onChange={e=>setF({...f,agrement_uuid:e.target.value})}><option value="">‚Äî Aucun ‚Äî</option>{agrements.map(a=><option key={a.id} value={a.id}>{a.agrement_id} ‚Äî {a.entite}</option>)}</select></Field>
  <Field label="R√©f. r√©glementaire"><input className="input" value={f.reference_regl||""} onChange={e=>setF({...f,reference_regl:e.target.value})}/></Field>
  <Field label="Date d√©livrance"><input type="date" className="input" value={f.date_delivrance||""} onChange={e=>setF({...f,date_delivrance:e.target.value})}/></Field>
  <Field label="Date expiration"><input type="date" className="input" value={f.date_expiration||""} onChange={e=>setF({...f,date_expiration:e.target.value})}/></Field>
  <Field label="Statut"><Sel value={f.statut} onChange={v=>setF({...f,statut:v})} options={STATUTS_AUTORISATION}/></Field>
  <Field label="Conditions" span><textarea className="textarea" value={f.conditions||""} onChange={e=>setF({...f,conditions:e.target.value})}/></Field>
  <Field label="Notes" span><textarea className="textarea" value={f.notes||""} onChange={e=>setF({...f,notes:e.target.value})}/></Field>
</div><button className="btn btn-pink btn-full" style={{marginTop:16}} onClick={()=>onSave(f)}>{autorisation?"Enregistrer":"Cr√©er"}</button></Modal>)}

function RenouvForm({renouv,onClose,onSave,agrementId}){const[f,setF]=useState(renouv||{agrement_uuid:agrementId,date_renouvellement:new Date().toISOString().slice(0,10),ancienne_expiration:"",nouvelle_expiration:"",decision:"Renouvel√©",reference_decision:"",notes:""});return(<Modal onClose={onClose} title="Ajouter un renouvellement" width={480}><div className="form-grid">
  <Field label="Date renouvellement"><input type="date" className="input" value={f.date_renouvellement} onChange={e=>setF({...f,date_renouvellement:e.target.value})}/></Field>
  <Field label="D√©cision"><Sel value={f.decision} onChange={v=>setF({...f,decision:v})} options={DECISIONS_RENOUV}/></Field>
  <Field label="Ancienne expiration"><input type="date" className="input" value={f.ancienne_expiration||""} onChange={e=>setF({...f,ancienne_expiration:e.target.value})}/></Field>
  <Field label="Nouvelle expiration"><input type="date" className="input" value={f.nouvelle_expiration||""} onChange={e=>setF({...f,nouvelle_expiration:e.target.value})}/></Field>
  <Field label="R√©f. d√©cision" span><input className="input" value={f.reference_decision||""} onChange={e=>setF({...f,reference_decision:e.target.value})} placeholder="D√©cision N¬∞..."/></Field>
  <Field label="Notes" span><textarea className="textarea" value={f.notes||""} onChange={e=>setF({...f,notes:e.target.value})}/></Field>
</div><button className="btn btn-teal btn-full" style={{marginTop:16}} onClick={()=>onSave(f)}>Enregistrer</button></Modal>)}

// ============================================================
// MOBILE CARDS
// ============================================================
function MC_Audit({a,findings,onClick,onDel}){const af=findings.filter(f=>f.audit_uuid===a.id);const op=af.filter(f=>f.statut!=="Cl√¥tur√©").length;return(<div className="mobile-card" onClick={onClick}><div className="mobile-card-header"><div><div className="mobile-card-title">{a.entite}</div><div className="mobile-card-id mono">{a.audit_id}</div></div><button className="btn-icon" onClick={e=>{e.stopPropagation();onDel()}}>üóë</button></div><div className="mobile-card-meta"><Badge color="#A78BFA">{a.domaine}</Badge><Tag label={a.statut}/></div><div className="mobile-card-footer"><span style={{fontSize:11,color:'var(--dim)'}}>{a.date_debut||"‚Äî"}</span><span style={{fontSize:12,color:'var(--orange)'}}>{op}/{af.length}</span></div></div>)}
function MC_Finding({f,audits,onClick,onDel}){const today=new Date().toISOString().slice(0,10);const au=audits.find(a=>a.id===f.audit_uuid);const ov=f.statut!=="Cl√¥tur√©"&&f.echeance&&f.echeance<today;return(<div className="mobile-card" onClick={onClick} style={{borderLeft:ov?'3px solid var(--red)':'3px solid transparent'}}><div className="mobile-card-header"><div><div className="mobile-card-title">{f.titre}</div><div className="mobile-card-id mono">{f.finding_id}</div></div><button className="btn-icon" onClick={e=>{e.stopPropagation();onDel()}}>üóë</button></div><div className="mobile-card-meta"><Badge color={XC[f.classement]}>{f.classement}</Badge><Badge color={CC[f.criticite]}>{f.criticite}</Badge><Tag label={f.statut}/></div><div className="mobile-card-footer"><span style={{fontSize:11,color:ov?'var(--red)':'var(--dim)'}}>{f.echeance||"‚Äî"}</span></div></div>)}
function MC_Capa({c,findings,onClick,onDel}){const fi=findings.find(f=>f.id===c.finding_uuid);return(<div className="mobile-card" onClick={onClick}><div className="mobile-card-header"><div><div className="mobile-card-title">{c.action_corrective?.slice(0,50)||"‚Äî"}</div><div className="mobile-card-id mono">{c.action_id}</div></div><button className="btn-icon" onClick={e=>{e.stopPropagation();onDel()}}>üóë</button></div><div className="mobile-card-meta"><Tag label={c.statut}/></div><div className="mobile-card-footer"><span style={{fontSize:11,color:'var(--dim)'}}>{c.responsable||"‚Äî"}</span><span className="mono" style={{color:'var(--accent)',fontWeight:700}}>{c.avancement}%</span></div></div>)}
function MC_Preuve({p,findings,onClick,onDel}){const fi=findings.find(f=>f.id===p.finding_uuid);return(<div className="mobile-card" onClick={onClick}><div className="mobile-card-header"><div><div className="mobile-card-title">{fi?.titre?.slice(0,40)||"‚Äî"}</div><div className="mobile-card-id mono">{p.evidence_id}</div></div><button className="btn-icon" onClick={e=>{e.stopPropagation();onDel()}}>üóë</button></div><div className="mobile-card-meta"><Badge color="#22D3EE">{p.type_preuve}</Badge><Tag label={p.statut}/></div></div>)}
function MC_Agrement({a,onClick,onDel}){return(<div className="mobile-card" onClick={onClick}><div className="mobile-card-header"><div><div className="mobile-card-title">{a.entite}</div><div className="mobile-card-id mono">{a.agrement_id}</div></div><button className="btn-icon" onClick={e=>{e.stopPropagation();onDel()}}>üóë</button></div><div className="mobile-card-meta"><Badge color="#14B8A6">{a.type_agrement}</Badge><Tag label={a.statut}/></div><div className="mobile-card-footer"><span style={{fontSize:11,color:'var(--dim)'}}>{a.numero_agrement||"‚Äî"}</span><ExpiryBadge date={a.date_expiration}/></div></div>)}
function MC_Autorisation({a,agrements,onClick,onDel}){const ag=agrements.find(g=>g.id===a.agrement_uuid);return(<div className="mobile-card" onClick={onClick}><div className="mobile-card-header"><div><div className="mobile-card-title">{a.beneficiaire}</div><div className="mobile-card-id mono">{a.autorisation_id}</div></div><button className="btn-icon" onClick={e=>{e.stopPropagation();onDel()}}>üóë</button></div><div className="mobile-card-meta"><Badge color="#EC4899">{a.type_autorisation}</Badge><Tag label={a.statut}/></div><div className="mobile-card-footer"><span style={{fontSize:11,color:'var(--dim)'}}>{ag?.entite||"‚Äî"}</span><ExpiryBadge date={a.date_expiration}/></div></div>)}

// ============================================================
// TABLE VIEWS - AUDIT / FINDING / CAPA / PREUVE
// ============================================================
function AuditsView({api,audits,findings,reload}){const[sf,setSf]=useState(false);const[ed,setEd]=useState(null);const[fil,setFil]=useState("Tous");const[se,setSe]=useState("");const[del,setDel]=useState(null);const fl=audits.filter(a=>{if(fil!=="Tous"&&a.statut!==fil)return false;if(se&&!a.entite.toLowerCase().includes(se.toLowerCase())&&!a.audit_id.toLowerCase().includes(se.toLowerCase()))return false;return true});const save=async(d)=>{try{if(ed)await api.update("audits",ed.id,d);else await api.insert("audits",d);setSf(false);setEd(null);reload()}catch(e){alert(e.message)}};const rm=async()=>{if(del){try{await api.remove("audits",del.id)}catch(e){alert(e.message)}setDel(null);reload()}};return(<div><div className="filters"><input className="input" value={se} onChange={e=>setSe(e.target.value)} placeholder="Rechercher..." style={{width:220,maxWidth:'100%'}}/><div className="filter-group">{["Tous",...STATUTS_AUDIT].map(s=>(<button key={s} className={`filter-btn ${fil===s?'active':''}`} onClick={()=>setFil(s)}>{s}</button>))}</div><div className="spacer"/><button className="btn btn-primary" onClick={()=>{setEd(null);setSf(true)}}>+ Audit</button></div><div className="table-container desktop-only">{fl.map(a=>{const af=findings.filter(f=>f.audit_uuid===a.id);const op=af.filter(f=>f.statut!=="Cl√¥tur√©").length;return(<div key={a.id} className="table-row" style={{gridTemplateColumns:'100px 1fr 70px 80px 100px 60px 36px'}} onClick={()=>{setEd(a);setSf(true)}}><span className="mono" style={{fontSize:11,color:'var(--dim)'}}>{a.audit_id}</span><div><div style={{fontSize:13,fontWeight:600}}>{a.entite}</div><div style={{fontSize:11,color:'var(--dim)'}}>{a.equipe} ‚Ä¢ {a.date_debut||"‚Äî"}</div></div><Badge color="#A78BFA">{a.domaine}</Badge><span style={{fontSize:11,color:'var(--muted)'}}>{a.type_audit}</span><Tag label={a.statut}/><span style={{fontSize:12}}><span style={{color:'var(--orange)'}}>{op}</span><span style={{color:'var(--dim)'}}>/{af.length}</span></span><button className="btn-icon" onClick={e=>{e.stopPropagation();setDel(a)}}>üóë</button></div>)})}{fl.length===0&&<Empty text="Aucun audit"/>}</div><div className="mobile-only">{fl.map(a=><MC_Audit key={a.id} a={a} findings={findings} onClick={()=>{setEd(a);setSf(true)}} onDel={()=>setDel(a)}/>)}{fl.length===0&&<Empty text="Aucun audit"/>}</div><FAB onClick={()=>{setEd(null);setSf(true)}} color="var(--accent)"/>{sf&&<AuditForm audit={ed} onClose={()=>{setSf(false);setEd(null)}} onSave={save}/>}{del&&<ConfirmDelete item={del.audit_id} onConfirm={rm} onCancel={()=>setDel(null)}/>}</div>)}
function FindingsView({api,audits,findings,preuves,reload}){const[sf,setSf]=useState(false);const[ed,setEd]=useState(null);const[fil,setFil]=useState("Tous");const[cf,setCf]=useState("Tous");const[del,setDel]=useState(null);const today=new Date().toISOString().slice(0,10);const fl=findings.filter(f=>{if(fil==="Retard")return f.statut!=="Cl√¥tur√©"&&f.echeance&&f.echeance<today;if(fil==="Bloq.")return f.criticite==="Bloquant"&&f.statut!=="Cl√¥tur√©";if(fil==="Pr√™ts")return f.statut==="V√©rification"&&preuves.filter(p=>p.finding_uuid===f.id&&p.statut==="Accept√©e").length>=1;if(fil!=="Tous"&&f.statut!==fil)return false;if(cf!=="Tous"&&f.criticite!==cf)return false;return true});const save=async(d)=>{try{if(ed)await api.update("findings",ed.id,d);else await api.insert("findings",d);setSf(false);setEd(null);reload()}catch(e){alert(e.message)}};const rm=async()=>{if(del){try{await api.remove("findings",del.id)}catch(e){alert(e.message)}setDel(null);reload()}};return(<div><div className="filters"><div className="filter-group">{["Tous","Ouvert","En cours","V√©rification","Cl√¥tur√©","Retard","Bloq.","Pr√™ts"].map(s=>(<button key={s} className={`filter-btn ${fil===s?'active':''}`} onClick={()=>setFil(s)}>{s}</button>))}</div><select className="select" style={{width:100,fontSize:11}} value={cf} onChange={e=>setCf(e.target.value)}><option value="Tous">Toutes</option>{CRITICITES.map(c=><option key={c} value={c}>{c}</option>)}</select><div className="spacer"/><button className="btn btn-orange" onClick={()=>{setEd(null);setSf(true)}}>+ √âcart</button></div><div className="table-container desktop-only">{fl.map(f=>{const au=audits.find(a=>a.id===f.audit_uuid);const ov=f.statut!=="Cl√¥tur√©"&&f.echeance&&f.echeance<today;return(<div key={f.id} className="table-row" style={{gridTemplateColumns:'120px 1fr 50px 70px 95px 80px 36px',borderLeft:ov?'3px solid var(--red)':'3px solid transparent'}} onClick={()=>{setEd(f);setSf(true)}}><span className="mono" style={{fontSize:10,color:'var(--dim)'}}>{f.finding_id}</span><div><div style={{fontSize:13,fontWeight:600}}>{f.titre}</div><div style={{fontSize:11,color:'var(--dim)'}}>{au?.entite||"‚Äî"}</div></div><Badge color={XC[f.classement]}>{f.classement}</Badge><Badge color={CC[f.criticite]}>{f.criticite}</Badge><Tag label={f.statut}/><span style={{fontSize:11,color:ov?'var(--red)':'var(--dim)'}}>{f.echeance||"‚Äî"}</span><button className="btn-icon" onClick={e=>{e.stopPropagation();setDel(f)}}>üóë</button></div>)})}{fl.length===0&&<Empty text="Aucun √©cart"/>}</div><div className="mobile-only">{fl.map(f=><MC_Finding key={f.id} f={f} audits={audits} onClick={()=>{setEd(f);setSf(true)}} onDel={()=>setDel(f)}/>)}{fl.length===0&&<Empty text="Aucun √©cart"/>}</div><FAB onClick={()=>{setEd(null);setSf(true)}} color="var(--orange)"/>{sf&&<FindingForm finding={ed} audits={audits} onClose={()=>{setSf(false);setEd(null)}} onSave={save}/>}{del&&<ConfirmDelete item={del.finding_id} onConfirm={rm} onCancel={()=>setDel(null)}/>}</div>)}
function CapaView({api,findings,capas,reload}){const[sf,setSf]=useState(false);const[ed,setEd]=useState(null);const[vw,setVw]=useState("list");const[del,setDel]=useState(null);const save=async(d)=>{try{if(ed)await api.update("capa",ed.id,d);else await api.insert("capa",d);setSf(false);setEd(null);reload()}catch(e){alert(e.message)}};const rm=async()=>{if(del){try{await api.remove("capa",del.id)}catch(e){alert(e.message)}setDel(null);reload()}};const kc=["Brouillon","Soumise","Accept√©e","En cours","R√©alis√©e","V√©rifi√©e efficace"];return(<div><div className="filters"><div className="filter-group"><button className={`filter-btn ${vw==="list"?'active':''}`} onClick={()=>setVw("list")}>Liste</button><button className={`filter-btn ${vw==="kanban"?'active':''}`} onClick={()=>setVw("kanban")}>Kanban</button></div><div className="spacer"/><button className="btn btn-green" onClick={()=>{setEd(null);setSf(true)}}>+ Action</button></div>{vw==="kanban"?(<div className="kanban">{kc.map(col=>(<div key={col} className="kanban-col"><div className="kanban-title" style={{color:SC[col]||'var(--muted)'}}>{col} ({capas.filter(c=>c.statut===col).length})</div>{capas.filter(c=>c.statut===col).map(c=>{const fi=findings.find(f=>f.id===c.finding_uuid);return(<div key={c.id} className="kanban-card" onClick={()=>{setEd(c);setSf(true)}}><div className="mono" style={{fontSize:10,color:'var(--dim)'}}>{c.action_id}</div><div style={{fontSize:12,fontWeight:500,marginTop:4}}>{fi?.titre||"‚Äî"}</div><div style={{marginTop:8,display:'flex',justifyContent:'space-between'}}><span style={{fontSize:11,color:'var(--muted)'}}>{c.responsable||"‚Äî"}</span><span className="mono" style={{fontSize:11,color:'var(--accent)',fontWeight:700}}>{c.avancement}%</span></div></div>)})}</div>))}</div>):(<React.Fragment><div className="table-container desktop-only">{capas.map(c=>{const fi=findings.find(f=>f.id===c.finding_uuid);return(<div key={c.id} className="table-row" style={{gridTemplateColumns:'110px 1fr 90px 100px 50px 36px'}} onClick={()=>{setEd(c);setSf(true)}}><span className="mono" style={{fontSize:10,color:'var(--dim)'}}>{c.action_id}</span><div><div style={{fontSize:13,fontWeight:500}}>{c.action_corrective?.slice(0,55)||"‚Äî"}</div><div style={{fontSize:11,color:'var(--dim)'}}>{fi?.finding_id} ‚Äî {fi?.titre?.slice(0,35)||"‚Äî"}</div></div><span style={{fontSize:11,color:'var(--muted)'}}>{c.responsable||"‚Äî"}</span><Tag label={c.statut}/><span className="mono" style={{fontSize:12,color:'var(--accent)'}}>{c.avancement}%</span><button className="btn-icon" onClick={e=>{e.stopPropagation();setDel(c)}}>üóë</button></div>)})}{capas.length===0&&<Empty text="Aucune action"/>}</div><div className="mobile-only">{capas.map(c=><MC_Capa key={c.id} c={c} findings={findings} onClick={()=>{setEd(c);setSf(true)}} onDel={()=>setDel(c)}/>)}{capas.length===0&&<Empty text="Aucune action"/>}</div></React.Fragment>)}<FAB onClick={()=>{setEd(null);setSf(true)}} color="var(--green)"/>{sf&&<CapaForm capa={ed} findings={findings} onClose={()=>{setSf(false);setEd(null)}} onSave={save}/>}{del&&<ConfirmDelete item={del.action_id} onConfirm={rm} onCancel={()=>setDel(null)}/>}</div>)}
function PreuvesView({api,findings,capas,preuves,reload}){const[sf,setSf]=useState(false);const[ed,setEd]=useState(null);const[fil,setFil]=useState("Tous");const[del,setDel]=useState(null);const fl=preuves.filter(p=>fil==="Tous"||p.statut===fil);const save=async(d)=>{try{if(ed)await api.update("preuves",ed.id,d);else await api.insert("preuves",d);setSf(false);setEd(null);reload()}catch(e){alert(e.message)}};const rm=async()=>{if(del){try{await api.remove("preuves",del.id)}catch(e){alert(e.message)}setDel(null);reload()}};return(<div><div className="filters"><div className="filter-group">{["Tous",...STATUTS_PREUVE].map(s=>(<button key={s} className={`filter-btn ${fil===s?'active':''}`} onClick={()=>setFil(s)}>{s}</button>))}</div><div className="spacer"/><button className="btn btn-purple" onClick={()=>{setEd(null);setSf(true)}}>+ Preuve</button></div><div className="table-container desktop-only">{fl.map(p=>{const fi=findings.find(f=>f.id===p.finding_uuid);return(<div key={p.id} className="table-row" style={{gridTemplateColumns:'130px 1fr 90px 60px 75px 75px 36px'}} onClick={()=>{setEd(p);setSf(true)}}><span className="mono" style={{fontSize:10,color:'var(--dim)'}}>{p.evidence_id}</span><div style={{fontSize:12}}>{fi?.finding_id||"‚Äî"} ‚Äî {fi?.titre?.slice(0,40)||"‚Äî"}</div><Badge color="#22D3EE">{p.type_preuve}</Badge><span className="mono" style={{fontSize:10,color:'var(--dim)'}}>{p.version}</span><Tag label={p.statut}/><span style={{fontSize:11,color:'var(--dim)'}}>{p.date_preuve||"‚Äî"}</span><button className="btn-icon" onClick={e=>{e.stopPropagation();setDel(p)}}>üóë</button></div>)})}{fl.length===0&&<Empty text="Aucune preuve"/>}</div><div className="mobile-only">{fl.map(p=><MC_Preuve key={p.id} p={p} findings={findings} onClick={()=>{setEd(p);setSf(true)}} onDel={()=>setDel(p)}/>)}{fl.length===0&&<Empty text="Aucune preuve"/>}</div><FAB onClick={()=>{setEd(null);setSf(true)}} color="var(--purple)"/>{sf&&<PreuveForm preuve={ed} findings={findings} capas={capas} onClose={()=>{setSf(false);setEd(null)}} onSave={save}/>}{del&&<ConfirmDelete item={del.evidence_id} onConfirm={rm} onCancel={()=>setDel(null)}/>}</div>)}

// ============================================================
// TABLE VIEWS - AGREMENTS
// ============================================================
function AgrementsView({api,audits,agrements,renouvellements,reload}){
  const[sf,setSf]=useState(false);const[ed,setEd]=useState(null);const[fil,setFil]=useState("Tous");const[del,setDel]=useState(null);const[renouv,setRenouv]=useState(null);const[showRenouv,setShowRenouv]=useState(false);
  const fl=agrements.filter(a=>fil==="Tous"||a.statut===fil||(fil==="Expire bient√¥t"&&a.statut==="Actif"&&daysUntil(a.date_expiration)!==null&&daysUntil(a.date_expiration)>=0&&daysUntil(a.date_expiration)<=90));
  const save=async(d)=>{try{if(ed)await api.update("agrements",ed.id,d);else await api.insert("agrements",d);setSf(false);setEd(null);reload()}catch(e){alert(e.message)}};
  const rm=async()=>{if(del){try{await api.remove("agrements",del.id)}catch(e){alert(e.message)}setDel(null);reload()}};
  const saveRenouv=async(d)=>{try{await api.insert("renouvellements",d);if(d.nouvelle_expiration&&renouv){await api.update("agrements",renouv,{date_expiration:d.nouvelle_expiration})}setShowRenouv(false);setRenouv(null);reload()}catch(e){alert(e.message)}};
  return(<div>
    <div className="filters"><div className="filter-group">{["Tous",...STATUTS_AGREMENT,"Expire bient√¥t"].map(s=>(<button key={s} className={`filter-btn ${fil===s?'active':''}`} onClick={()=>setFil(s)}>{s}</button>))}</div><div className="spacer"/><button className="btn btn-teal" onClick={()=>{setEd(null);setSf(true)}}>+ Agr√©ment</button></div>
    <div className="table-container desktop-only">{fl.map(a=>{const rn=renouvellements.filter(r=>r.agrement_uuid===a.id);return(<div key={a.id} className="table-row" style={{gridTemplateColumns:'100px 1fr 65px 70px 85px 100px 65px 36px'}} onClick={()=>{setEd(a);setSf(true)}}>
      <span className="mono" style={{fontSize:10,color:'var(--dim)'}}>{a.agrement_id}</span>
      <div><div style={{fontSize:13,fontWeight:600}}>{a.entite}</div><div style={{fontSize:11,color:'var(--dim)'}}>{a.numero_agrement||"‚Äî"}</div></div>
      <Badge color="#14B8A6">{a.type_agrement}</Badge>
      <Badge color="#A78BFA">{a.domaine}</Badge>
      <Tag label={a.statut}/>
      <ExpiryBadge date={a.date_expiration}/>
      <button className="btn-outline btn-sm" onClick={e=>{e.stopPropagation();setRenouv(a.id);setShowRenouv(true)}} style={{fontSize:10,padding:'3px 8px'}}>üîÑ {rn.length}</button>
      <button className="btn-icon" onClick={e=>{e.stopPropagation();setDel(a)}}>üóë</button>
    </div>)})}{fl.length===0&&<Empty text="Aucun agr√©ment"/>}</div>
    <div className="mobile-only">{fl.map(a=><MC_Agrement key={a.id} a={a} onClick={()=>{setEd(a);setSf(true)}} onDel={()=>setDel(a)}/>)}{fl.length===0&&<Empty text="Aucun agr√©ment"/>}</div>
    <FAB onClick={()=>{setEd(null);setSf(true)}} color="var(--teal)"/>
    {sf&&<AgrementForm agrement={ed} audits={audits} onClose={()=>{setSf(false);setEd(null)}} onSave={save}/>}
    {del&&<ConfirmDelete item={del.agrement_id} onConfirm={rm} onCancel={()=>setDel(null)}/>}
    {showRenouv&&<RenouvForm agrementId={renouv} onClose={()=>{setShowRenouv(false);setRenouv(null)}} onSave={saveRenouv}/>}
  </div>)
}

// ============================================================
// TABLE VIEWS - AUTORISATIONS
// ============================================================
function AutorisationsView({api,agrements,autorisations,reload}){
  const[sf,setSf]=useState(false);const[ed,setEd]=useState(null);const[fil,setFil]=useState("Tous");const[del,setDel]=useState(null);
  const fl=autorisations.filter(a=>fil==="Tous"||a.statut===fil);
  const save=async(d)=>{try{if(ed)await api.update("autorisations",ed.id,d);else await api.insert("autorisations",d);setSf(false);setEd(null);reload()}catch(e){alert(e.message)}};
  const rm=async()=>{if(del){try{await api.remove("autorisations",del.id)}catch(e){alert(e.message)}setDel(null);reload()}};
  return(<div>
    <div className="filters"><div className="filter-group">{["Tous",...STATUTS_AUTORISATION].map(s=>(<button key={s} className={`filter-btn ${fil===s?'active':''}`} onClick={()=>setFil(s)}>{s}</button>))}</div><div className="spacer"/><button className="btn btn-pink" onClick={()=>{setEd(null);setSf(true)}}>+ Autorisation</button></div>
    <div className="table-container desktop-only">{fl.map(a=>{const ag=agrements.find(g=>g.id===a.agrement_uuid);return(<div key={a.id} className="table-row" style={{gridTemplateColumns:'110px 1fr 120px 100px 95px 90px 36px'}} onClick={()=>{setEd(a);setSf(true)}}>
      <span className="mono" style={{fontSize:10,color:'var(--dim)'}}>{a.autorisation_id}</span>
      <div><div style={{fontSize:13,fontWeight:600}}>{a.beneficiaire}</div><div style={{fontSize:11,color:'var(--dim)'}}>{ag?.entite||"‚Äî"} ‚Ä¢ {a.reference_regl||"‚Äî"}</div></div>
      <Badge color="#EC4899">{a.type_autorisation}</Badge>
      <Tag label={a.statut}/>
      <ExpiryBadge date={a.date_expiration}/>
      <span style={{fontSize:11,color:'var(--dim)'}}>{a.date_delivrance||"‚Äî"}</span>
      <button className="btn-icon" onClick={e=>{e.stopPropagation();setDel(a)}}>üóë</button>
    </div>)})}{fl.length===0&&<Empty text="Aucune autorisation"/>}</div>
    <div className="mobile-only">{fl.map(a=><MC_Autorisation key={a.id} a={a} agrements={agrements} onClick={()=>{setEd(a);setSf(true)}} onDel={()=>setDel(a)}/>)}{fl.length===0&&<Empty text="Aucune autorisation"/>}</div>
    <FAB onClick={()=>{setEd(null);setSf(true)}} color="var(--pink)"/>
    {sf&&<AutorisationForm autorisation={ed} agrements={agrements} onClose={()=>{setSf(false);setEd(null)}} onSave={save}/>}
    {del&&<ConfirmDelete item={del.autorisation_id} onConfirm={rm} onCancel={()=>setDel(null)}/>}
  </div>)
}

// ============================================================
// MAIN APP
// ============================================================
function App(){
  const[user,setUser]=useState(null);const[token,setToken]=useState(null);const[api,setApi]=useState(null);const[tab,setTab]=useState("dashboard");
  const[audits,setAudits]=useState([]);const[findings,setFindings]=useState([]);const[capas,setCapas]=useState([]);const[preuves,setPreuves]=useState([]);
  const[agrements,setAgrements]=useState([]);const[autorisations,setAutorisations]=useState([]);const[renouvellements,setRenouvellements]=useState([]);
  const[loading,setLoading]=useState(false);const[error,setError]=useState("");const[cs,setCs]=useState(true);

  const loadAll=useCallback(async(ar)=>{const a=ar||api;if(!a)return;setLoading(true);setError("");try{const[au,fi,ca,pr,ag,at,rn]=await Promise.all([a.select("audits","order=created_at.desc"),a.select("findings","order=created_at.desc"),a.select("capa","order=created_at.desc"),a.select("preuves","order=created_at.desc"),a.select("agrements","order=created_at.desc"),a.select("autorisations","order=created_at.desc"),a.select("renouvellements","order=date_renouvellement.desc")]);setAudits(au);setFindings(fi);setCapas(ca);setPreuves(pr);setAgrements(ag);setAutorisations(at);setRenouvellements(rn)}catch(e){setError("Erreur: "+e.message)}setLoading(false)},[api]);

  const handleLogin=(t,u)=>{const a=createApi(t);setToken(t);setUser(u);setApi(a);loadAll(a)};
  const handleLogout=async()=>{try{if(token)await authApi.logout(token)}catch(e){}localStorage.removeItem("sb_token");localStorage.removeItem("sb_user_email");setUser(null);setToken(null);setApi(null)};

  useEffect(()=>{const t=localStorage.getItem("sb_token");if(t){authApi.getUser(t).then(u=>{const a=createApi(t);setToken(t);setUser(u);setApi(a);loadAll(a);setCs(false)}).catch(()=>{localStorage.removeItem("sb_token");setCs(false)})}else setCs(false)},[]);

  if(cs)return(<div style={{minHeight:'100vh',display:'flex',alignItems:'center',justifyContent:'center',background:'var(--bg)'}}><div style={{textAlign:'center'}}><div style={{fontSize:48,marginBottom:12}}>‚úàÔ∏è</div><div style={{color:'var(--muted)',fontSize:14}}>Chargement...</div></div></div>);
  if(!user)return <LoginScreen onLogin={handleLogin}/>;

  const tabs=[
    {id:"dashboard",label:"Accueil",icon:"üìä",ml:"Accueil"},
    {id:"audits",label:"Audits",icon:"üìã",ml:"Audits",count:audits.filter(a=>a.statut!=="Cl√¥tur√©").length},
    {id:"findings",label:"√âcarts",icon:"‚ö†Ô∏è",ml:"√âcarts",count:findings.filter(f=>f.statut!=="Cl√¥tur√©").length},
    {id:"capa",label:"CAPA",icon:"üîß",ml:"CAPA",count:capas.filter(c=>!["V√©rifi√©e efficace","Rejet√©e"].includes(c.statut)).length},
    {id:"preuves",label:"Preuves",icon:"üìé",ml:"Preuves",count:preuves.filter(p=>p.statut==="Soumise").length},
    {id:"agrements",label:"Agr√©ments",icon:"üèõÔ∏è",ml:"Agr√©m.",count:agrements.filter(a=>{const d=daysUntil(a.date_expiration);return a.statut==="Actif"&&d!==null&&d>=0&&d<=90}).length},
    {id:"autorisations",label:"Autorisations",icon:"üìÑ",ml:"Autoris.",count:autorisations.filter(a=>a.statut==="Accord√©e").length},
  ];

  return(<div>
    <header className="header">
      <div className="header-left"><div className="logo">‚úà</div><div><div className="header-title">DGAC ‚Äî Plateforme de Surveillance</div><div className="header-sub">Direction G√©n√©rale de l'Aviation Civile</div></div></div>
      <div className="desktop-tabs">{tabs.map(t=>(<button key={t.id} className={`tab-btn ${tab===t.id?'active':''}`} onClick={()=>setTab(t.id)}><span>{t.icon}</span> {t.label}{t.count>0&&<span className="tab-count">{t.count}</span>}</button>))}</div>
      <div className="header-right"><div className="user-badge"><div className="user-dot"/>{user.email}</div><button className="btn-outline btn-sm" onClick={()=>loadAll()}>{loading?"‚è≥":"üîÑ"}</button><button className="btn-outline btn-outline-red btn-sm" onClick={handleLogout}>D√©connexion</button></div>
    </header>
    <nav className="mobile-nav">{tabs.map(t=>(<button key={t.id} className={`mobile-nav-btn ${tab===t.id?'active':''}`} onClick={()=>setTab(t.id)}><span className="nav-icon">{t.icon}</span>{t.ml}{t.count>0&&tab!==t.id&&<span className="nav-badge">{t.count}</span>}</button>))}<button className="mobile-nav-btn" onClick={handleLogout}><span className="nav-icon">üö™</span>Sortir</button></nav>
    {error&&<div className="error-box" style={{margin:'12px 16px 0'}}>{error}</div>}
    <main style={{padding:'24px 28px',maxWidth:1360,margin:'0 auto'}}>
      {tab==="dashboard"&&<Dashboard audits={audits} findings={findings} capa={capas} preuves={preuves} agrements={agrements} autorisations={autorisations} onNav={setTab}/>}
      {tab==="audits"&&<AuditsView api={api} audits={audits} findings={findings} reload={()=>loadAll()}/>}
      {tab==="findings"&&<FindingsView api={api} audits={audits} findings={findings} preuves={preuves} reload={()=>loadAll()}/>}
      {tab==="capa"&&<CapaView api={api} findings={findings} capas={capas} reload={()=>loadAll()}/>}
      {tab==="preuves"&&<PreuvesView api={api} findings={findings} capas={capas} preuves={preuves} reload={()=>loadAll()}/>}
      {tab==="agrements"&&<AgrementsView api={api} audits={audits} agrements={agrements} renouvellements={renouvellements} reload={()=>loadAll()}/>}
      {tab==="autorisations"&&<AutorisationsView api={api} agrements={agrements} autorisations={autorisations} reload={()=>loadAll()}/>}
    </main>
  </div>)
}
ReactDOM.createRoot(document.getElementById('app')).render(<App/>);
</script>
<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js').then(r => console.log('SW registered')).catch(e => console.log('SW failed', e));
  });
}
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DGAC — Suivi des Audits</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0B1528">
<link rel="manifest" href="manifest.json">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700;800&family=Source+Sans+3:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
:root{--bg:#0B1528;--card:#12203D;--card-hover:#162847;--border:rgba(189,165,107,0.08);--border-light:rgba(189,165,107,0.15);--text:#E8E4DD;--muted:rgba(232,228,221,0.5);--dim:rgba(232,228,221,0.3);--gold:#BDA56B;--gold-light:#D4C088;--gold-dark:#96833F;--red-tn:#C8102E;--green:#2ECC71;--orange:#F39C12;--cyan:#5DADE2;--purple:#9B59B6;--safe-bottom:env(safe-area-inset-bottom,0px);--tr:all 0.3s cubic-bezier(0.4,0,0.2,1)}
body{background:var(--bg);color:var(--text);font-family:'Source Sans 3',sans-serif;min-height:100vh;overflow-x:hidden;line-height:1.6}
h1,h2,h3,.serif{font-family:'Playfair Display',serif}
.mono{font-family:'JetBrains Mono',monospace}
::selection{background:rgba(189,165,107,0.3)}
::-webkit-scrollbar{width:5px}::-webkit-scrollbar-thumb{background:rgba(189,165,107,0.2);border-radius:4px}
.tn-stripe{height:3px;background:linear-gradient(90deg,var(--red-tn),var(--gold),var(--red-tn));opacity:0.6}
.header{padding:0 28px;height:62px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;background:rgba(11,21,40,0.97);backdrop-filter:blur(16px);position:sticky;top:0;z-index:100}
.header-left{display:flex;align-items:center;gap:12px}
.logo-mark{width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg,var(--gold),var(--gold-dark));display:flex;align-items:center;justify-content:center;flex-shrink:0;box-shadow:0 2px 12px rgba(189,165,107,0.2);font-size:16px}
.header-title{font-family:'Playfair Display',serif;font-size:15px;font-weight:700;color:var(--gold-light)}
.header-sub{font-size:9px;color:var(--muted);letter-spacing:1.5px;text-transform:uppercase}
.desktop-tabs{display:flex;gap:1px;padding:3px;border-radius:10px;background:rgba(189,165,107,0.04);border:1px solid var(--border);flex-wrap:wrap}
.tab-btn{padding:7px 12px;border-radius:7px;border:none;font-size:10px;font-weight:600;cursor:pointer;font-family:inherit;display:flex;align-items:center;gap:5px;background:transparent;color:var(--muted);transition:var(--tr);white-space:nowrap;letter-spacing:0.3px;text-transform:uppercase}
.tab-btn:hover{color:var(--text)}.tab-btn.active{background:rgba(189,165,107,0.12);color:var(--gold)}
.tab-count{font-size:8px;font-weight:700;font-family:'JetBrains Mono',monospace;padding:2px 5px;border-radius:6px;background:rgba(189,165,107,0.15);color:var(--gold)}
.tab-alert{font-size:8px;font-weight:700;font-family:'JetBrains Mono',monospace;padding:2px 5px;border-radius:6px;background:rgba(200,16,46,0.2);color:var(--red-tn)}
.mobile-nav{display:none;position:fixed;bottom:0;left:0;right:0;background:rgba(11,21,40,0.98);backdrop-filter:blur(16px);border-top:1px solid var(--border);padding:4px 2px;padding-bottom:calc(4px + var(--safe-bottom));z-index:100;justify-content:space-around}
.mobile-nav-btn{display:flex;flex-direction:column;align-items:center;gap:1px;background:none;border:none;color:var(--muted);font-size:8px;font-family:inherit;font-weight:600;cursor:pointer;padding:4px 2px;border-radius:8px;min-width:38px;position:relative;transition:var(--tr)}
.mobile-nav-btn.active{color:var(--gold)}.mobile-nav-btn .nav-icon{font-size:16px}
.mobile-nav-btn .nav-badge{position:absolute;top:-2px;right:-2px;font-size:7px;font-weight:700;background:var(--red-tn);color:#fff;padding:1px 3px;border-radius:6px}
.btn{padding:9px 18px;border:none;border-radius:8px;font-size:12px;font-weight:600;cursor:pointer;font-family:inherit;transition:var(--tr);letter-spacing:0.4px;text-transform:uppercase}
.btn:hover{transform:translateY(-1px);box-shadow:0 4px 16px rgba(0,0,0,0.2)}.btn:active{transform:scale(0.97)}.btn:disabled{opacity:0.4;cursor:not-allowed;transform:none}
.btn-gold{background:linear-gradient(135deg,var(--gold),var(--gold-dark));color:#0B1528}
.btn-red{background:var(--red-tn);color:#fff}.btn-green{background:var(--green);color:#fff}.btn-purple{background:var(--purple);color:#fff}.btn-orange{background:var(--orange);color:#fff}.btn-cyan{background:var(--cyan);color:#fff}
.btn-outline{padding:8px 16px;background:transparent;border:1px solid rgba(189,165,107,0.25);border-radius:8px;font-size:11px;font-weight:600;cursor:pointer;font-family:inherit;color:var(--gold);transition:var(--tr)}
.btn-outline:hover{border-color:var(--gold)}.btn-outline-red{border-color:rgba(200,16,46,0.3);color:var(--red-tn)}
.btn-sm{padding:5px 12px;font-size:10px}.btn-full{width:100%;padding:14px 0}
.btn-icon{background:none;border:none;color:var(--dim);cursor:pointer;padding:6px;transition:var(--tr);border-radius:6px}.btn-icon:hover{color:var(--gold)}
.btn-fab{position:fixed;bottom:76px;right:16px;width:50px;height:50px;border-radius:50%;border:none;font-size:20px;cursor:pointer;box-shadow:0 4px 24px rgba(189,165,107,0.25);z-index:90;display:none;align-items:center;justify-content:center;color:#0B1528;background:linear-gradient(135deg,var(--gold),var(--gold-dark))}
.input,.select,.textarea{width:100%;padding:11px 14px;background:rgba(189,165,107,0.04);border:1px solid var(--border-light);border-radius:8px;color:var(--text);font-size:14px;outline:none;font-family:inherit;transition:var(--tr)}
.input:focus,.select:focus,.textarea:focus{border-color:var(--gold);box-shadow:0 0 0 3px rgba(189,165,107,0.08)}.select{cursor:pointer}.textarea{min-height:70px;resize:vertical}
.label{font-size:10px;color:var(--gold);margin-bottom:5px;display:block;font-weight:700;letter-spacing:1.2px;text-transform:uppercase}
.card{background:var(--card);border:1px solid var(--border);border-radius:14px;transition:var(--tr)}.card-padded{padding:20px}
.kpi-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(145px,1fr));gap:12px;margin-bottom:24px}
.kpi{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:18px;position:relative;overflow:hidden;transition:var(--tr)}.kpi:hover{border-color:var(--border-light);transform:translateY(-2px)}
.kpi-bar{position:absolute;top:0;left:0;width:3px;height:100%}
.kpi-label{font-size:9px;text-transform:uppercase;letter-spacing:1.5px;color:var(--muted);font-weight:700}
.kpi-value{font-size:26px;font-weight:700;margin-top:5px;font-family:'Playfair Display',serif}.kpi-sub{font-size:11px;color:var(--dim);margin-top:3px}
.badge{display:inline-flex;align-items:center;padding:3px 10px;border-radius:20px;font-size:10px;font-weight:600;white-space:nowrap}
.table-container{background:var(--card);border:1px solid var(--border);border-radius:14px;overflow:hidden}
.table-row{display:grid;padding:12px 18px;border-bottom:1px solid var(--border);align-items:center;cursor:pointer;transition:var(--tr)}.table-row:hover{background:var(--card-hover)}.table-row:last-child{border-bottom:none}
.mobile-card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px;margin-bottom:10px;cursor:pointer;transition:var(--tr)}.mobile-card:hover{border-color:var(--border-light)}
.mobile-card-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:6px}
.mobile-card-title{font-size:14px;font-weight:600}.mobile-card-id{font-size:10px;color:var(--dim);margin-top:2px}
.mobile-card-meta{display:flex;gap:6px;flex-wrap:wrap;margin-top:8px}
.mobile-card-footer{display:flex;justify-content:space-between;align-items:center;margin-top:10px;padding-top:10px;border-top:1px solid var(--border)}
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.6);backdrop-filter:blur(8px);display:flex;align-items:center;justify-content:center;z-index:1000;padding:12px;animation:fadeIn 0.2s}
.modal{background:linear-gradient(180deg,#152240,#0F1C33);border:1px solid var(--border-light);border-radius:18px;padding:24px;max-width:94vw;max-height:90vh;overflow-y:auto;width:540px;animation:slideUp 0.3s cubic-bezier(0.4,0,0.2,1)}
.modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding-bottom:14px;border-bottom:1px solid var(--border)}
.modal-title{font-size:18px;font-weight:700;font-family:'Playfair Display',serif;color:var(--gold-light)}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}@keyframes slideUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
.form-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}.form-span{grid-column:1/-1}
.filters{display:flex;gap:10px;margin-bottom:20px;flex-wrap:wrap;align-items:center}
.filter-group{display:flex;gap:2px;background:rgba(189,165,107,0.04);border-radius:9px;padding:3px;border:1px solid var(--border);flex-wrap:wrap}
.filter-btn{padding:6px 12px;border-radius:6px;border:none;font-size:10px;font-weight:600;cursor:pointer;font-family:inherit;background:transparent;color:var(--muted);white-space:nowrap;transition:var(--tr)}.filter-btn.active{background:rgba(189,165,107,0.12);color:var(--gold)}
.spacer{flex:1}.empty{padding:40px 20px;text-align:center;color:var(--dim);font-size:13px;font-style:italic}
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.section-title{font-size:16px;font-weight:700;font-family:'Playfair Display',serif;color:var(--gold-light);margin-bottom:14px;margin-top:28px;padding-bottom:8px;border-bottom:1px solid var(--border)}.section-title:first-child{margin-top:0}
.stat-row{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid var(--border)}.stat-row:last-child{border:none}
.login-page{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px;background:linear-gradient(160deg,#0B1528,#132240,#0B1528)}
.login-box{width:420px;max-width:100%}.login-header{text-align:center;margin-bottom:32px}
.login-title{font-size:24px;font-weight:800;font-family:'Playfair Display',serif;color:var(--gold-light)}
.login-sub{color:var(--muted);font-size:13px;margin-top:8px}
.error-box{padding:10px 14px;background:rgba(200,16,46,0.08);border:1px solid rgba(200,16,46,0.2);border-radius:10px;color:var(--red-tn);font-size:12px;margin-bottom:14px}
.success-box{padding:10px 14px;background:rgba(46,204,113,0.08);border:1px solid rgba(46,204,113,0.2);border-radius:10px;color:var(--green);font-size:12px;margin-bottom:14px}
.user-badge{display:flex;align-items:center;gap:8px;padding:5px 12px;background:rgba(189,165,107,0.06);border:1px solid var(--border);border-radius:8px;font-size:11px;color:var(--muted)}
.user-dot{width:7px;height:7px;border-radius:50%;background:var(--green)}
.stats-table{width:100%;border-collapse:collapse;font-size:11px}
.stats-table th{text-align:left;padding:8px 10px;background:rgba(189,165,107,0.06);color:var(--gold);font-size:9px;text-transform:uppercase;letter-spacing:1px;font-weight:700;border-bottom:1px solid var(--border)}
.stats-table td{padding:8px 10px;border-bottom:1px solid var(--border)}.stats-table tr:hover td{background:rgba(189,165,107,0.02)}
.alert-card{background:rgba(200,16,46,0.06);border:1px solid rgba(200,16,46,0.15);border-radius:12px;padding:14px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center}
.alert-card.warn{background:rgba(243,156,18,0.06);border-color:rgba(243,156,18,0.15)}
.donut-container{display:flex;align-items:center;gap:16px;flex-wrap:wrap}
.donut-legend{display:flex;flex-direction:column;gap:4px}
.donut-legend-item{display:flex;align-items:center;gap:6px;font-size:11px}
.donut-legend-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:2px;margin-top:10px}
.cal-head{text-align:center;font-size:9px;color:var(--gold);font-weight:700;padding:4px;text-transform:uppercase}
.cal-day{text-align:center;padding:6px 2px;font-size:11px;border-radius:6px;color:var(--dim);min-height:32px}
.cal-day.has-event{background:rgba(189,165,107,0.1);color:var(--gold);font-weight:600;cursor:pointer;border:1px solid var(--border-light)}
.cal-day.today{border:1px solid var(--gold);color:var(--gold-light)}
.cal-day.alert{background:rgba(200,16,46,0.1);color:var(--red-tn);font-weight:600}
@media(max-width:768px){
  .header{padding:0 14px;height:54px}.header-title{font-size:13px}.header-sub{display:none}
  .desktop-tabs{display:none!important}.header-right .user-badge{display:none}.header-right .btn-outline:not(.btn-outline-red){display:none}
  .mobile-nav{display:flex!important}.btn-fab{display:flex!important}
  main{padding:14px 12px 90px 12px!important}
  .form-grid{grid-template-columns:1fr}.form-span{grid-column:1}.grid-2{grid-template-columns:1fr}
  .modal{padding:20px 16px;width:100%;max-width:100%;border-radius:16px 16px 0 0;position:fixed;bottom:0;left:0;right:0;max-height:92vh}
  .modal-overlay{align-items:flex-end;padding:0}
  .kpi-grid{grid-template-columns:1fr 1fr;gap:8px}.kpi{padding:12px}.kpi-value{font-size:22px}
  .desktop-only{display:none!important}.mobile-only{display:block!important}
  .input,.select,.textarea{font-size:16px;padding:13px}.btn{padding:11px 18px;font-size:13px}.btn-full{padding:15px 0}
}
@media(min-width:769px){.mobile-only{display:none!important}.mobile-nav{display:none!important}.btn-fab{display:none!important}}
</style>
</head>
<body>
<div class="tn-stripe"></div>
<div id="app"></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
<script type="text/babel">
const{useState,useEffect,useCallback}=React;
const SB_URL="https://apfcujkxcxhfrjbafgaa.supabase.co";
const SB_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFwZmN1amt4Y3hoZnJqYmFmZ2FhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEzMjA0NTksImV4cCI6MjA4Njg5NjQ1OX0.S-29PtjyHn1knDIfdVERhLXCDh_JS0tc3oZqAEqwVQ0";
const ACTIVITES=["ATO","Activite aerienne","Aerodrome a usage restreint"];
const SOUS_TYPES={"ATO":["Centre","FSTD"],"Activite aerienne":["Animation touristique","Epandage aerien"],"Aerodrome a usage restreint":["Piste","Helideck"]};
const STATUTS_AGREMENT=["Actif","Suspendu","Revoque","Expire"];
const STATUTS_AUTORISATION=["Accordee","Refusee","Expiree","Retiree"];
const DOMAINES=["OPS","AIR","AIG","AGA","ANS","PEL"];
const CLASSIFICATIONS=["NC","PC","OBS","OFI"];
const CRITICITES=["Majeure","Significative","Mineure","Observation"];

const authApi={
  async login(e,p){const r=await fetch(SB_URL+"/auth/v1/token?grant_type=password",{method:"POST",headers:{apikey:SB_KEY,"Content-Type":"application/json"},body:JSON.stringify({email:e,password:p})});const d=await r.json();if(!r.ok)throw new Error(d.error_description||d.msg||"Echec");return d},
  async logout(t){await fetch(SB_URL+"/auth/v1/logout",{method:"POST",headers:{apikey:SB_KEY,Authorization:"Bearer "+t,"Content-Type":"application/json"}})},
  async getUser(t){const r=await fetch(SB_URL+"/auth/v1/user",{headers:{apikey:SB_KEY,Authorization:"Bearer "+t}});if(!r.ok)throw new Error("Expire");return r.json()}
};
const createApi=(t)=>{
  const h={apikey:SB_KEY,Authorization:"Bearer "+t,"Content-Type":"application/json",Prefer:"return=representation"};
  const b=SB_URL+"/rest/v1";
  return{
    async select(tb,q){const r=await fetch(b+"/"+tb+"?"+(q||""),{headers:h});if(!r.ok)throw new Error(r.statusText);return r.json()},
    async insert(tb,d){const r=await fetch(b+"/"+tb,{method:"POST",headers:h,body:JSON.stringify(d)});if(!r.ok){const e=await r.json();throw new Error(e.message||r.statusText)}return r.json()},
    async update(tb,id,d){const r=await fetch(b+"/"+tb+"?id=eq."+id,{method:"PATCH",headers:h,body:JSON.stringify(d)});if(!r.ok)throw new Error(r.statusText);return r.json()},
    async remove(tb,id){const r=await fetch(b+"/"+tb+"?id=eq."+id,{method:"DELETE",headers:h});if(!r.ok)throw new Error(r.statusText);return true}
  }
};

const SC={"Planifie":"#BDA56B","En cours":"#F39C12","Termine":"#5DADE2","Cloture":"#2ECC71","Ouvert":"#E74C3C","En traitement":"#F39C12","Cloture":"#2ECC71","NC":"#E74C3C","PC":"#F39C12","OBS":"#5DADE2","OFI":"#9B59B6","Actif":"#2ECC71","Suspendu":"#F39C12","Revoque":"#E74C3C","Expire":"rgba(232,228,221,0.3)","Accordee":"#2ECC71","Refusee":"#E74C3C","Expiree":"rgba(232,228,221,0.3)","Retiree":"#E74C3C"};

function Badge({children,color}){return <span className="badge" style={{background:(color||"#888")+"18",color:color||"#888"}}>{children}</span>}
function Tag({label}){return <Badge color={SC[label]}>{label}</Badge>}
function Empty({text}){return <div className="empty">{text}</div>}
function KPI({label,value,sub,color}){return(<div className="kpi"><div className="kpi-bar" style={{background:color}}/><div className="kpi-label">{label}</div><div className="kpi-value mono" style={{color:color}}>{value}</div>{sub&&<div className="kpi-sub">{sub}</div>}</div>)}
function Modal({onClose,title,width,children}){return(<div className="modal-overlay" onClick={onClose}><div className="modal" style={{width:width||540}} onClick={e=>e.stopPropagation()}><div className="modal-header"><h3 className="modal-title">{title}</h3><button className="btn-icon" onClick={onClose} style={{fontSize:18}}>&#10005;</button></div>{children}</div></div>)}
function Field({label,span,children}){return <div className={span?"form-span":""}><label className="label">{label}</label>{children}</div>}
function Sel({value,onChange,options}){return <select className="select" value={value} onChange={e=>onChange(e.target.value)}>{options.map(o=><option key={o} value={o}>{o}</option>)}</select>}
function ConfirmDelete({item,onConfirm,onCancel}){return(<Modal onClose={onCancel} title="Confirmer la suppression" width={400}><p style={{color:"var(--muted)",fontSize:13,marginBottom:18}}>Supprimer <strong style={{color:"var(--red-tn)"}}>{item}</strong> ?</p><div style={{display:"flex",gap:10,justifyContent:"flex-end"}}><button className="btn btn-outline" onClick={onCancel}>Annuler</button><button className="btn btn-red" onClick={onConfirm}>Supprimer</button></div></Modal>)}
function FAB({onClick}){return <button className="btn-fab" onClick={onClick}>+</button>}

function Donut({data,size}){
  const s=size||80;const r=s/2;const sw=8;const ir=r-sw;
  let total=data.reduce((a,d)=>a+d.value,0);if(total===0)total=1;
  let cum=0;
  const arcs=data.filter(d=>d.value>0).map(d=>{const pct=d.value/total;const start=cum*2*Math.PI-Math.PI/2;cum+=pct;const end=cum*2*Math.PI-Math.PI/2;const large=pct>0.5?1:0;const x1=r+ir*Math.cos(start);const y1=r+ir*Math.sin(start);const x2=r+ir*Math.cos(end);const y2=r+ir*Math.sin(end);const ox1=r+(r)*Math.cos(start);const oy1=r+(r)*Math.sin(start);const ox2=r+(r)*Math.cos(end);const oy2=r+(r)*Math.sin(end);return{...d,path:`M${ox1} ${oy1} A${r} ${r} 0 ${large} 1 ${ox2} ${oy2} L${x2} ${y2} A${ir} ${ir} 0 ${large} 0 ${x1} ${y1}Z`}});
  return(<svg width={s} height={s} viewBox={"0 0 "+s+" "+s}>{arcs.map((a,i)=><path key={i} d={a.path} fill={a.color} opacity="0.85"/>)}<text x={r} y={r+1} textAnchor="middle" dominantBaseline="middle" fill="var(--text)" fontSize="14" fontWeight="700" fontFamily="'Playfair Display',serif">{data.reduce((a,d)=>a+d.value,0)}</text></svg>)
}

function daysUntil(dateStr){if(!dateStr)return Infinity;const d=new Date(dateStr);const now=new Date();now.setHours(0,0,0,0);d.setHours(0,0,0,0);return Math.ceil((d-now)/(1000*60*60*24))}

/* ===== LOGIN ===== */
function LoginScreen({onLogin}){
  const[email,setEmail]=useState("");const[pw,setPw]=useState("");const[ld,setLd]=useState(false);const[err,setErr]=useState("");
  const go=async()=>{if(!email||!pw){setErr("Remplissez les deux champs");return}setLd(true);setErr("");try{const d=await authApi.login(email,pw);localStorage.setItem("audit_token",d.access_token);onLogin(d.access_token,d.user)}catch(e){setErr(e.message==="Invalid login credentials"?"Email ou mot de passe incorrect":e.message)}setLd(false)};
  return(<div className="login-page"><div className="login-box"><div className="login-header"><div style={{width:60,height:60,borderRadius:14,background:"linear-gradient(135deg,var(--gold),var(--gold-dark))",display:"flex",alignItems:"center",justifyContent:"center",margin:"0 auto 16px",fontSize:26,boxShadow:"0 4px 24px rgba(189,165,107,0.3)"}}>&#9992;</div><h1 className="login-title">Suivi des Audits</h1><p className="login-sub">Direction Generale de l'Aviation Civile — Tunisie</p></div><div className="card card-padded"><div style={{marginBottom:16}}><label className="label">Email</label><input className="input" type="email" value={email} onChange={e=>setEmail(e.target.value)} placeholder="email@dgac.tn" onKeyDown={e=>e.key==="Enter"&&go()}/></div><div style={{marginBottom:16}}><label className="label">Mot de passe</label><input className="input" type="password" value={pw} onChange={e=>setPw(e.target.value)} placeholder="••••••••" onKeyDown={e=>e.key==="Enter"&&go()}/></div>{err&&<div className="error-box">{err}</div>}<button className="btn btn-gold btn-full" onClick={go} disabled={ld}>{ld?"Connexion...":"Se connecter"}</button></div></div></div>)
}

/* ===== PDF EXPORTS ===== */
function exportAuditPDF(audit,findings,capas,preuves){
  const{jsPDF}=window.jspdf;const doc=new jsPDF();
  doc.setFontSize(14);doc.text("DGAC — Rapport d'Audit",14,18);
  doc.setFontSize(10);doc.text("Republique Tunisienne — Direction Generale de l'Aviation Civile",14,26);
  doc.setLineWidth(0.5);doc.line(14,30,196,30);
  doc.setFontSize(11);doc.text("Ref: "+(audit.audit_id||""),14,40);doc.text("Entite: "+(audit.entite||""),14,47);doc.text("Domaine: "+(audit.domaine||""),100,40);doc.text("Statut: "+(audit.statut||""),100,47);doc.text("Date debut: "+(audit.date_debut||""),14,54);doc.text("Date fin: "+(audit.date_fin||""),100,54);doc.text("Responsable: "+(audit.responsable||""),14,61);
  if(audit.objectif){doc.text("Objectif: "+audit.objectif.slice(0,90),14,68)}
  const af=findings.filter(f=>f.audit_uuid===audit.id);
  if(af.length>0){doc.autoTable({startY:78,head:[["Ref","Classification","Criticite","Statut","Description"]],body:af.map(f=>[f.finding_id||"",f.classification||"",f.criticite||"",f.statut||"",(f.description||"").slice(0,50)]),styles:{fontSize:8},headStyles:{fillColor:[18,32,61]}})}
  const ac=capas.filter(c=>af.some(f=>f.id===c.finding_uuid));
  if(ac.length>0){const y=doc.lastAutoTable?doc.lastAutoTable.finalY+10:90;doc.setFontSize(11);doc.text("Actions correctives (CAPA):",14,y);doc.autoTable({startY:y+6,head:[["Ref","Description","Responsable","Echeance","Statut"]],body:ac.map(c=>[c.capa_id||"",(c.description||"").slice(0,40),c.responsable||"",c.echeance||"",c.statut||""]),styles:{fontSize:8},headStyles:{fillColor:[18,32,61]}})}
  doc.save("Audit_"+(audit.audit_id||"rapport")+".pdf")
}
function exportAgrementsPDF(agrements){
  const{jsPDF}=window.jspdf;const doc=new jsPDF("l");
  doc.setFontSize(14);doc.text("DGAC — Liste des Agrements",14,18);
  doc.setFontSize(10);doc.text("Date: "+new Date().toLocaleDateString("fr"),14,26);
  doc.autoTable({startY:34,head:[["Entite","Activite","Type","Numero","Delivrance","Expiration","Statut"]],body:agrements.map(a=>[a.entite||"",a.activite||"",a.type_agrement||"",a.numero||"",a.date_delivrance||"",a.date_expiration||"",a.statut||""]),styles:{fontSize:8},headStyles:{fillColor:[18,32,61]}});
  doc.save("Agrements_"+new Date().toISOString().slice(0,10)+".pdf")
}
function exportAgrementFiche(agr,auts){
  const{jsPDF}=window.jspdf;const doc=new jsPDF();
  doc.setFontSize(14);doc.text("DGAC — Fiche Agrement",14,18);
  doc.setFontSize(11);doc.text("Entite: "+(agr.entite||""),14,34);doc.text("Activite: "+(agr.activite||""),14,41);doc.text("Type: "+(agr.type_agrement||""),14,48);doc.text("Numero: "+(agr.numero||""),100,34);doc.text("Statut: "+(agr.statut||""),100,41);doc.text("Delivrance: "+(agr.date_delivrance||""),14,55);doc.text("Expiration: "+(agr.date_expiration||""),100,55);
  if(agr.observations){doc.text("Observations: "+(agr.observations||"").slice(0,80),14,62)}
  const linked=auts.filter(a=>a.agrement_uuid===agr.id);
  if(linked.length>0){doc.autoTable({startY:72,head:[["Type","Beneficiaire","Validite","Statut"]],body:linked.map(a=>[a.type_autorisation||"",a.beneficiaire||"",a.date_validite||"",a.statut||""]),styles:{fontSize:9},headStyles:{fillColor:[18,32,61]}})}
  doc.save("Agrement_"+(agr.numero||"fiche")+".pdf")
}
function exportCAPARetardPDF(capas,findings){
  const{jsPDF}=window.jspdf;const doc=new jsPDF("l");
  doc.setFontSize(14);doc.text("DGAC — CAPA en retard",14,18);
  doc.setFontSize(10);doc.text("Date: "+new Date().toLocaleDateString("fr"),14,26);
  const retard=capas.filter(c=>c.echeance&&new Date(c.echeance)<new Date()&&c.statut!=="Verifiee"&&c.statut!=="Cloturee");
  doc.autoTable({startY:34,head:[["Ref CAPA","Ecart","Description","Responsable","Echeance","Retard (j)","Statut"]],body:retard.map(c=>{const f=findings.find(x=>x.id===c.finding_uuid);const jours=Math.ceil((new Date()-new Date(c.echeance))/(1000*60*60*24));return[c.capa_id||"",f?f.finding_id:"",( c.description||"").slice(0,35),c.responsable||"",c.echeance||"",jours,c.statut||""]}),styles:{fontSize:8},headStyles:{fillColor:[18,32,61]}});
  doc.save("CAPA_retard_"+new Date().toISOString().slice(0,10)+".pdf")
}

/* ===== DASHBOARD ===== */
function Dashboard({audits,findings,capas,preuves,agrements,autorisations,onNav}){
  const expSoon=agrements.filter(a=>a.statut==="Actif"&&daysUntil(a.date_expiration)<=30&&daysUntil(a.date_expiration)>=0);
  const expired=agrements.filter(a=>a.statut==="Actif"&&daysUntil(a.date_expiration)<0);
  const capaRetard=capas.filter(c=>c.echeance&&new Date(c.echeance)<new Date()&&c.statut!=="Verifiee"&&c.statut!=="Cloturee");
  const totalAlerts=expSoon.length+expired.length+capaRetard.length;
  const fOuvert=findings.filter(f=>f.statut==="Ouvert").length;const fClos=findings.filter(f=>f.statut==="Cloture").length;
  const tauxClot=findings.length>0?Math.round((fClos/findings.length)*100):0;
  const donutAudit=[{label:"Planifie",value:audits.filter(a=>a.statut==="Planifie").length,color:"#BDA56B"},{label:"En cours",value:audits.filter(a=>a.statut==="En cours").length,color:"#F39C12"},{label:"Termine",value:audits.filter(a=>a.statut==="Termine").length,color:"#5DADE2"},{label:"Cloture",value:audits.filter(a=>a.statut==="Cloture").length,color:"#2ECC71"}];
  const donutFind=[{label:"NC",value:findings.filter(f=>f.classification==="NC").length,color:"#E74C3C"},{label:"PC",value:findings.filter(f=>f.classification==="PC").length,color:"#F39C12"},{label:"OBS",value:findings.filter(f=>f.classification==="OBS").length,color:"#5DADE2"},{label:"OFI",value:findings.filter(f=>f.classification==="OFI").length,color:"#9B59B6"}];
  return(<div>
    {totalAlerts>0&&(<div className="card card-padded" style={{marginBottom:20,borderColor:"rgba(200,16,46,0.2)",background:"rgba(200,16,46,0.03)"}}>
      <div className="section-title" style={{marginTop:0,color:"var(--red-tn)"}}>Alertes ({totalAlerts})</div>
      {expired.map(a=><div key={a.id} className="alert-card"><div><div style={{fontSize:13,fontWeight:600}}>{a.entite} — {a.type_agrement}</div><div style={{fontSize:11,color:"var(--red-tn)"}}>EXPIRE depuis {Math.abs(daysUntil(a.date_expiration))} jours</div></div><Tag label="Expire"/></div>)}
      {expSoon.map(a=><div key={a.id} className="alert-card warn"><div><div style={{fontSize:13,fontWeight:600}}>{a.entite} — {a.type_agrement}</div><div style={{fontSize:11,color:"var(--orange)"}}>Expire dans {daysUntil(a.date_expiration)} jours ({a.date_expiration})</div></div><Tag label="Actif"/></div>)}
      {capaRetard.slice(0,5).map(c=><div key={c.id} className="alert-card"><div><div style={{fontSize:13,fontWeight:600}}>CAPA {c.capa_id}</div><div style={{fontSize:11,color:"var(--red-tn)"}}>Echeance depassee: {c.echeance}</div></div><Tag label={c.statut}/></div>)}
    </div>)}
    <div className="kpi-grid">
      <KPI label="Audits" value={audits.length} sub={audits.filter(a=>a.statut==="En cours").length+" en cours"} color="var(--gold)"/>
      <KPI label="Ecarts" value={findings.length} sub={fOuvert+" ouverts"} color="var(--cyan)"/>
      <KPI label="Taux cloture" value={tauxClot+"%"} color={tauxClot>=70?"var(--green)":"var(--orange)"}/>
      <KPI label="Agrements" value={agrements.length} sub={agrements.filter(a=>a.statut==="Actif").length+" actifs"} color="var(--green)"/>
      <KPI label="CAPA retard" value={capaRetard.length} color={capaRetard.length>0?"var(--red-tn)":"var(--green)"}/>
    </div>
    <div className="grid-2">
      <div className="card card-padded"><div className="section-title" style={{marginTop:0}}>Audits par statut</div><div className="donut-container"><Donut data={donutAudit}/><div className="donut-legend">{donutAudit.map(d=><div key={d.label} className="donut-legend-item"><div className="donut-legend-dot" style={{background:d.color}}/>{d.label}: <strong>{d.value}</strong></div>)}</div></div></div>
      <div className="card card-padded"><div className="section-title" style={{marginTop:0}}>Ecarts par classification</div><div className="donut-container"><Donut data={donutFind}/><div className="donut-legend">{donutFind.map(d=><div key={d.label} className="donut-legend-item"><div className="donut-legend-dot" style={{background:d.color}}/>{d.label}: <strong>{d.value}</strong></div>)}</div></div></div>
    </div>
    <div className="grid-2" style={{marginTop:16}}>
      <div className="card card-padded"><div className="section-title" style={{marginTop:0}}>Ecarts par domaine</div>{DOMAINES.map(d=>{const n=findings.filter(f=>f.domaine===d).length;const pct=findings.length>0?Math.round((n/findings.length)*100):0;return(<div key={d} className="stat-row"><span style={{fontSize:12,fontWeight:600}}>{d}</span><div style={{display:"flex",alignItems:"center",gap:8}}><div style={{width:80,height:6,background:"var(--border)",borderRadius:3,overflow:"hidden"}}><div style={{width:pct+"%",height:"100%",background:"var(--gold)",borderRadius:3}}/></div><span className="mono" style={{fontSize:11,color:"var(--gold)"}}>{n}</span></div></div>)})}</div>
      <div className="card card-padded"><div className="section-title" style={{marginTop:0}}>Agrements par activite</div>{ACTIVITES.map(act=>{const n=agrements.filter(a=>a.activite===act).length;const actifs=agrements.filter(a=>a.activite===act&&a.statut==="Actif").length;return(<div key={act} className="stat-row"><span style={{fontSize:12,fontWeight:600}}>{act}</span><div style={{display:"flex",gap:6}}><Badge color="var(--gold)">{n} total</Badge><Badge color="var(--green)">{actifs} actifs</Badge></div></div>)})}</div>
    </div>
  </div>)
}

/* ===== FORMS ===== */
function AuditForm({audit,onClose,onSave}){
  const[f,setF]=useState(audit||{audit_id:"",entite:"",domaine:DOMAINES[0],date_debut:"",date_fin:"",responsable:"",statut:"Planifie",objectif:"",scope:"",notes:""});
  return(<Modal onClose={onClose} title={audit?"Modifier audit":"Nouvel Audit"}><div className="form-grid">
    <Field label="Ref Audit *"><input className="input" value={f.audit_id} onChange={e=>setF({...f,audit_id:e.target.value})} placeholder="AUD-2026-001"/></Field>
    <Field label="Domaine"><Sel value={f.domaine} onChange={v=>setF({...f,domaine:v})} options={DOMAINES}/></Field>
    <Field label="Entite *" span><input className="input" value={f.entite} onChange={e=>setF({...f,entite:e.target.value})} placeholder="Nom de l'entite auditee"/></Field>
    <Field label="Date debut"><input type="date" className="input" value={f.date_debut||""} onChange={e=>setF({...f,date_debut:e.target.value})}/></Field>
    <Field label="Date fin"><input type="date" className="input" value={f.date_fin||""} onChange={e=>setF({...f,date_fin:e.target.value})}/></Field>
    <Field label="Responsable"><input className="input" value={f.responsable||""} onChange={e=>setF({...f,responsable:e.target.value})}/></Field>
    <Field label="Statut"><Sel value={f.statut} onChange={v=>setF({...f,statut:v})} options={["Planifie","En cours","Termine","Cloture"]}/></Field>
    <Field label="Objectif" span><textarea className="textarea" value={f.objectif||""} onChange={e=>setF({...f,objectif:e.target.value})}/></Field>
    <Field label="Scope" span><textarea className="textarea" value={f.scope||""} onChange={e=>setF({...f,scope:e.target.value})}/></Field>
    <Field label="Notes" span><textarea className="textarea" value={f.notes||""} onChange={e=>setF({...f,notes:e.target.value})}/></Field>
  </div><button className="btn btn-gold btn-full" style={{marginTop:16}} onClick={()=>onSave(f)}>{audit?"Enregistrer":"Creer"}</button></Modal>)
}
function FindingForm({finding,audits,onClose,onSave}){
  const[f,setF]=useState(finding||{finding_id:"",audit_uuid:"",domaine:DOMAINES[0],classification:CLASSIFICATIONS[0],criticite:CRITICITES[0],description:"",reference_reglementaire:"",statut:"Ouvert",date_detection:"",echeance:"",notes:""});
  return(<Modal onClose={onClose} title={finding?"Modifier ecart":"Nouvel Ecart"}><div className="form-grid">
    <Field label="Ref Ecart *"><input className="input" value={f.finding_id} onChange={e=>setF({...f,finding_id:e.target.value})}/></Field>
    <Field label="Audit *"><select className="select" value={f.audit_uuid} onChange={e=>setF({...f,audit_uuid:e.target.value})}><option value="">—</option>{audits.map(a=><option key={a.id} value={a.id}>{a.audit_id} — {a.entite}</option>)}</select></Field>
    <Field label="Domaine"><Sel value={f.domaine} onChange={v=>setF({...f,domaine:v})} options={DOMAINES}/></Field>
    <Field label="Classification"><Sel value={f.classification} onChange={v=>setF({...f,classification:v})} options={CLASSIFICATIONS}/></Field>
    <Field label="Criticite"><Sel value={f.criticite} onChange={v=>setF({...f,criticite:v})} options={CRITICITES}/></Field>
    <Field label="Statut"><Sel value={f.statut} onChange={v=>setF({...f,statut:v})} options={["Ouvert","En traitement","Cloture"]}/></Field>
    <Field label="Date detection"><input type="date" className="input" value={f.date_detection||""} onChange={e=>setF({...f,date_detection:e.target.value})}/></Field>
    <Field label="Echeance"><input type="date" className="input" value={f.echeance||""} onChange={e=>setF({...f,echeance:e.target.value})}/></Field>
    <Field label="Description" span><textarea className="textarea" value={f.description||""} onChange={e=>setF({...f,description:e.target.value})}/></Field>
    <Field label="Ref reglementaire" span><input className="input" value={f.reference_reglementaire||""} onChange={e=>setF({...f,reference_reglementaire:e.target.value})}/></Field>
  </div><button className="btn btn-gold btn-full" style={{marginTop:16}} onClick={()=>onSave(f)}>{finding?"Enregistrer":"Creer"}</button></Modal>)
}
function CAPAForm({capa,findings,onClose,onSave}){
  const[f,setF]=useState(capa||{capa_id:"",finding_uuid:"",description:"",responsable:"",echeance:"",statut:"Brouillon",type_action:"Corrective",notes:""});
  return(<Modal onClose={onClose} title={capa?"Modifier CAPA":"Nouvelle CAPA"}><div className="form-grid">
    <Field label="Ref CAPA *"><input className="input" value={f.capa_id} onChange={e=>setF({...f,capa_id:e.target.value})}/></Field>
    <Field label="Ecart *"><select className="select" value={f.finding_uuid} onChange={e=>setF({...f,finding_uuid:e.target.value})}><option value="">—</option>{findings.map(fi=><option key={fi.id} value={fi.id}>{fi.finding_id}</option>)}</select></Field>
    <Field label="Statut"><Sel value={f.statut} onChange={v=>setF({...f,statut:v})} options={["Brouillon","Soumise","Acceptee","En cours","Realisee","Verifiee","Cloturee"]}/></Field>
    <Field label="Type"><Sel value={f.type_action} onChange={v=>setF({...f,type_action:v})} options={["Corrective","Preventive"]}/></Field>
    <Field label="Responsable"><input className="input" value={f.responsable||""} onChange={e=>setF({...f,responsable:e.target.value})}/></Field>
    <Field label="Echeance"><input type="date" className="input" value={f.echeance||""} onChange={e=>setF({...f,echeance:e.target.value})}/></Field>
    <Field label="Description" span><textarea className="textarea" value={f.description||""} onChange={e=>setF({...f,description:e.target.value})}/></Field>
  </div><button className="btn btn-gold btn-full" style={{marginTop:16}} onClick={()=>onSave(f)}>{capa?"Enregistrer":"Creer"}</button></Modal>)
}
function PreuveForm({preuve,capas,onClose,onSave}){
  const[f,setF]=useState(preuve||{preuve_id:"",capa_uuid:"",type_preuve:"Document",description:"",reference:"",date_soumission:"",statut:"Soumise",notes:""});
  return(<Modal onClose={onClose} title={preuve?"Modifier preuve":"Nouvelle Preuve"}><div className="form-grid">
    <Field label="Ref Preuve *"><input className="input" value={f.preuve_id} onChange={e=>setF({...f,preuve_id:e.target.value})}/></Field>
    <Field label="CAPA *"><select className="select" value={f.capa_uuid} onChange={e=>setF({...f,capa_uuid:e.target.value})}><option value="">—</option>{capas.map(c=><option key={c.id} value={c.id}>{c.capa_id}</option>)}</select></Field>
    <Field label="Type"><Sel value={f.type_preuve} onChange={v=>setF({...f,type_preuve:v})} options={["Document","Photo","Rapport","Certificat","Autre"]}/></Field>
    <Field label="Statut"><Sel value={f.statut} onChange={v=>setF({...f,statut:v})} options={["Soumise","Validee","Rejetee"]}/></Field>
    <Field label="Date soumission"><input type="date" className="input" value={f.date_soumission||""} onChange={e=>setF({...f,date_soumission:e.target.value})}/></Field>
    <Field label="Reference"><input className="input" value={f.reference||""} onChange={e=>setF({...f,reference:e.target.value})}/></Field>
    <Field label="Description" span><textarea className="textarea" value={f.description||""} onChange={e=>setF({...f,description:e.target.value})}/></Field>
  </div><button className="btn btn-gold btn-full" style={{marginTop:16}} onClick={()=>onSave(f)}>{preuve?"Enregistrer":"Creer"}</button></Modal>)
}

/* ===== AUDITS VIEW ===== */
function AuditsView({api,audits,findings,reload}){
  const[sf,setSf]=useState(false);const[ed,setEd]=useState(null);const[del,setDel]=useState(null);const[fil,setFil]=useState("Tous");
  const fl=audits.filter(a=>fil==="Tous"||a.statut===fil);
  const save=async(d)=>{try{if(ed)await api.update("audits",ed.id,d);else await api.insert("audits",d);setSf(false);setEd(null);reload()}catch(e){alert(e.message)}};
  const rm=async()=>{if(del){try{await api.remove("audits",del.id)}catch(e){alert(e.message)}setDel(null);reload()}};
  return(<div>
    <div className="filters"><div className="filter-group">{["Tous","Planifie","En cours","Termine","Cloture"].map(s=><button key={s} className={"filter-btn "+(fil===s?"active":"")} onClick={()=>setFil(s)}>{s}</button>)}</div><div className="spacer"/><button className="btn btn-gold" onClick={()=>{setEd(null);setSf(true)}}>+ Audit</button></div>
    <div className="table-container desktop-only">
      {fl.map(a=>{const nf=findings.filter(f=>f.audit_uuid===a.id).length;return(
        <div key={a.id} className="table-row" style={{gridTemplateColumns:"80px 1fr 60px 80px 70px 36px"}} onClick={()=>{setEd(a);setSf(true)}}>
          <span className="mono" style={{fontSize:10,color:"var(--dim)"}}>{a.audit_id}</span>
          <div><div style={{fontSize:13,fontWeight:600}}>{a.entite}</div><div style={{fontSize:11,color:"var(--dim)"}}>{a.responsable||"—"} — {a.date_debut||"—"}</div></div>
          <Badge color="var(--cyan)">{nf} ec.</Badge><Tag label={a.statut}/><Badge color={SC[a.domaine]||"var(--gold)"}>{a.domaine}</Badge>
          <button className="btn-icon" onClick={e=>{e.stopPropagation();setDel(a)}}>&#128465;</button>
        </div>)})}
      {fl.length===0&&<Empty text="Aucun audit"/>}
    </div>
    <div className="mobile-only">{fl.map(a=>{const nf=findings.filter(f=>f.audit_uuid===a.id).length;return(
      <div key={a.id} className="mobile-card" onClick={()=>{setEd(a);setSf(true)}}>
        <div className="mobile-card-header"><div><div className="mobile-card-title">{a.entite}</div><div className="mobile-card-id">{a.audit_id}</div></div><button className="btn-icon" onClick={e=>{e.stopPropagation();setDel(a)}}>&#128465;</button></div>
        <div className="mobile-card-meta"><Tag label={a.statut}/><Badge color="var(--cyan)">{nf} ecarts</Badge><Badge color="var(--gold)">{a.domaine}</Badge></div>
        <div className="mobile-card-footer"><span style={{fontSize:11,color:"var(--dim)"}}>{a.responsable||"—"}</span><span style={{fontSize:11,color:"var(--dim)"}}>{a.date_debut||"—"}</span></div>
      </div>)})}{fl.length===0&&<Empty text="Aucun audit"/>}</div>
    <FAB onClick={()=>{setEd(null);setSf(true)}}/>
    {sf&&<AuditForm audit={ed} onClose={()=>{setSf(false);setEd(null)}} onSave={save}/>}
    {del&&<ConfirmDelete item={del.audit_id} onConfirm={rm} onCancel={()=>setDel(null)}/>}
  </div>)
}

/* ===== FINDINGS VIEW ===== */
function FindingsView({api,audits,findings,reload}){
  const[sf,setSf]=useState(false);const[ed,setEd]=useState(null);const[del,setDel]=useState(null);const[fil,setFil]=useState("Tous");
  const fl=findings.filter(f=>fil==="Tous"||f.classification===fil||f.statut===fil);
  const save=async(d)=>{try{if(ed)await api.update("findings",ed.id,d);else await api.insert("findings",d);setSf(false);setEd(null);reload()}catch(e){alert(e.message)}};
  const rm=async()=>{if(del){try{await api.remove("findings",del.id)}catch(e){alert(e.message)}setDel(null);reload()}};
  return(<div>
    <div className="filters"><div className="filter-group">{["Tous","Ouvert","En traitement","Cloture"].map(s=><button key={s} className={"filter-btn "+(fil===s?"active":"")} onClick={()=>setFil(s)}>{s}</button>)}</div><div className="filter-group">{CLASSIFICATIONS.map(c=><button key={c} className={"filter-btn "+(fil===c?"active":"")} onClick={()=>setFil(fil===c?"Tous":c)}>{c}</button>)}</div><div className="spacer"/><button className="btn btn-gold" onClick={()=>{setEd(null);setSf(true)}}>+ Ecart</button></div>
    <div className="table-container desktop-only">
      {fl.map(f=>{const a=audits.find(x=>x.id===f.audit_uuid);return(
        <div key={f.id} className="table-row" style={{gridTemplateColumns:"70px 1fr 50px 70px 70px 36px"}} onClick={()=>{setEd(f);setSf(true)}}>
          <span className="mono" style={{fontSize:10,color:"var(--dim)"}}>{f.finding_id}</span>
          <div><div style={{fontSize:13,fontWeight:500}}>{(f.description||"").slice(0,60)}</div><div style={{fontSize:11,color:"var(--dim)"}}>{a?a.entite:"—"} — {f.domaine}</div></div>
          <Tag label={f.classification}/><Tag label={f.statut}/><span style={{fontSize:10,color:"var(--dim)"}}>{f.echeance||"—"}</span>
          <button className="btn-icon" onClick={e=>{e.stopPropagation();setDel(f)}}>&#128465;</button>
        </div>)})}
      {fl.length===0&&<Empty text="Aucun ecart"/>}
    </div>
    <div className="mobile-only">{fl.map(f=>{const a=audits.find(x=>x.id===f.audit_uuid);return(
      <div key={f.id} className="mobile-card" onClick={()=>{setEd(f);setSf(true)}}>
        <div className="mobile-card-header"><div><div className="mobile-card-title">{(f.description||"").slice(0,50)}</div><div className="mobile-card-id">{f.finding_id} — {a?a.entite:""}</div></div><button className="btn-icon" onClick={e=>{e.stopPropagation();setDel(f)}}>&#128465;</button></div>
        <div className="mobile-card-meta"><Tag label={f.classification}/><Tag label={f.statut}/><Badge color="var(--gold)">{f.domaine}</Badge></div>
      </div>)})}{fl.length===0&&<Empty text="Aucun ecart"/>}</div>
    <FAB onClick={()=>{setEd(null);setSf(true)}}/>
    {sf&&<FindingForm finding={ed} audits={audits} onClose={()=>{setSf(false);setEd(null)}} onSave={save}/>}
    {del&&<ConfirmDelete item={del.finding_id} onConfirm={rm} onCancel={()=>setDel(null)}/>}
  </div>)
}

/* ===== CAPA VIEW ===== */
function CAPAView({api,findings,capas,reload}){
  const[sf,setSf]=useState(false);const[ed,setEd]=useState(null);const[del,setDel]=useState(null);const[fil,setFil]=useState("Tous");
  const fl=capas.filter(c=>fil==="Tous"||c.statut===fil);
  const save=async(d)=>{try{if(ed)await api.update("capa",ed.id,d);else await api.insert("capa",d);setSf(false);setEd(null);reload()}catch(e){alert(e.message)}};
  const rm=async()=>{if(del){try{await api.remove("capa",del.id)}catch(e){alert(e.message)}setDel(null);reload()}};
  return(<div>
    <div className="filters"><div className="filter-group">{["Tous","Brouillon","Soumise","Acceptee","En cours","Realisee","Verifiee","Cloturee"].map(s=><button key={s} className={"filter-btn "+(fil===s?"active":"")} onClick={()=>setFil(s)}>{s}</button>)}</div><div className="spacer"/><button className="btn btn-purple" onClick={()=>exportCAPARetardPDF(capas,findings)}>PDF Retards</button><button className="btn btn-gold" onClick={()=>{setEd(null);setSf(true)}}>+ CAPA</button></div>
    <div className="table-container desktop-only">
      {fl.map(c=>{const f=findings.find(x=>x.id===c.finding_uuid);const retard=c.echeance&&new Date(c.echeance)<new Date()&&c.statut!=="Verifiee"&&c.statut!=="Cloturee";return(
        <div key={c.id} className="table-row" style={{gridTemplateColumns:"70px 1fr 80px 80px 80px 36px",background:retard?"rgba(200,16,46,0.03)":"transparent"}} onClick={()=>{setEd(c);setSf(true)}}>
          <span className="mono" style={{fontSize:10,color:"var(--dim)"}}>{c.capa_id}</span>
          <div><div style={{fontSize:13,fontWeight:500}}>{(c.description||"").slice(0,50)}</div><div style={{fontSize:11,color:"var(--dim)"}}>{f?f.finding_id:"—"} — {c.responsable||"—"}</div></div>
          <Tag label={c.statut}/><span style={{fontSize:11,color:retard?"var(--red-tn)":"var(--dim)"}}>{c.echeance||"—"}{retard?" !":""}</span><Badge color={c.type_action==="Corrective"?"var(--orange)":"var(--cyan)"}>{c.type_action}</Badge>
          <button className="btn-icon" onClick={e=>{e.stopPropagation();setDel(c)}}>&#128465;</button>
        </div>)})}
      {fl.length===0&&<Empty text="Aucune CAPA"/>}
    </div>
    <div className="mobile-only">{fl.map(c=>{const f=findings.find(x=>x.id===c.finding_uuid);const retard=c.echeance&&new Date(c.echeance)<new Date()&&c.statut!=="Verifiee"&&c.statut!=="Cloturee";return(
      <div key={c.id} className="mobile-card" style={{borderColor:retard?"rgba(200,16,46,0.2)":"var(--border)"}} onClick={()=>{setEd(c);setSf(true)}}>
        <div className="mobile-card-header"><div><div className="mobile-card-title">{c.capa_id}</div><div className="mobile-card-id">{(c.description||"").slice(0,40)}</div></div><button className="btn-icon" onClick={e=>{e.stopPropagation();setDel(c)}}>&#128465;</button></div>
        <div className="mobile-card-meta"><Tag label={c.statut}/><span style={{fontSize:11,color:retard?"var(--red-tn)":"var(--dim)"}}>{c.echeance||"—"}</span></div>
      </div>)})}{fl.length===0&&<Empty text="Aucune CAPA"/>}</div>
    <FAB onClick={()=>{setEd(null);setSf(true)}}/>
    {sf&&<CAPAForm capa={ed} findings={findings} onClose={()=>{setSf(false);setEd(null)}} onSave={save}/>}
    {del&&<ConfirmDelete item={del.capa_id} onConfirm={rm} onCancel={()=>setDel(null)}/>}
  </div>)
}

/* ===== PREUVES VIEW ===== */
function PreuvesView({api,capas,preuves,reload}){
  const[sf,setSf]=useState(false);const[ed,setEd]=useState(null);const[del,setDel]=useState(null);
  const save=async(d)=>{try{if(ed)await api.update("preuves",ed.id,d);else await api.insert("preuves",d);setSf(false);setEd(null);reload()}catch(e){alert(e.message)}};
  const rm=async()=>{if(del){try{await api.remove("preuves",del.id)}catch(e){alert(e.message)}setDel(null);reload()}};
  return(<div>
    <div className="filters"><div className="spacer"/><button className="btn btn-gold" onClick={()=>{setEd(null);setSf(true)}}>+ Preuve</button></div>
    <div className="table-container desktop-only">
      {preuves.map(p=>{const c=capas.find(x=>x.id===p.capa_uuid);return(
        <div key={p.id} className="table-row" style={{gridTemplateColumns:"70px 1fr 80px 80px 80px 36px"}} onClick={()=>{setEd(p);setSf(true)}}>
          <span className="mono" style={{fontSize:10,color:"var(--dim)"}}>{p.preuve_id}</span>
          <div><div style={{fontSize:13,fontWeight:500}}>{(p.description||"").slice(0,50)}</div><div style={{fontSize:11,color:"var(--dim)"}}>{c?c.capa_id:"—"}</div></div>
          <Badge color="var(--gold)">{p.type_preuve}</Badge><Tag label={p.statut}/><span style={{fontSize:11,color:"var(--dim)"}}>{p.date_soumission||"—"}</span>
          <button className="btn-icon" onClick={e=>{e.stopPropagation();setDel(p)}}>&#128465;</button>
        </div>)})}
      {preuves.length===0&&<Empty text="Aucune preuve"/>}
    </div>
    <div className="mobile-only">{preuves.map(p=>{const c=capas.find(x=>x.id===p.capa_uuid);return(
      <div key={p.id} className="mobile-card" onClick={()=>{setEd(p);setSf(true)}}>
        <div className="mobile-card-header"><div><div className="mobile-card-title">{p.preuve_id}</div><div className="mobile-card-id">{(p.description||"").slice(0,40)}</div></div><Tag label={p.statut}/></div>
        <div className="mobile-card-meta"><Badge color="var(--gold)">{p.type_preuve}</Badge><span style={{fontSize:11,color:"var(--dim)"}}>{c?c.capa_id:""}</span></div>
      </div>)})}{preuves.length===0&&<Empty text="Aucune preuve"/>}</div>
    <FAB onClick={()=>{setEd(null);setSf(true)}}/>
    {sf&&<PreuveForm preuve={ed} capas={capas} onClose={()=>{setSf(false);setEd(null)}} onSave={save}/>}
    {del&&<ConfirmDelete item={del.preuve_id} onConfirm={rm} onCancel={()=>setDel(null)}/>}
  </div>)
}

/* ===== AGREMENTS FORM ===== */
function AgrementForm({agrement,audits,onClose,onSave}){
  const[f,setF]=useState(agrement||{entite:"",activite:ACTIVITES[0],type_agrement:SOUS_TYPES[ACTIVITES[0]][0],numero:"",date_delivrance:"",date_expiration:"",statut:"Actif",audit_uuid:"",delai_audit_mois:3,observations:""});
  const stypes=SOUS_TYPES[f.activite]||[];
  return(<Modal onClose={onClose} title={agrement?"Modifier agrement":"Nouvel Agrement"}><div className="form-grid">
    <Field label="Entite *" span><input className="input" value={f.entite} onChange={e=>setF({...f,entite:e.target.value})} placeholder="Nom de l'entite"/></Field>
    <Field label="Activite"><select className="select" value={f.activite} onChange={e=>{const v=e.target.value;setF({...f,activite:v,type_agrement:(SOUS_TYPES[v]||[])[0]||""})}}>{ACTIVITES.map(a=><option key={a} value={a}>{a}</option>)}</select></Field>
    <Field label="Type"><select className="select" value={f.type_agrement} onChange={e=>setF({...f,type_agrement:e.target.value})}>{stypes.map(s=><option key={s} value={s}>{s}</option>)}</select></Field>
    <Field label="Numero"><input className="input" value={f.numero||""} onChange={e=>setF({...f,numero:e.target.value})}/></Field>
    <Field label="Statut"><Sel value={f.statut} onChange={v=>setF({...f,statut:v})} options={STATUTS_AGREMENT}/></Field>
    <Field label="Date delivrance"><input type="date" className="input" value={f.date_delivrance||""} onChange={e=>setF({...f,date_delivrance:e.target.value})}/></Field>
    <Field label="Date expiration"><input type="date" className="input" value={f.date_expiration||""} onChange={e=>setF({...f,date_expiration:e.target.value})}/></Field>
    <Field label="Delai audit avant exp. (mois)"><input type="number" className="input" min="1" max="12" value={f.delai_audit_mois||3} onChange={e=>setF({...f,delai_audit_mois:parseInt(e.target.value)||3})}/></Field>
    <Field label="Audit lie"><select className="select" value={f.audit_uuid||""} onChange={e=>setF({...f,audit_uuid:e.target.value})}><option value="">— Aucun —</option>{audits.map(a=><option key={a.id} value={a.id}>{a.audit_id} — {a.entite}</option>)}</select></Field>
    <Field label="Observations" span><textarea className="textarea" value={f.observations||""} onChange={e=>setF({...f,observations:e.target.value})}/></Field>
  </div><button className="btn btn-gold btn-full" style={{marginTop:16}} onClick={()=>onSave(f)}>{agrement?"Enregistrer":"Creer"}</button></Modal>)
}

/* ===== AUTORISATIONS FORM ===== */
function AutorisationForm({autorisation,agrements,onClose,onSave}){
  const[f,setF]=useState(autorisation||{type_autorisation:"",beneficiaire:"",agrement_uuid:"",date_delivrance:"",date_validite:"",statut:"Accordee",reference:"",observations:""});
  return(<Modal onClose={onClose} title={autorisation?"Modifier autorisation":"Nouvelle Autorisation"}><div className="form-grid">
    <Field label="Type *"><input className="input" value={f.type_autorisation} onChange={e=>setF({...f,type_autorisation:e.target.value})} placeholder="Type d'autorisation"/></Field>
    <Field label="Beneficiaire *"><input className="input" value={f.beneficiaire} onChange={e=>setF({...f,beneficiaire:e.target.value})}/></Field>
    <Field label="Agrement lie"><select className="select" value={f.agrement_uuid||""} onChange={e=>setF({...f,agrement_uuid:e.target.value})}><option value="">— Independante —</option>{agrements.map(a=><option key={a.id} value={a.id}>{a.entite} — {a.numero}</option>)}</select></Field>
    <Field label="Statut"><Sel value={f.statut} onChange={v=>setF({...f,statut:v})} options={STATUTS_AUTORISATION}/></Field>
    <Field label="Date delivrance"><input type="date" className="input" value={f.date_delivrance||""} onChange={e=>setF({...f,date_delivrance:e.target.value})}/></Field>
    <Field label="Date validite"><input type="date" className="input" value={f.date_validite||""} onChange={e=>setF({...f,date_validite:e.target.value})}/></Field>
    <Field label="Reference"><input className="input" value={f.reference||""} onChange={e=>setF({...f,reference:e.target.value})}/></Field>
    <Field label="Observations" span><textarea className="textarea" value={f.observations||""} onChange={e=>setF({...f,observations:e.target.value})}/></Field>
  </div><button className="btn btn-gold btn-full" style={{marginTop:16}} onClick={()=>onSave(f)}>{autorisation?"Enregistrer":"Creer"}</button></Modal>)
}

/* ===== AGREMENTS VIEW ===== */
function AgrementsView({api,agrements,autorisations,audits,reload}){
  const[sf,setSf]=useState(false);const[ed,setEd]=useState(null);const[del,setDel]=useState(null);const[actF,setActF]=useState("Tous");
  const fl=agrements.filter(a=>actF==="Tous"||a.activite===actF);
  const save=async(d)=>{try{if(ed)await api.update("agrements",ed.id,d);else await api.insert("agrements",d);setSf(false);setEd(null);reload()}catch(e){alert(e.message)}};
  const rm=async()=>{if(del){try{await api.remove("agrements",del.id)}catch(e){alert(e.message)}setDel(null);reload()}};
  return(<div>
    <div className="filters">
      <div className="filter-group">{["Tous",...ACTIVITES].map(a=><button key={a} className={"filter-btn "+(actF===a?"active":"")} onClick={()=>setActF(a)}>{a}{a!=="Tous"&&<span style={{marginLeft:4,opacity:0.6}}>({agrements.filter(x=>x.activite===a).length})</span>}</button>)}</div>
      <div className="spacer"/>
      <button className="btn btn-cyan" onClick={()=>exportAgrementsPDF(agrements)}>PDF Liste</button>
      <button className="btn btn-gold" onClick={()=>{setEd(null);setSf(true)}}>+ Agrement</button>
    </div>
    <div className="table-container desktop-only">
      {fl.map(a=>{const d=daysUntil(a.date_expiration);const expiring=d>=0&&d<=30;const expired=d<0;const nAut=autorisations.filter(x=>x.agrement_uuid===a.id).length;return(
        <div key={a.id} className="table-row" style={{gridTemplateColumns:"1fr 90px 80px 90px 80px 60px 36px",background:expired?"rgba(200,16,46,0.03)":expiring?"rgba(243,156,18,0.03)":"transparent"}} onClick={()=>{setEd(a);setSf(true)}}>
          <div><div style={{fontSize:13,fontWeight:600}}>{a.entite}</div><div style={{fontSize:11,color:"var(--dim)"}}>{a.numero||"—"}</div></div>
          <Badge color="var(--gold)">{a.type_agrement}</Badge>
          <Tag label={a.statut}/>
          <span style={{fontSize:11,color:expired?"var(--red-tn)":expiring?"var(--orange)":"var(--dim)"}}>{a.date_expiration||"—"}{expired?" (expire)":expiring?" ("+d+"j)":""}</span>
          <Badge color="var(--cyan)">{nAut} aut.</Badge>
          <button className="btn btn-outline btn-sm" onClick={e=>{e.stopPropagation();exportAgrementFiche(a,autorisations)}}>PDF</button>
          <button className="btn-icon" onClick={e=>{e.stopPropagation();setDel(a)}}>&#128465;</button>
        </div>)})}
      {fl.length===0&&<Empty text="Aucun agrement"/>}
    </div>
    <div className="mobile-only">{fl.map(a=>{const d=daysUntil(a.date_expiration);const expiring=d>=0&&d<=30;const expired=d<0;return(
      <div key={a.id} className="mobile-card" style={{borderColor:expired?"rgba(200,16,46,0.2)":expiring?"rgba(243,156,18,0.2)":"var(--border)"}} onClick={()=>{setEd(a);setSf(true)}}>
        <div className="mobile-card-header"><div><div className="mobile-card-title">{a.entite}</div><div className="mobile-card-id">{a.numero||"—"}</div></div><button className="btn-icon" onClick={e=>{e.stopPropagation();setDel(a)}}>&#128465;</button></div>
        <div className="mobile-card-meta"><Badge color="var(--gold)">{a.type_agrement}</Badge><Tag label={a.statut}/></div>
        <div className="mobile-card-footer"><span style={{fontSize:11,color:expired?"var(--red-tn)":expiring?"var(--orange)":"var(--dim)"}}>{a.date_expiration||"—"}</span></div>
      </div>)})}{fl.length===0&&<Empty text="Aucun agrement"/>}</div>
    <FAB onClick={()=>{setEd(null);setSf(true)}}/>
    {sf&&<AgrementForm agrement={ed} audits={audits} onClose={()=>{setSf(false);setEd(null)}} onSave={save}/>}
    {del&&<ConfirmDelete item={del.entite+" — "+del.numero} onConfirm={rm} onCancel={()=>setDel(null)}/>}
  </div>)
}

/* ===== AUTORISATIONS VIEW ===== */
function AutorisationsView({api,agrements,autorisations,reload}){
  const[sf,setSf]=useState(false);const[ed,setEd]=useState(null);const[del,setDel]=useState(null);
  const save=async(d)=>{try{if(ed)await api.update("autorisations",ed.id,d);else await api.insert("autorisations",d);setSf(false);setEd(null);reload()}catch(e){alert(e.message)}};
  const rm=async()=>{if(del){try{await api.remove("autorisations",del.id)}catch(e){alert(e.message)}setDel(null);reload()}};
  return(<div>
    <div className="filters"><div className="spacer"/><button className="btn btn-gold" onClick={()=>{setEd(null);setSf(true)}}>+ Autorisation</button></div>
    <div className="table-container desktop-only">
      {autorisations.map(a=>{const ag=agrements.find(x=>x.id===a.agrement_uuid);return(
        <div key={a.id} className="table-row" style={{gridTemplateColumns:"1fr 1fr 80px 80px 36px"}} onClick={()=>{setEd(a);setSf(true)}}>
          <div><div style={{fontSize:13,fontWeight:600}}>{a.type_autorisation}</div><div style={{fontSize:11,color:"var(--dim)"}}>{a.beneficiaire}</div></div>
          <div style={{fontSize:11,color:"var(--dim)"}}>{ag?ag.entite+" ("+ag.numero+")":"Independante"}</div>
          <Tag label={a.statut}/><span style={{fontSize:11,color:"var(--dim)"}}>{a.date_validite||"—"}</span>
          <button className="btn-icon" onClick={e=>{e.stopPropagation();setDel(a)}}>&#128465;</button>
        </div>)})}
      {autorisations.length===0&&<Empty text="Aucune autorisation"/>}
    </div>
    <div className="mobile-only">{autorisations.map(a=>{const ag=agrements.find(x=>x.id===a.agrement_uuid);return(
      <div key={a.id} className="mobile-card" onClick={()=>{setEd(a);setSf(true)}}>
        <div className="mobile-card-header"><div><div className="mobile-card-title">{a.type_autorisation}</div><div className="mobile-card-id">{a.beneficiaire}</div></div><Tag label={a.statut}/></div>
        <div className="mobile-card-footer"><span style={{fontSize:11,color:"var(--dim)"}}>{ag?ag.entite:"Independante"}</span><span style={{fontSize:11,color:"var(--dim)"}}>{a.date_validite||"—"}</span></div>
      </div>)})}{autorisations.length===0&&<Empty text="Aucune autorisation"/>}</div>
    <FAB onClick={()=>{setEd(null);setSf(true)}}/>
    {sf&&<AutorisationForm autorisation={ed} agrements={agrements} onClose={()=>{setSf(false);setEd(null)}} onSave={save}/>}
    {del&&<ConfirmDelete item={del.type_autorisation} onConfirm={rm} onCancel={()=>setDel(null)}/>}
  </div>)
}

/* ===== PLANNING VIEW ===== */
function PlanningView({agrements,audits}){
  const[view,setView]=useState("list");
  const[month,setMonth]=useState(new Date().getMonth());
  const[year,setYear]=useState(new Date().getFullYear());
  const MOIS=["Janvier","Fevrier","Mars","Avril","Mai","Juin","Juillet","Aout","Septembre","Octobre","Novembre","Decembre"];

  const planned=agrements.filter(a=>a.statut==="Actif"&&a.date_expiration).map(a=>{
    const exp=new Date(a.date_expiration);
    const delai=a.delai_audit_mois||3;
    const auditDate=new Date(exp);auditDate.setMonth(auditDate.getMonth()-delai);
    const linked=audits.find(x=>x.id===a.audit_uuid);
    const d=daysUntil(auditDate.toISOString().slice(0,10));
    let urgence="normal";if(d<0)urgence="retard";else if(d<=30)urgence="urgent";else if(d<=60)urgence="proche";
    return{...a,auditDate:auditDate.toISOString().slice(0,10),delai:delai,linkedAudit:linked,daysUntilAudit:d,urgence:urgence};
  }).sort((a,b)=>a.auditDate.localeCompare(b.auditDate));

  const daysInMonth=new Date(year,month+1,0).getDate();
  const firstDay=(new Date(year,month,1).getDay()+6)%7;
  const calDays=[];
  for(let i=0;i<firstDay;i++)calDays.push(null);
  for(let d=1;d<=daysInMonth;d++)calDays.push(d);
  const today=new Date();const isToday=(d)=>d===today.getDate()&&month===today.getMonth()&&year===today.getFullYear();
  const eventsForDay=(d)=>{const ds=year+"-"+String(month+1).padStart(2,"0")+"-"+String(d).padStart(2,"0");return planned.filter(p=>p.auditDate===ds)};

  const prevMonth=()=>{if(month===0){setMonth(11);setYear(year-1)}else setMonth(month-1)};
  const nextMonth=()=>{if(month===11){setMonth(0);setYear(year+1)}else setMonth(month+1)};

  return(<div>
    <div className="filters">
      <div className="filter-group"><button className={"filter-btn "+(view==="list"?"active":"")} onClick={()=>setView("list")}>Liste</button><button className={"filter-btn "+(view==="cal"?"active":"")} onClick={()=>setView("cal")}>Calendrier</button></div>
    </div>
    <div className="kpi-grid">
      <KPI label="Audits planifies" value={planned.length} color="var(--gold)"/>
      <KPI label="En retard" value={planned.filter(p=>p.urgence==="retard").length} color="var(--red-tn)"/>
      <KPI label="Urgent (30j)" value={planned.filter(p=>p.urgence==="urgent").length} color="var(--orange)"/>
      <KPI label="A venir" value={planned.filter(p=>p.urgence==="normal"||p.urgence==="proche").length} color="var(--green)"/>
    </div>

    {view==="list"?(
      <div className="table-container">
        <div className="table-row" style={{gridTemplateColumns:"1fr 80px 80px 90px 80px",background:"rgba(189,165,107,0.04)",fontWeight:700,fontSize:10,color:"var(--gold)",textTransform:"uppercase",letterSpacing:1,cursor:"default"}}>
          <span>Entite / Agrement</span><span>Type</span><span>Exp. agrement</span><span>Audit prevu</span><span>Statut</span>
        </div>
        {planned.map((p,i)=>{const uc=p.urgence==="retard"?"var(--red-tn)":p.urgence==="urgent"?"var(--orange)":p.urgence==="proche"?"var(--cyan)":"var(--green)";return(
          <div key={i} className="table-row" style={{gridTemplateColumns:"1fr 80px 80px 90px 80px",background:p.urgence==="retard"?"rgba(200,16,46,0.03)":"transparent"}}>
            <div><div style={{fontSize:13,fontWeight:600}}>{p.entite}</div><div style={{fontSize:11,color:"var(--dim)"}}>{p.numero} — Delai: {p.delai} mois</div></div>
            <Badge color="var(--gold)">{p.type_agrement}</Badge>
            <span style={{fontSize:11,color:"var(--dim)"}}>{p.date_expiration}</span>
            <span className="mono" style={{fontSize:12,fontWeight:600,color:uc}}>{p.auditDate}</span>
            <span style={{fontSize:11}}>
              {p.linkedAudit?<Tag label={p.linkedAudit.statut}/>:<Badge color={uc}>{p.urgence==="retard"?"En retard":p.urgence==="urgent"?"Urgent":"A planifier"}</Badge>}
            </span>
          </div>)})}
        {planned.length===0&&<Empty text="Aucun audit a planifier"/>}
      </div>
    ):(
      <div className="card card-padded">
        <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:16}}>
          <button className="btn-icon" onClick={prevMonth} style={{fontSize:18}}>&#9664;</button>
          <div style={{fontSize:16,fontWeight:700,fontFamily:"'Playfair Display',serif",color:"var(--gold-light)"}}>{MOIS[month]} {year}</div>
          <button className="btn-icon" onClick={nextMonth} style={{fontSize:18}}>&#9654;</button>
        </div>
        <div className="cal-grid">
          {["Lun","Mar","Mer","Jeu","Ven","Sam","Dim"].map(d=><div key={d} className="cal-head">{d}</div>)}
          {calDays.map((d,i)=>{
            if(d===null)return <div key={"e"+i} className="cal-day"/>;
            const evts=eventsForDay(d);
            const hasAlert=evts.some(e=>e.urgence==="retard"||e.urgence==="urgent");
            return(<div key={i} className={"cal-day"+(evts.length>0?" has-event":"")+(isToday(d)?" today":"")+(hasAlert?" alert":"")} title={evts.map(e=>e.entite).join(", ")}>
              {d}{evts.length>0&&<div style={{fontSize:7,marginTop:1}}>{evts.length} audit{evts.length>1?"s":""}</div>}
            </div>)
          })}
        </div>
        <div style={{marginTop:16}}>
          {planned.filter(p=>{const d=new Date(p.auditDate);return d.getMonth()===month&&d.getFullYear()===year}).map((p,i)=>(
            <div key={i} className="stat-row"><div><div style={{fontSize:13,fontWeight:600}}>{p.entite}</div><div style={{fontSize:11,color:"var(--dim)"}}>{p.type_agrement} — {p.auditDate}</div></div><Badge color={p.urgence==="retard"?"var(--red-tn)":p.urgence==="urgent"?"var(--orange)":"var(--green)"}>{p.urgence==="retard"?"Retard":p.urgence==="urgent"?"Urgent":"Prevu"}</Badge></div>
          ))}
        </div>
      </div>
    )}
  </div>)
}

/* ===== ALERT POPUP ===== */
function AlertPopup({agrements,capas,onClose}){
  const expSoon=agrements.filter(a=>a.statut==="Actif"&&daysUntil(a.date_expiration)<=30&&daysUntil(a.date_expiration)>=0);
  const expired=agrements.filter(a=>a.statut==="Actif"&&daysUntil(a.date_expiration)<0);
  const capaRetard=capas.filter(c=>c.echeance&&new Date(c.echeance)<new Date()&&c.statut!=="Verifiee"&&c.statut!=="Cloturee");
  const total=expSoon.length+expired.length+capaRetard.length;
  if(total===0)return null;
  return(<Modal onClose={onClose} title={"Alertes ("+total+")"} width={480}>
    {expired.length>0&&<div style={{marginBottom:14}}><div style={{fontSize:12,fontWeight:700,color:"var(--red-tn)",marginBottom:6}}>AGREMENTS EXPIRES</div>{expired.map(a=><div key={a.id} className="alert-card"><div><div style={{fontSize:13,fontWeight:600}}>{a.entite}</div><div style={{fontSize:11,color:"var(--red-tn)"}}>{a.type_agrement} — expire depuis {Math.abs(daysUntil(a.date_expiration))}j</div></div></div>)}</div>}
    {expSoon.length>0&&<div style={{marginBottom:14}}><div style={{fontSize:12,fontWeight:700,color:"var(--orange)",marginBottom:6}}>EXPIRENT DANS 30 JOURS</div>{expSoon.map(a=><div key={a.id} className="alert-card warn"><div><div style={{fontSize:13,fontWeight:600}}>{a.entite}</div><div style={{fontSize:11,color:"var(--orange)"}}>{a.type_agrement} — expire dans {daysUntil(a.date_expiration)}j ({a.date_expiration})</div></div></div>)}</div>}
    {capaRetard.length>0&&<div><div style={{fontSize:12,fontWeight:700,color:"var(--red-tn)",marginBottom:6}}>CAPA EN RETARD</div>{capaRetard.slice(0,8).map(c=><div key={c.id} className="alert-card"><div><div style={{fontSize:13,fontWeight:600}}>CAPA {c.capa_id}</div><div style={{fontSize:11,color:"var(--red-tn)"}}>Echeance: {c.echeance}</div></div></div>)}</div>}
    <button className="btn btn-outline btn-full" style={{marginTop:18}} onClick={onClose}>Fermer</button>
  </Modal>)
}

/* ===== MAIN APP ===== */
function App(){
  const[user,setUser]=useState(null);const[token,setToken]=useState(null);const[api,setApi]=useState(null);
  const[tab,setTab]=useState("dashboard");const[loading,setLoading]=useState(false);const[error,setError]=useState("");
  const[cs,setCs]=useState(true);const[showAlerts,setShowAlerts]=useState(false);const[alertShown,setAlertShown]=useState(false);
  const[audits,setAudits]=useState([]);const[findings,setFindings]=useState([]);const[capas,setCapas]=useState([]);const[preuves,setPreuves]=useState([]);
  const[agrements,setAgrements]=useState([]);const[autorisations,setAutorisations]=useState([]);

  const loadAll=useCallback(async(ar)=>{
    const a=ar||api;if(!a)return;setLoading(true);setError("");
    try{
      const[au,fi,ca,pr,ag,at]=await Promise.all([
        a.select("audits","order=created_at.desc"),a.select("findings","order=created_at.desc"),
        a.select("capa","order=created_at.desc"),a.select("preuves","order=created_at.desc"),
        a.select("agrements","order=entite.asc"),a.select("autorisations","order=created_at.desc")
      ]);
      setAudits(au);setFindings(fi);setCapas(ca);setPreuves(pr);setAgrements(ag);setAutorisations(at);
      if(!alertShown){
        const expN=ag.filter(x=>x.statut==="Actif"&&daysUntil(x.date_expiration)<=30);
        const capR=ca.filter(c=>c.echeance&&new Date(c.echeance)<new Date()&&c.statut!=="Verifiee"&&c.statut!=="Cloturee");
        if(expN.length+capR.length>0){setShowAlerts(true);setAlertShown(true)}
      }
    }catch(e){setError("Erreur: "+e.message)}
    setLoading(false)
  },[api,alertShown]);

  const handleLogin=(t,u)=>{const a=createApi(t);setToken(t);setUser(u);setApi(a);loadAll(a)};
  const handleLogout=async()=>{try{if(token)await authApi.logout(token)}catch(e){}localStorage.removeItem("audit_token");setUser(null);setToken(null);setApi(null)};

  useEffect(()=>{
    const t=localStorage.getItem("audit_token");
    if(t){authApi.getUser(t).then(u=>{const a=createApi(t);setToken(t);setUser(u);setApi(a);loadAll(a);setCs(false)}).catch(()=>{localStorage.removeItem("audit_token");setCs(false)})}
    else setCs(false)
  },[]);

  if(cs)return <div style={{minHeight:"100vh",display:"flex",alignItems:"center",justifyContent:"center",background:"var(--bg)"}}><div style={{textAlign:"center"}}><div style={{fontSize:44,marginBottom:10}}>&#9992;</div><div style={{color:"var(--muted)",fontSize:13}}>Chargement...</div></div></div>;
  if(!user)return <LoginScreen onLogin={handleLogin}/>;

  const expSoon=agrements.filter(a=>a.statut==="Actif"&&daysUntil(a.date_expiration)<=30);
  const capaRetard=capas.filter(c=>c.echeance&&new Date(c.echeance)<new Date()&&c.statut!=="Verifiee"&&c.statut!=="Cloturee");
  const totalAlerts=expSoon.length+capaRetard.length;

  const tabs=[
    {id:"dashboard",label:"Accueil",ml:"Accueil",icon:"\u2302"},
    {id:"audits",label:"Audits",ml:"Audits",icon:"\uD83D\uDD0D",count:audits.filter(a=>a.statut!=="Cloture").length},
    {id:"findings",label:"Ecarts",ml:"Ecarts",icon:"\u26A0",count:findings.filter(f=>f.statut==="Ouvert").length},
    {id:"capa",label:"CAPA",ml:"CAPA",icon:"\u2699",count:capaRetard.length},
    {id:"preuves",label:"Preuves",ml:"Preuves",icon:"\uD83D\uDCCE"},
    {id:"agrements",label:"Agrements",ml:"Agrem.",icon:"\uD83D\uDCC4",alert:expSoon.length},
    {id:"autorisations",label:"Autorisations",ml:"Autor.",icon:"\u2714"},
    {id:"planning",label:"Planning",ml:"Planning",icon:"\uD83D\uDCC5"}
  ];

  return(<div>
    <div className="tn-stripe"/>
    <header className="header">
      <div className="header-left">
        <div className="logo-mark">&#9992;</div>
        <div><div className="header-title">Suivi des Audits — DGAC</div><div className="header-sub">Direction Generale de l'Aviation Civile</div></div>
      </div>
      <div className="desktop-tabs">{tabs.map(t=><button key={t.id} className={"tab-btn "+(tab===t.id?"active":"")} onClick={()=>setTab(t.id)}><span>{t.icon}</span> {t.label}{t.count>0&&<span className="tab-count">{t.count}</span>}{t.alert>0&&<span className="tab-alert">{t.alert}</span>}</button>)}</div>
      <div className="header-right" style={{display:"flex",gap:6,alignItems:"center"}}>
        {totalAlerts>0&&<button className="btn btn-red btn-sm" onClick={()=>setShowAlerts(true)}>{totalAlerts} alerte{totalAlerts>1?"s":""}</button>}
        <div className="user-badge"><div className="user-dot"/>{user.email}</div>
        <button className="btn-outline btn-sm" onClick={()=>loadAll()}>{loading?"\u23F3":"\u21BB"}</button>
        <button className="btn-outline btn-outline-red btn-sm" onClick={handleLogout}>Sortir</button>
      </div>
    </header>
    <nav className="mobile-nav">
      {tabs.slice(0,6).map(t=><button key={t.id} className={"mobile-nav-btn "+(tab===t.id?"active":"")} onClick={()=>setTab(t.id)}><span className="nav-icon">{t.icon}</span>{t.ml}{(t.alert>0||t.count>0)&&tab!==t.id&&<span className="nav-badge">{t.alert||t.count}</span>}</button>)}
      <button className="mobile-nav-btn" onClick={()=>setTab(tab==="planning"?"autorisations":"planning")}><span className="nav-icon">{tab==="planning"?"\u2714":"\uD83D\uDCC5"}</span>{tab==="planning"?"Autor.":"Plan."}</button>
      <button className="mobile-nav-btn" onClick={handleLogout}><span className="nav-icon">&#x1F6AA;</span>Sortir</button>
    </nav>
    {error&&<div className="error-box" style={{margin:"10px 14px 0"}}>{error}</div>}
    <main style={{padding:"24px 28px",maxWidth:1400,margin:"0 auto"}}>
      {tab==="dashboard"&&<Dashboard audits={audits} findings={findings} capas={capas} preuves={preuves} agrements={agrements} autorisations={autorisations} onNav={setTab}/>}
      {tab==="audits"&&<AuditsView api={api} audits={audits} findings={findings} reload={()=>loadAll()}/>}
      {tab==="findings"&&<FindingsView api={api} audits={audits} findings={findings} reload={()=>loadAll()}/>}
      {tab==="capa"&&<CAPAView api={api} findings={findings} capas={capas} reload={()=>loadAll()}/>}
      {tab==="preuves"&&<PreuvesView api={api} capas={capas} preuves={preuves} reload={()=>loadAll()}/>}
      {tab==="agrements"&&<AgrementsView api={api} agrements={agrements} autorisations={autorisations} audits={audits} reload={()=>loadAll()}/>}
      {tab==="autorisations"&&<AutorisationsView api={api} agrements={agrements} autorisations={autorisations} reload={()=>loadAll()}/>}
      {tab==="planning"&&<PlanningView agrements={agrements} audits={audits}/>}
    </main>
    {showAlerts&&<AlertPopup agrements={agrements} capas={capas} onClose={()=>setShowAlerts(false)}/>}
  </div>)
}

ReactDOM.createRoot(document.getElementById("app")).render(<App/>);

</script>
</body>
</html>

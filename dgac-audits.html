<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DGAC ‚Äî Suivi des Audits</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet">
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  :root {
    --bg: #080C18; --card: #0E1326; --card-hover: #121836;
    --border: rgba(255,255,255,0.06); --border-light: rgba(255,255,255,0.1);
    --text: #E2E8F0; --muted: rgba(255,255,255,0.4); --dim: rgba(255,255,255,0.25);
    --accent: #3B82F6; --accent-dark: #1D4ED8;
    --red: #EF4444; --orange: #F59E0B; --green: #10B981; --purple: #A78BFA; --cyan: #22D3EE;
  }
  body { background: var(--bg); color: var(--text); font-family: 'DM Sans', sans-serif; min-height: 100vh; }
  .mono { font-family: 'JetBrains Mono', monospace; }

  /* Scrollbar */
  ::-webkit-scrollbar { width: 6px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 3px; }

  /* Header */
  .header {
    padding: 14px 28px; border-bottom: 1px solid var(--border);
    display: flex; justify-content: space-between; align-items: center;
    background: rgba(8,12,24,0.95); backdrop-filter: blur(10px);
    position: sticky; top: 0; z-index: 100;
  }
  .header-left { display: flex; align-items: center; gap: 12px; }
  .logo {
    width: 34px; height: 34px; border-radius: 9px;
    background: linear-gradient(135deg, var(--accent), var(--accent-dark));
    display: flex; align-items: center; justify-content: center; font-size: 16px;
  }
  .header-title { font-size: 15px; font-weight: 700; letter-spacing: -0.3px; }
  .header-sub { font-size: 10px; color: var(--dim); letter-spacing: 0.5px; }

  /* Tabs */
  .tabs { display: flex; align-items: center; gap: 3px; background: rgba(255,255,255,0.03); border-radius: 10px; padding: 3px; }
  .tab-btn {
    padding: 7px 14px; border-radius: 7px; border: none; font-size: 12px; font-weight: 600;
    cursor: pointer; font-family: inherit; display: flex; align-items: center; gap: 5px;
    background: transparent; color: var(--muted); transition: all 0.15s;
  }
  .tab-btn.active { background: rgba(59,130,246,0.2); color: var(--accent); }
  .tab-count {
    font-size: 10px; font-weight: 700; font-family: 'JetBrains Mono', monospace;
    padding: 1px 6px; border-radius: 8px; background: rgba(255,255,255,0.06);
  }
  .tab-btn.active .tab-count { background: rgba(59,130,246,0.3); color: var(--accent); }

  /* Buttons */
  .btn {
    padding: 8px 18px; border: none; border-radius: 8px; font-size: 13px;
    font-weight: 600; cursor: pointer; font-family: inherit; transition: opacity 0.15s;
  }
  .btn:hover { opacity: 0.85; }
  .btn-primary { background: var(--accent); color: #fff; }
  .btn-orange { background: var(--orange); color: #fff; }
  .btn-green { background: var(--green); color: #fff; }
  .btn-purple { background: var(--purple); color: #fff; }
  .btn-red { background: var(--red); color: #fff; }
  .btn-outline {
    padding: 7px 14px; background: transparent; border: 1px solid rgba(59,130,246,0.3);
    border-radius: 8px; font-size: 12px; font-weight: 600; cursor: pointer;
    font-family: inherit; color: var(--accent);
  }
  .btn-outline-red { border-color: rgba(239,68,68,0.3); color: var(--red); }
  .btn-sm { padding: 5px 12px; font-size: 11px; }
  .btn-full { width: 100%; padding: 11px 0; }
  .btn-icon { background: none; border: none; color: var(--dim); cursor: pointer; font-size: 14px; padding: 4px; }

  /* Inputs */
  .input, .select, .textarea {
    width: 100%; padding: 9px 12px; background: rgba(255,255,255,0.04);
    border: 1px solid var(--border-light); border-radius: 8px; color: var(--text);
    font-size: 13px; outline: none; font-family: inherit;
  }
  .select { cursor: pointer; }
  .textarea { min-height: 60px; resize: vertical; }
  .label {
    font-size: 11px; color: var(--muted); margin-bottom: 3px; display: block;
    font-weight: 600; letter-spacing: 0.5px; text-transform: uppercase;
  }

  /* Cards */
  .card { background: var(--card); border: 1px solid var(--border); border-radius: 14px; }
  .card-padded { padding: 20px; }

  /* KPI */
  .kpi-grid { display: flex; gap: 14px; flex-wrap: wrap; margin-bottom: 24px; }
  .kpi {
    background: var(--card); border: 1px solid var(--border); border-radius: 14px;
    padding: 20px 22px; flex: 1; min-width: 155; position: relative; overflow: hidden;
  }
  .kpi-bar { position: absolute; top: 0; left: 0; width: 3px; height: 100%; border-radius: 14px 0 0 14px; }
  .kpi-label { font-size: 10px; text-transform: uppercase; letter-spacing: 1.5px; color: var(--muted); font-weight: 600; }
  .kpi-value { font-size: 30px; font-weight: 700; margin-top: 5px; }
  .kpi-sub { font-size: 11px; color: var(--dim); margin-top: 3px; }

  /* Badge */
  .badge { display: inline-block; padding: 3px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; }

  /* Table rows */
  .table-container { background: var(--card); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; }
  .table-row {
    display: grid; padding: 12px 18px; border-bottom: 1px solid var(--border);
    align-items: center; cursor: pointer; transition: background 0.1s;
  }
  .table-row:hover { background: var(--card-hover); }

  /* Modal */
  .modal-overlay {
    position: fixed; inset: 0; background: rgba(0,0,0,0.7); backdrop-filter: blur(6px);
    display: flex; align-items: center; justify-content: center; z-index: 1000;
  }
  .modal {
    background: #111827; border: 1px solid var(--border-light); border-radius: 16px;
    padding: 28px 30px; max-width: 94vw; max-height: 88vh; overflow-y: auto;
  }
  .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 22px; }
  .modal-title { font-size: 18px; font-weight: 700; }

  /* Form grid */
  .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
  .form-span { grid-column: 1 / -1; }

  /* Filters */
  .filters { display: flex; gap: 10px; margin-bottom: 18px; flex-wrap: wrap; align-items: center; }
  .filter-group { display: flex; gap: 3px; background: rgba(255,255,255,0.03); border-radius: 8px; padding: 3px; }
  .filter-btn {
    padding: 5px 13px; border-radius: 6px; border: none; font-size: 11px;
    font-weight: 600; cursor: pointer; font-family: inherit;
    background: transparent; color: var(--muted);
  }
  .filter-btn.active { background: rgba(59,130,246,0.2); color: var(--accent); }
  .spacer { flex: 1; }

  /* Alert box */
  .alert {
    padding: 16px 20px; border-radius: 12px; margin-bottom: 24px;
  }
  .alert-red { background: rgba(239,68,68,0.06); border: 1px solid rgba(239,68,68,0.15); }
  .alert-title { font-size: 14px; font-weight: 700; margin-bottom: 10px; }

  /* Empty */
  .empty { padding: 48px; text-align: center; color: var(--dim); font-size: 14px; }

  /* Grid layouts */
  .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 18px; }
  .grid-span { grid-column: 1 / -1; }

  /* Bar chart */
  .bar-track { height: 6px; background: rgba(255,255,255,0.04); border-radius: 3px; }
  .bar-fill { height: 100%; border-radius: 3px; transition: width 0.4s; }

  /* Kanban */
  .kanban { display: flex; gap: 12px; overflow-x: auto; padding-bottom: 10px; }
  .kanban-col { min-width: 200px; flex: 1; }
  .kanban-title { font-size: 12px; font-weight: 700; margin-bottom: 10px; padding: 0 4px; }
  .kanban-card {
    padding: 14px; background: var(--card); border: 1px solid var(--border);
    border-radius: 10px; margin-bottom: 8px; cursor: pointer; transition: border-color 0.15s;
  }
  .kanban-card:hover { border-color: rgba(59,130,246,0.3); }

  /* Setup */
  .setup { min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px; }
  .setup-box { width: 580px; max-width: 100%; }
  .setup-header { text-align: center; margin-bottom: 36px; }
  .setup-icon { font-size: 42px; margin-bottom: 12px; }
  .setup-title { font-size: 24px; font-weight: 700; }
  .setup-sub { color: var(--muted); font-size: 14px; margin-top: 6px; }
  .step-item {
    display: flex; gap: 14px; margin-bottom: 14px; padding: 10px 12px;
    border-radius: 10px; cursor: pointer; border: 1px solid transparent;
  }
  .step-item.active { background: rgba(59,130,246,0.07); border-color: rgba(59,130,246,0.2); }
  .step-num {
    width: 28px; height: 28px; border-radius: 50%; flex-shrink: 0;
    display: flex; align-items: center; justify-content: center;
    font-size: 13px; font-weight: 700; background: rgba(255,255,255,0.06); color: var(--muted);
  }
  .step-item.active .step-num { background: var(--accent); color: #fff; }
  .step-title { font-size: 13px; font-weight: 600; }
  .step-desc { font-size: 12px; color: var(--muted); margin-top: 4px; line-height: 1.5; }
  .error-box {
    padding: 10px 14px; background: rgba(239,68,68,0.08); border: 1px solid rgba(239,68,68,0.2);
    border-radius: 8px; color: var(--red); font-size: 12px; margin-bottom: 14px;
  }

  /* Responsive */
  @media (max-width: 900px) {
    .header { flex-wrap: wrap; gap: 10px; }
    .tabs { flex-wrap: wrap; }
    .grid-2 { grid-template-columns: 1fr; }
    .kpi-grid { flex-direction: column; }
  }
  @media (max-width: 600px) {
    .header { padding: 10px 14px; }
    main { padding: 14px !important; }
    .table-row { font-size: 11px; padding: 10px 12px; }
  }
</style>
</head>
<body>
<div id="app"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>

<script type="text/babel">
const { useState, useEffect, useCallback } = React;

// ============================================================
// SUPABASE API
// ============================================================
const createApi = (url, key) => {
  const headers = {
    apikey: key, Authorization: `Bearer ${key}`,
    "Content-Type": "application/json", Prefer: "return=representation",
  };
  const base = `${url}/rest/v1`;
  return {
    async select(table, query = "") {
      const r = await fetch(`${base}/${table}?${query}`, { headers });
      if (!r.ok) throw new Error(`GET ${table}: ${r.statusText}`);
      return r.json();
    },
    async insert(table, data) {
      const r = await fetch(`${base}/${table}`, { method: "POST", headers, body: JSON.stringify(data) });
      if (!r.ok) { const e = await r.json(); throw new Error(e.message || r.statusText); }
      return r.json();
    },
    async update(table, id, data) {
      const r = await fetch(`${base}/${table}?id=eq.${id}`, { method: "PATCH", headers, body: JSON.stringify(data) });
      if (!r.ok) throw new Error(`PATCH ${table}: ${r.statusText}`);
      return r.json();
    },
    async remove(table, id) {
      const r = await fetch(`${base}/${table}?id=eq.${id}`, { method: "DELETE", headers });
      if (!r.ok) throw new Error(`DELETE ${table}: ${r.statusText}`);
      return true;
    },
  };
};

// ============================================================
// CONSTANTS
// ============================================================
const DOMAINES = ["PEL","OPS","AIR","ANS","AIG","LEG","ORG","AGA"];
const TYPES_AUDIT = ["Interne","Externe","Suivi","Sp√©cial"];
const STATUTS_AUDIT = ["Planifi√©","En cours","Rapport √©mis","En suivi","Cl√¥tur√©"];
const CLASSEMENTS = ["NC","PC","OBS","OFI"];
const CRITICITES = ["Bloquant","Majeur","Mineur"];
const STATUTS_FINDING = ["Ouvert","CAPA demand√©e","CAPA accept√©e","En cours","V√©rification","Cl√¥tur√©"];
const STATUTS_CAPA = ["Brouillon","Soumise","Accept√©e","En cours","R√©alis√©e","V√©rifi√©e efficace","Rejet√©e"];
const TYPES_PREUVE = ["Proc√©dure","Enregistrement","Formation","Capture","Email","Rapport","Autre"];
const STATUTS_PREUVE = ["Soumise","Accept√©e","Refus√©e"];

const STATUS_COLORS = {
  "Planifi√©":"#3B82F6","En cours":"#F59E0B","Rapport √©mis":"#A78BFA","En suivi":"#22D3EE","Cl√¥tur√©":"#10B981",
  "Ouvert":"#EF4444","CAPA demand√©e":"#F59E0B","CAPA accept√©e":"#22D3EE","V√©rification":"#A78BFA",
  "Brouillon":"rgba(255,255,255,0.4)","Soumise":"#F59E0B","Accept√©e":"#22D3EE",
  "R√©alis√©e":"#10B981","V√©rifi√©e efficace":"#10B981","Rejet√©e":"#EF4444","Refus√©e":"#EF4444",
};
const CRIT_COLORS = {"Bloquant":"#EF4444","Majeur":"#F59E0B","Mineur":"#22D3EE"};
const CLASS_COLORS = {"NC":"#EF4444","PC":"#F59E0B","OBS":"#3B82F6","OFI":"#10B981"};

// ============================================================
// SMALL COMPONENTS
// ============================================================
function Badge({children, color}) {
  return <span className="badge" style={{background:`${color||'#888'}18`, color:color||'#888'}}>{children}</span>;
}
function Tag({label}) { return <Badge color={STATUS_COLORS[label]}>{label}</Badge>; }
function Empty({text}) { return <div className="empty">{text}</div>; }

function KPI({label,value,sub,color}) {
  return (
    <div className="kpi">
      <div className="kpi-bar" style={{background:color}}/>
      <div className="kpi-label">{label}</div>
      <div className="kpi-value mono" style={{color}}>{value}</div>
      {sub && <div className="kpi-sub">{sub}</div>}
    </div>
  );
}

function Modal({onClose,title,width,children}) {
  return (
    <div className="modal-overlay" onClick={onClose}>
      <div className="modal" style={{width:width||540}} onClick={e=>e.stopPropagation()}>
        <div className="modal-header">
          <h3 className="modal-title">{title}</h3>
          <button className="btn-icon" onClick={onClose} style={{fontSize:20}}>‚úï</button>
        </div>
        {children}
      </div>
    </div>
  );
}

function Field({label,span,children}) {
  return <div className={span?"form-span":""}><label className="label">{label}</label>{children}</div>;
}

function Sel({value,onChange,options,className=""}) {
  return (
    <select className={`select ${className}`} value={value} onChange={e=>onChange(e.target.value)}>
      {options.map(o=><option key={o} value={o}>{o}</option>)}
    </select>
  );
}

function ConfirmDelete({item,onConfirm,onCancel}) {
  return (
    <Modal onClose={onCancel} title="Confirmer la suppression" width={400}>
      <p style={{color:'var(--muted)',fontSize:14,lineHeight:1.6}}>
        Supprimer <strong style={{color:'var(--red)'}}>{item}</strong> ? Cette action est irr√©versible.
      </p>
      <div style={{display:'flex',gap:10,justifyContent:'flex-end',marginTop:20}}>
        <button className="btn btn-outline" onClick={onCancel}>Annuler</button>
        <button className="btn btn-red" onClick={onConfirm}>Supprimer</button>
      </div>
    </Modal>
  );
}

// ============================================================
// SETUP
// ============================================================
function SetupScreen({onConnect}) {
  const [url,setUrl] = useState(localStorage.getItem('sb_url')||'');
  const [key,setKey] = useState(localStorage.getItem('sb_key')||'');
  const [loading,setLoading] = useState(false);
  const [error,setError] = useState('');
  const [step,setStep] = useState(4);

  const steps = [
    {n:1,title:"Cr√©er un compte GitHub",desc:"Allez sur github.com et cr√©ez un compte gratuit."},
    {n:2,title:"Cr√©er un projet Supabase",desc:"supabase.com ‚Üí Sign in avec GitHub ‚Üí New Project ‚Üí Nom: dgac-audits ‚Üí R√©gion: West EU."},
    {n:3,title:"Cr√©er les tables",desc:"SQL Editor ‚Üí New Query ‚Üí Collez le script SQL ‚Üí Run."},
    {n:4,title:"Copier les cl√©s",desc:"Settings ‚Üí API ‚Üí Copiez 'Project URL' et 'anon public key' ci-dessous."},
  ];

  const handleConnect = async () => {
    if(!url||!key){setError("Les deux champs sont obligatoires");return;}
    setLoading(true);setError('');
    try {
      const api = createApi(url.replace(/\/$/,''), key);
      await api.select("audits","limit=1");
      localStorage.setItem('sb_url', url.replace(/\/$/,''));
      localStorage.setItem('sb_key', key);
      onConnect(url.replace(/\/$/,''), key);
    } catch(e) {
      setError("Connexion √©chou√©e : " + e.message);
    }
    setLoading(false);
  };

  return (
    <div className="setup">
      <div className="setup-box">
        <div className="setup-header">
          <div className="setup-icon">‚úàÔ∏è</div>
          <h1 className="setup-title">DGAC ‚Äî Suivi des Audits</h1>
          <p className="setup-sub">Configuration de la connexion Supabase</p>
        </div>
        <div className="card card-padded" style={{marginBottom:24}}>
          <div style={{fontSize:14,fontWeight:700,marginBottom:16}}>üìñ Guide pas √† pas</div>
          {steps.map(s=>(
            <div key={s.n} className={`step-item ${step===s.n?'active':''}`} onClick={()=>setStep(s.n)}>
              <div className="step-num">{s.n}</div>
              <div>
                <div className="step-title">{s.title}</div>
                {step===s.n && <div className="step-desc">{s.desc}</div>}
              </div>
            </div>
          ))}
        </div>
        <div className="card card-padded">
          <div style={{fontSize:14,fontWeight:700,marginBottom:16}}>üîó Connexion</div>
          <div style={{marginBottom:14}}>
            <label className="label">Project URL</label>
            <input className="input" value={url} onChange={e=>setUrl(e.target.value)} placeholder="https://xxxxx.supabase.co"/>
          </div>
          <div style={{marginBottom:14}}>
            <label className="label">Anon Public Key</label>
            <input className="input" value={key} onChange={e=>setKey(e.target.value)} placeholder="eyJhbGciOi..."/>
          </div>
          {error && <div className="error-box">{error}</div>}
          <button className="btn btn-primary btn-full" onClick={handleConnect} disabled={loading}
            style={{opacity:loading?0.6:1, background:'linear-gradient(135deg,#3B82F6,#1D4ED8)'}}>
            {loading ? "Connexion en cours..." : "Se connecter"}
          </button>
        </div>
      </div>
    </div>
  );
}

// ============================================================
// DASHBOARD
// ============================================================
function Dashboard({audits,findings,capa,preuves,onNav}) {
  const today = new Date().toISOString().slice(0,10);
  const open = findings.filter(f=>f.statut!=="Cl√¥tur√©");
  const overdue = open.filter(f=>f.echeance && f.echeance<today);
  const bloquants = open.filter(f=>f.criticite==="Bloquant");
  const aValider = preuves.filter(p=>p.statut==="Soumise");
  const actifs = audits.filter(a=>["En cours","Rapport √©mis","En suivi"].includes(a.statut));

  const byDomaine = {};
  findings.forEach(f=>{
    const a = audits.find(au=>au.id===f.audit_uuid);
    const d = a?.domaine||"?";
    byDomaine[d]=(byDomaine[d]||0)+1;
  });
  const domSorted = Object.entries(byDomaine).sort((a,b)=>b[1]-a[1]);
  const maxD = domSorted.length>0?domSorted[0][1]:1;

  return (
    <div>
      <div className="kpi-grid">
        <KPI label="Audits actifs" value={actifs.length} sub={`${audits.length} total`} color="#3B82F6"/>
        <KPI label="√âcarts ouverts" value={open.length} sub={`${findings.length} total`} color="#F59E0B"/>
        <KPI label="Bloquants" value={bloquants.length} sub="Criticit√© haute" color="#EF4444"/>
        <KPI label="En retard" value={overdue.length} sub="√âch√©ance d√©pass√©e" color="#EF4444"/>
        <KPI label="Preuves √† valider" value={aValider.length} sub={`${preuves.length} total`} color="#A78BFA"/>
      </div>

      {overdue.length>0 && (
        <div className="alert alert-red">
          <div className="alert-title" style={{color:'var(--red)'}}>‚ö† Top {Math.min(overdue.length,10)} retards</div>
          {overdue.sort((a,b)=>{
            const da=Math.ceil((new Date(today)-new Date(a.echeance))/86400000);
            const db=Math.ceil((new Date(today)-new Date(b.echeance))/86400000);
            return db-da;
          }).slice(0,10).map((f,i)=>{
            const days=Math.ceil((new Date(today)-new Date(f.echeance))/86400000);
            const au=audits.find(a=>a.id===f.audit_uuid);
            return (
              <div key={i} style={{display:'flex',justifyContent:'space-between',alignItems:'center',padding:'6px 0',borderBottom:i<9?'1px solid var(--border)':'none'}}>
                <div style={{fontSize:13,color:'rgba(255,255,255,0.6)'}}>
                  <span className="mono" style={{color:'var(--dim)',fontSize:11,marginRight:8}}>{f.finding_id}</span>
                  {au?.entite} ‚Äî {f.titre?.slice(0,50)}{f.titre?.length>50?"‚Ä¶":""}
                </div>
                <Badge color="#EF4444">{days}j retard</Badge>
              </div>
            );
          })}
        </div>
      )}

      <div className="grid-2">
        <div className="card card-padded">
          <div style={{fontSize:13,fontWeight:700,marginBottom:16}}>√âcarts ouverts par criticit√©</div>
          {CRITICITES.map(c=>{
            const count=open.filter(f=>f.criticite===c).length;
            const pct=open.length>0?(count/open.length)*100:0;
            return (
              <div key={c} style={{marginBottom:12}}>
                <div style={{display:'flex',justifyContent:'space-between',fontSize:12,marginBottom:4}}>
                  <span style={{color:CRIT_COLORS[c],fontWeight:600}}>{c}</span>
                  <span className="mono" style={{color:'var(--muted)'}}>{count}</span>
                </div>
                <div className="bar-track"><div className="bar-fill" style={{width:`${pct}%`,background:CRIT_COLORS[c]}}/></div>
              </div>
            );
          })}
        </div>
        <div className="card card-padded">
          <div style={{fontSize:13,fontWeight:700,marginBottom:16}}>R√©currence par domaine</div>
          {domSorted.length===0 && <div style={{color:'var(--dim)',fontSize:13}}>Aucune donn√©e</div>}
          {domSorted.map(([dom,count])=>(
            <div key={dom} style={{display:'flex',alignItems:'center',gap:12,marginBottom:10}}>
              <span className="mono" style={{width:36,fontSize:12,fontWeight:700,color:'var(--accent)'}}>{dom}</span>
              <div className="bar-track" style={{flex:1}}><div className="bar-fill" style={{width:`${(count/maxD)*100}%`,background:'var(--accent)'}}/></div>
              <span className="mono" style={{fontSize:12,color:'var(--muted)',width:24,textAlign:'right'}}>{count}</span>
            </div>
          ))}
        </div>
        <div className="card card-padded grid-span">
          <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:14}}>
            <span style={{fontSize:13,fontWeight:700}}>Audits actifs</span>
            <button className="btn-outline btn-sm" onClick={()=>onNav("audits")}>Voir tout ‚Üí</button>
          </div>
          {actifs.length===0 && <div style={{color:'var(--dim)',fontSize:13}}>Aucun audit actif</div>}
          {actifs.slice(0,6).map(a=>{
            const af=findings.filter(f=>f.audit_uuid===a.id);
            const op=af.filter(f=>f.statut!=="Cl√¥tur√©").length;
            return (
              <div key={a.id} style={{display:'flex',justifyContent:'space-between',alignItems:'center',padding:'10px 0',borderBottom:'1px solid var(--border)'}}>
                <div>
                  <span className="mono" style={{fontSize:11,color:'var(--dim)',marginRight:10}}>{a.audit_id}</span>
                  <span style={{fontSize:13,fontWeight:500}}>{a.entite}</span>
                </div>
                <div style={{display:'flex',gap:8,alignItems:'center'}}>
                  <Tag label={a.statut}/>
                  {op>0 && <Badge color="#F59E0B">{op} ouvert{op>1?"s":""}</Badge>}
                </div>
              </div>
            );
          })}
        </div>
      </div>
    </div>
  );
}

// ============================================================
// AUDIT FORM
// ============================================================
function AuditForm({audit,onClose,onSave}) {
  const [f,setF]=useState(audit||{
    audit_id:"",domaine:"OPS",entite:"",type_audit:"Interne",
    date_debut:"",date_fin:"",statut:"Planifi√©",equipe:"",cycle_surveillance:"",notes:"",
  });
  return (
    <Modal onClose={onClose} title={audit?`Modifier ${audit.audit_id}`:"Nouvel Audit"}>
      <div className="form-grid">
        <Field label="Audit ID *"><input className="input" value={f.audit_id} onChange={e=>setF({...f,audit_id:e.target.value})} placeholder="2026-PEL-003"/></Field>
        <Field label="Domaine"><Sel value={f.domaine} onChange={v=>setF({...f,domaine:v})} options={DOMAINES}/></Field>
        <Field label="Entit√© audit√©e *" span><input className="input" value={f.entite} onChange={e=>setF({...f,entite:e.target.value})}/></Field>
        <Field label="Type"><Sel value={f.type_audit} onChange={v=>setF({...f,type_audit:v})} options={TYPES_AUDIT}/></Field>
        <Field label="Statut"><Sel value={f.statut} onChange={v=>setF({...f,statut:v})} options={STATUTS_AUDIT}/></Field>
        <Field label="Date d√©but"><input type="date" className="input" value={f.date_debut||""} onChange={e=>setF({...f,date_debut:e.target.value})}/></Field>
        <Field label="Date fin"><input type="date" className="input" value={f.date_fin||""} onChange={e=>setF({...f,date_fin:e.target.value})}/></Field>
        <Field label="√âquipe"><input className="input" value={f.equipe||""} onChange={e=>setF({...f,equipe:e.target.value})}/></Field>
        <Field label="Cycle surveillance"><input className="input" value={f.cycle_surveillance||""} onChange={e=>setF({...f,cycle_surveillance:e.target.value})} placeholder="Annuel / Semestriel"/></Field>
        <Field label="Notes" span><textarea className="textarea" value={f.notes||""} onChange={e=>setF({...f,notes:e.target.value})}/></Field>
      </div>
      <button className="btn btn-primary btn-full" style={{marginTop:18}} onClick={()=>onSave(f)}>
        {audit?"Enregistrer":"Cr√©er l'audit"}
      </button>
    </Modal>
  );
}

// ============================================================
// AUDITS VIEW
// ============================================================
function AuditsView({api,audits,findings,reload}) {
  const [showForm,setShowForm]=useState(false);
  const [editing,setEditing]=useState(null);
  const [filter,setFilter]=useState("Tous");
  const [search,setSearch]=useState("");
  const [deleting,setDeleting]=useState(null);

  const filtered=audits.filter(a=>{
    if(filter!=="Tous"&&a.statut!==filter)return false;
    if(search&&!a.entite.toLowerCase().includes(search.toLowerCase())&&!a.audit_id.toLowerCase().includes(search.toLowerCase()))return false;
    return true;
  });

  const handleSave=async(data)=>{
    try{
      if(editing)await api.update("audits",editing.id,data);
      else await api.insert("audits",data);
      setShowForm(false);setEditing(null);reload();
    }catch(e){alert("Erreur: "+e.message);}
  };
  const handleDelete=async()=>{
    if(deleting){try{await api.remove("audits",deleting.id);}catch(e){alert("Erreur: "+e.message);}setDeleting(null);reload();}
  };

  return (
    <div>
      <div className="filters">
        <input className="input" value={search} onChange={e=>setSearch(e.target.value)} placeholder="Rechercher..." style={{width:240}}/>
        <div className="filter-group">
          {["Tous",...STATUTS_AUDIT].map(s=>(
            <button key={s} className={`filter-btn ${filter===s?'active':''}`} onClick={()=>setFilter(s)}>{s}</button>
          ))}
        </div>
        <div className="spacer"/>
        <button className="btn btn-primary" onClick={()=>{setEditing(null);setShowForm(true);}}>+ Nouvel Audit</button>
      </div>
      <div className="table-container">
        {filtered.map(a=>{
          const af=findings.filter(f=>f.audit_uuid===a.id);
          const op=af.filter(f=>f.statut!=="Cl√¥tur√©").length;
          return (
            <div key={a.id} className="table-row" style={{gridTemplateColumns:'110px 1fr 80px 90px 100px 70px 40px'}}
              onClick={()=>{setEditing(a);setShowForm(true);}}>
              <span className="mono" style={{fontSize:11,color:'var(--dim)'}}>{a.audit_id}</span>
              <div>
                <div style={{fontSize:13,fontWeight:600}}>{a.entite}</div>
                <div style={{fontSize:11,color:'var(--dim)',marginTop:1}}>{a.equipe} ‚Ä¢ {a.date_debut||"‚Äî"}</div>
              </div>
              <Badge color="#A78BFA">{a.domaine}</Badge>
              <span style={{fontSize:12,color:'var(--muted)'}}>{a.type_audit}</span>
              <Tag label={a.statut}/>
              <div style={{fontSize:12}}><span style={{color:'var(--orange)'}}>{op}</span><span style={{color:'var(--dim)'}}> / {af.length}</span></div>
              <button className="btn-icon" onClick={e=>{e.stopPropagation();setDeleting(a);}}>üóë</button>
            </div>
          );
        })}
        {filtered.length===0&&<Empty text="Aucun audit trouv√©"/>}
      </div>
      {showForm&&<AuditForm audit={editing} onClose={()=>{setShowForm(false);setEditing(null);}} onSave={handleSave}/>}
      {deleting&&<ConfirmDelete item={deleting.audit_id} onConfirm={handleDelete} onCancel={()=>setDeleting(null)}/>}
    </div>
  );
}

// ============================================================
// FINDING FORM
// ============================================================
function FindingForm({finding,audits,onClose,onSave}) {
  const [f,setF]=useState(finding||{
    finding_id:"",audit_uuid:audits[0]?.id||"",titre:"",constat:"",
    reference_regl:"",classement:"OBS",criticite:"Mineur",echeance:"",statut:"Ouvert",cause_racine:"",
  });
  return (
    <Modal onClose={onClose} title={finding?`Modifier ${finding.finding_id}`:"Nouvel √âcart"} width={580}>
      <div className="form-grid">
        <Field label="Finding ID *"><input className="input" value={f.finding_id} onChange={e=>setF({...f,finding_id:e.target.value})} placeholder="F-2026-PEL-003-01"/></Field>
        <Field label="Audit li√©">
          <select className="select" value={f.audit_uuid||""} onChange={e=>setF({...f,audit_uuid:e.target.value})}>
            <option value="">‚Äî S√©lectionner ‚Äî</option>
            {audits.map(a=><option key={a.id} value={a.id}>{a.audit_id} ‚Äî {a.entite}</option>)}
          </select>
        </Field>
        <Field label="Titre *" span><input className="input" value={f.titre} onChange={e=>setF({...f,titre:e.target.value})}/></Field>
        <Field label="Constat objectif" span><textarea className="textarea" value={f.constat||""} onChange={e=>setF({...f,constat:e.target.value})}/></Field>
        <Field label="R√©f√©rence r√©glementaire"><input className="input" value={f.reference_regl||""} onChange={e=>setF({...f,reference_regl:e.target.value})} placeholder="Part-ORA.GEN.200"/></Field>
        <Field label="Classement"><Sel value={f.classement} onChange={v=>setF({...f,classement:v})} options={CLASSEMENTS}/></Field>
        <Field label="Criticit√©"><Sel value={f.criticite} onChange={v=>setF({...f,criticite:v})} options={CRITICITES}/></Field>
        <Field label="Statut"><Sel value={f.statut} onChange={v=>setF({...f,statut:v})} options={STATUTS_FINDING}/></Field>
        <Field label="√âch√©ance"><input type="date" className="input" value={f.echeance||""} onChange={e=>setF({...f,echeance:e.target.value})}/></Field>
        <Field label="Cause racine"><input className="input" value={f.cause_racine||""} onChange={e=>setF({...f,cause_racine:e.target.value})}/></Field>
      </div>
      <button className="btn btn-orange btn-full" style={{marginTop:18}} onClick={()=>onSave(f)}>
        {finding?"Enregistrer":"Cr√©er l'√©cart"}
      </button>
    </Modal>
  );
}

// ============================================================
// FINDINGS VIEW
// ============================================================
function FindingsView({api,audits,findings,preuves,reload}) {
  const [showForm,setShowForm]=useState(false);
  const [editing,setEditing]=useState(null);
  const [filter,setFilter]=useState("Tous");
  const [critFilter,setCritFilter]=useState("Tous");
  const [deleting,setDeleting]=useState(null);
  const today=new Date().toISOString().slice(0,10);

  const filtered=findings.filter(f=>{
    if(filter==="En retard")return f.statut!=="Cl√¥tur√©"&&f.echeance&&f.echeance<today;
    if(filter==="Bloquants")return f.criticite==="Bloquant"&&f.statut!=="Cl√¥tur√©";
    if(filter==="Pr√™ts √† cl√¥turer"){
      const fp=preuves.filter(p=>p.finding_uuid===f.id&&p.statut==="Accept√©e");
      return f.statut==="V√©rification"&&fp.length>=1;
    }
    if(filter!=="Tous"&&f.statut!==filter)return false;
    if(critFilter!=="Tous"&&f.criticite!==critFilter)return false;
    return true;
  });

  const handleSave=async(data)=>{
    try{
      if(editing)await api.update("findings",editing.id,data);
      else await api.insert("findings",data);
      setShowForm(false);setEditing(null);reload();
    }catch(e){alert("Erreur: "+e.message);}
  };
  const handleDelete=async()=>{
    if(deleting){try{await api.remove("findings",deleting.id);}catch(e){alert("Erreur: "+e.message);}setDeleting(null);reload();}
  };

  return (
    <div>
      <div className="filters">
        <div className="filter-group">
          {["Tous","Ouvert","En cours","V√©rification","Cl√¥tur√©","En retard","Bloquants","Pr√™ts √† cl√¥turer"].map(s=>(
            <button key={s} className={`filter-btn ${filter===s?'active':''}`} onClick={()=>setFilter(s)}>{s}</button>
          ))}
        </div>
        <select className="select" style={{width:120,fontSize:11}} value={critFilter} onChange={e=>setCritFilter(e.target.value)}>
          <option value="Tous">Toutes crit.</option>
          {CRITICITES.map(c=><option key={c} value={c}>{c}</option>)}
        </select>
        <div className="spacer"/>
        <button className="btn btn-orange" onClick={()=>{setEditing(null);setShowForm(true);}}>+ Nouvel √âcart</button>
      </div>
      <div className="table-container">
        {filtered.map(f=>{
          const audit=audits.find(a=>a.id===f.audit_uuid);
          const isOv=f.statut!=="Cl√¥tur√©"&&f.echeance&&f.echeance<today;
          return (
            <div key={f.id} className="table-row" style={{gridTemplateColumns:'130px 1fr 55px 75px 100px 85px 40px',borderLeft:isOv?'3px solid var(--red)':'3px solid transparent'}}
              onClick={()=>{setEditing(f);setShowForm(true);}}>
              <span className="mono" style={{fontSize:11,color:'var(--dim)'}}>{f.finding_id}</span>
              <div>
                <div style={{fontSize:13,fontWeight:600}}>{f.titre}</div>
                <div style={{fontSize:11,color:'var(--dim)',marginTop:1}}>{audit?.entite||"‚Äî"} ‚Ä¢ {f.reference_regl||"‚Äî"}</div>
              </div>
              <Badge color={CLASS_COLORS[f.classement]}>{f.classement}</Badge>
              <Badge color={CRIT_COLORS[f.criticite]}>{f.criticite}</Badge>
              <Tag label={f.statut}/>
              <span style={{fontSize:11,color:isOv?'var(--red)':'var(--dim)'}}>{f.echeance||"‚Äî"} {isOv?"‚ö†":""}</span>
              <button className="btn-icon" onClick={e=>{e.stopPropagation();setDeleting(f);}}>üóë</button>
            </div>
          );
        })}
        {filtered.length===0&&<Empty text="Aucun √©cart trouv√©"/>}
      </div>
      {showForm&&<FindingForm finding={editing} audits={audits} onClose={()=>{setShowForm(false);setEditing(null);}} onSave={handleSave}/>}
      {deleting&&<ConfirmDelete item={deleting.finding_id} onConfirm={handleDelete} onCancel={()=>setDeleting(null)}/>}
    </div>
  );
}

// ============================================================
// CAPA FORM
// ============================================================
function CapaForm({capa,findings,onClose,onSave}) {
  const [f,setF]=useState(capa||{
    action_id:"",finding_uuid:findings[0]?.id||"",action_corrective:"",action_preventive:"",
    responsable:"",echeance:"",statut:"Brouillon",avancement:0,cause_racine_detail:"",commentaire_verif:"",
  });
  return (
    <Modal onClose={onClose} title={capa?`Modifier ${capa.action_id}`:"Nouvelle CAPA"} width={580}>
      <div className="form-grid">
        <Field label="Action ID *"><input className="input" value={f.action_id} onChange={e=>setF({...f,action_id:e.target.value})} placeholder="A-2026-PEL-003-01"/></Field>
        <Field label="Finding li√©">
          <select className="select" value={f.finding_uuid||""} onChange={e=>setF({...f,finding_uuid:e.target.value})}>
            <option value="">‚Äî S√©lectionner ‚Äî</option>
            {findings.map(fi=><option key={fi.id} value={fi.id}>{fi.finding_id} ‚Äî {fi.titre}</option>)}
          </select>
        </Field>
        <Field label="Action corrective (court terme)" span><textarea className="textarea" value={f.action_corrective||""} onChange={e=>setF({...f,action_corrective:e.target.value})}/></Field>
        <Field label="Action pr√©ventive (long terme)" span><textarea className="textarea" value={f.action_preventive||""} onChange={e=>setF({...f,action_preventive:e.target.value})}/></Field>
        <Field label="Responsable"><input className="input" value={f.responsable||""} onChange={e=>setF({...f,responsable:e.target.value})}/></Field>
        <Field label="√âch√©ance"><input type="date" className="input" value={f.echeance||""} onChange={e=>setF({...f,echeance:e.target.value})}/></Field>
        <Field label="Statut"><Sel value={f.statut} onChange={v=>setF({...f,statut:v})} options={STATUTS_CAPA}/></Field>
        <Field label="% Avancement"><input type="number" className="input" min={0} max={100} value={f.avancement} onChange={e=>setF({...f,avancement:Number(e.target.value)})}/></Field>
        <Field label="Cause racine (d√©tail)" span><textarea className="textarea" value={f.cause_racine_detail||""} onChange={e=>setF({...f,cause_racine_detail:e.target.value})}/></Field>
        <Field label="Commentaire v√©rification" span><textarea className="textarea" value={f.commentaire_verif||""} onChange={e=>setF({...f,commentaire_verif:e.target.value})}/></Field>
      </div>
      <button className="btn btn-green btn-full" style={{marginTop:18}} onClick={()=>onSave(f)}>
        {capa?"Enregistrer":"Cr√©er l'action"}
      </button>
    </Modal>
  );
}

// ============================================================
// CAPA VIEW
// ============================================================
function CapaView({api,findings,capas,reload}) {
  const [showForm,setShowForm]=useState(false);
  const [editing,setEditing]=useState(null);
  const [view,setView]=useState("list");
  const [deleting,setDeleting]=useState(null);

  const handleSave=async(data)=>{
    try{
      if(editing)await api.update("capa",editing.id,data);
      else await api.insert("capa",data);
      setShowForm(false);setEditing(null);reload();
    }catch(e){alert("Erreur: "+e.message);}
  };
  const handleDelete=async()=>{
    if(deleting){try{await api.remove("capa",deleting.id);}catch(e){alert("Erreur: "+e.message);}setDeleting(null);reload();}
  };

  const kanbanCols=["Brouillon","Soumise","Accept√©e","En cours","R√©alis√©e","V√©rifi√©e efficace"];

  return (
    <div>
      <div className="filters">
        <div className="filter-group">
          <button className={`filter-btn ${view==="list"?'active':''}`} onClick={()=>setView("list")}>Liste</button>
          <button className={`filter-btn ${view==="kanban"?'active':''}`} onClick={()=>setView("kanban")}>Kanban</button>
        </div>
        <div className="spacer"/>
        <button className="btn btn-green" onClick={()=>{setEditing(null);setShowForm(true);}}>+ Nouvelle Action</button>
      </div>

      {view==="kanban"?(
        <div className="kanban">
          {kanbanCols.map(col=>(
            <div key={col} className="kanban-col">
              <div className="kanban-title" style={{color:STATUS_COLORS[col]||'var(--muted)'}}>
                {col} <span style={{color:'var(--dim)'}}>({capas.filter(c=>c.statut===col).length})</span>
              </div>
              {capas.filter(c=>c.statut===col).map(c=>{
                const fi=findings.find(f=>f.id===c.finding_uuid);
                return (
                  <div key={c.id} className="kanban-card" onClick={()=>{setEditing(c);setShowForm(true);}}>
                    <div className="mono" style={{fontSize:10,color:'var(--dim)'}}>{c.action_id}</div>
                    <div style={{fontSize:12,fontWeight:500,marginTop:4}}>{fi?.titre||"‚Äî"}</div>
                    <div style={{marginTop:8,display:'flex',justifyContent:'space-between',alignItems:'center'}}>
                      <span style={{fontSize:11,color:'var(--muted)'}}>{c.responsable||"‚Äî"}</span>
                      <span className="mono" style={{fontSize:11,color:'var(--accent)',fontWeight:700}}>{c.avancement}%</span>
                    </div>
                  </div>
                );
              })}
            </div>
          ))}
        </div>
      ):(
        <div className="table-container">
          {capas.map(c=>{
            const fi=findings.find(f=>f.id===c.finding_uuid);
            return (
              <div key={c.id} className="table-row" style={{gridTemplateColumns:'120px 1fr 100px 100px 60px 40px'}}
                onClick={()=>{setEditing(c);setShowForm(true);}}>
                <span className="mono" style={{fontSize:11,color:'var(--dim)'}}>{c.action_id}</span>
                <div>
                  <div style={{fontSize:13,fontWeight:500}}>{c.action_corrective?.slice(0,60)||"‚Äî"}</div>
                  <div style={{fontSize:11,color:'var(--dim)',marginTop:1}}>{fi?.finding_id} ‚Äî {fi?.titre?.slice(0,40)||"‚Äî"}</div>
                </div>
                <span style={{fontSize:12,color:'var(--muted)'}}>{c.responsable||"‚Äî"}</span>
                <Tag label={c.statut}/>
                <span className="mono" style={{fontSize:12,color:'var(--accent)'}}>{c.avancement}%</span>
                <button className="btn-icon" onClick={e=>{e.stopPropagation();setDeleting(c);}}>üóë</button>
              </div>
            );
          })}
          {capas.length===0&&<Empty text="Aucune action corrective"/>}
        </div>
      )}
      {showForm&&<CapaForm capa={editing} findings={findings} onClose={()=>{setShowForm(false);setEditing(null);}} onSave={handleSave}/>}
      {deleting&&<ConfirmDelete item={deleting.action_id} onConfirm={handleDelete} onCancel={()=>setDeleting(null)}/>}
    </div>
  );
}

// ============================================================
// PREUVE FORM
// ============================================================
function PreuveForm({preuve,findings,capas,onClose,onSave}) {
  const [f,setF]=useState(preuve||{
    evidence_id:"",finding_uuid:"",capa_uuid:"",type_preuve:"Autre",
    fichier_url:"",version:"v1.0",date_preuve:new Date().toISOString().slice(0,10),
    statut:"Soumise",motif_refus:"",date_expiration:"",
  });
  return (
    <Modal onClose={onClose} title={preuve?`Modifier ${preuve.evidence_id}`:"Nouvelle Preuve"} width={520}>
      <div className="form-grid">
        <Field label="Evidence ID *"><input className="input" value={f.evidence_id} onChange={e=>setF({...f,evidence_id:e.target.value})} placeholder="E-2026-PEL-003-01-01"/></Field>
        <Field label="Type"><Sel value={f.type_preuve} onChange={v=>setF({...f,type_preuve:v})} options={TYPES_PREUVE}/></Field>
        <Field label="Finding li√©">
          <select className="select" value={f.finding_uuid||""} onChange={e=>setF({...f,finding_uuid:e.target.value})}>
            <option value="">‚Äî Aucun ‚Äî</option>
            {findings.map(fi=><option key={fi.id} value={fi.id}>{fi.finding_id} ‚Äî {fi.titre}</option>)}
          </select>
        </Field>
        <Field label="CAPA li√©e">
          <select className="select" value={f.capa_uuid||""} onChange={e=>setF({...f,capa_uuid:e.target.value})}>
            <option value="">‚Äî Aucune ‚Äî</option>
            {capas.map(c=><option key={c.id} value={c.id}>{c.action_id}</option>)}
          </select>
        </Field>
        <Field label="Lien fichier" span><input className="input" value={f.fichier_url||""} onChange={e=>setF({...f,fichier_url:e.target.value})} placeholder="https://drive.google.com/..."/></Field>
        <Field label="Version"><input className="input" value={f.version||""} onChange={e=>setF({...f,version:e.target.value})}/></Field>
        <Field label="Date preuve"><input type="date" className="input" value={f.date_preuve||""} onChange={e=>setF({...f,date_preuve:e.target.value})}/></Field>
        <Field label="Statut"><Sel value={f.statut} onChange={v=>setF({...f,statut:v})} options={STATUTS_PREUVE}/></Field>
        <Field label="Date expiration"><input type="date" className="input" value={f.date_expiration||""} onChange={e=>setF({...f,date_expiration:e.target.value})}/></Field>
        {f.statut==="Refus√©e"&&<Field label="Motif refus" span><textarea className="textarea" value={f.motif_refus||""} onChange={e=>setF({...f,motif_refus:e.target.value})}/></Field>}
      </div>
      <button className="btn btn-purple btn-full" style={{marginTop:18}} onClick={()=>onSave(f)}>
        {preuve?"Enregistrer":"Ajouter la preuve"}
      </button>
    </Modal>
  );
}

// ============================================================
// PREUVES VIEW
// ============================================================
function PreuvesView({api,findings,capas,preuves,reload}) {
  const [showForm,setShowForm]=useState(false);
  const [editing,setEditing]=useState(null);
  const [filter,setFilter]=useState("Tous");
  const [deleting,setDeleting]=useState(null);

  const filtered=preuves.filter(p=>filter==="Tous"||p.statut===filter);

  const handleSave=async(data)=>{
    try{
      if(editing)await api.update("preuves",editing.id,data);
      else await api.insert("preuves",data);
      setShowForm(false);setEditing(null);reload();
    }catch(e){alert("Erreur: "+e.message);}
  };
  const handleDelete=async()=>{
    if(deleting){try{await api.remove("preuves",deleting.id);}catch(e){alert("Erreur: "+e.message);}setDeleting(null);reload();}
  };

  return (
    <div>
      <div className="filters">
        <div className="filter-group">
          {["Tous",...STATUTS_PREUVE].map(s=>(
            <button key={s} className={`filter-btn ${filter===s?'active':''}`} onClick={()=>setFilter(s)}>{s}</button>
          ))}
        </div>
        <div className="spacer"/>
        <button className="btn btn-purple" onClick={()=>{setEditing(null);setShowForm(true);}}>+ Nouvelle Preuve</button>
      </div>
      <div className="table-container">
        {filtered.map(p=>{
          const fi=findings.find(f=>f.id===p.finding_uuid);
          const ca=capas.find(c=>c.id===p.capa_uuid);
          return (
            <div key={p.id} className="table-row" style={{gridTemplateColumns:'140px 1fr 100px 70px 80px 80px 40px'}}
              onClick={()=>{setEditing(p);setShowForm(true);}}>
              <span className="mono" style={{fontSize:11,color:'var(--dim)'}}>{p.evidence_id}</span>
              <div>
                <div style={{fontSize:12}}>{fi?.finding_id||"‚Äî"} {ca?`/ ${ca.action_id}`:""}</div>
                <div style={{fontSize:11,color:'var(--dim)',marginTop:1}}>{fi?.titre?.slice(0,50)||"‚Äî"}</div>
              </div>
              <Badge color="#22D3EE">{p.type_preuve}</Badge>
              <span className="mono" style={{fontSize:11,color:'var(--dim)'}}>{p.version}</span>
              <Tag label={p.statut}/>
              <span style={{fontSize:11,color:'var(--dim)'}}>{p.date_preuve||"‚Äî"}</span>
              <button className="btn-icon" onClick={e=>{e.stopPropagation();setDeleting(p);}}>üóë</button>
            </div>
          );
        })}
        {filtered.length===0&&<Empty text="Aucune preuve enregistr√©e"/>}
      </div>
      {showForm&&<PreuveForm preuve={editing} findings={findings} capas={capas} onClose={()=>{setShowForm(false);setEditing(null);}} onSave={handleSave}/>}
      {deleting&&<ConfirmDelete item={deleting.evidence_id} onConfirm={handleDelete} onCancel={()=>setDeleting(null)}/>}
    </div>
  );
}

// ============================================================
// MAIN APP
// ============================================================
function App() {
  const [connected,setConnected]=useState(false);
  const [api,setApi]=useState(null);
  const [tab,setTab]=useState("dashboard");
  const [audits,setAudits]=useState([]);
  const [findings,setFindings]=useState([]);
  const [capas,setCapas]=useState([]);
  const [preuves,setPreuves]=useState([]);
  const [loading,setLoading]=useState(false);
  const [error,setError]=useState("");

  const loadAll=useCallback(async(apiRef)=>{
    const a=apiRef||api;
    if(!a)return;
    setLoading(true);setError("");
    try{
      const [au,fi,ca,pr]=await Promise.all([
        a.select("audits","order=created_at.desc"),
        a.select("findings","order=created_at.desc"),
        a.select("capa","order=created_at.desc"),
        a.select("preuves","order=created_at.desc"),
      ]);
      setAudits(au);setFindings(fi);setCapas(ca);setPreuves(pr);
    }catch(e){setError("Erreur: "+e.message);}
    setLoading(false);
  },[api]);

  const handleConnect=(url,key)=>{
    const a=createApi(url,key);
    setApi(a);setConnected(true);loadAll(a);
  };

  useEffect(()=>{
    const u=localStorage.getItem('sb_url');
    const k=localStorage.getItem('sb_key');
    if(u&&k){
      const a=createApi(u,k);
      a.select("audits","limit=1").then(()=>{
        setApi(a);setConnected(true);loadAll(a);
      }).catch(()=>{});
    }
  },[]);

  if(!connected) return <SetupScreen onConnect={handleConnect}/>;

  const tabs=[
    {id:"dashboard",label:"Tableau de bord",icon:"üìä"},
    {id:"audits",label:"Audits",icon:"üìã",count:audits.length},
    {id:"findings",label:"√âcarts",icon:"‚ö†Ô∏è",count:findings.filter(f=>f.statut!=="Cl√¥tur√©").length},
    {id:"capa",label:"CAPA",icon:"üîß",count:capas.length},
    {id:"preuves",label:"Preuves",icon:"üìé",count:preuves.filter(p=>p.statut==="Soumise").length},
  ];

  const handleDisconnect=()=>{
    localStorage.removeItem('sb_url');
    localStorage.removeItem('sb_key');
    setConnected(false);setApi(null);
  };

  return (
    <div>
      <header className="header">
        <div className="header-left">
          <div className="logo">‚úà</div>
          <div>
            <div className="header-title">DGAC ‚Äî Suivi des Audits</div>
            <div className="header-sub">Direction G√©n√©rale de l'Aviation Civile</div>
          </div>
        </div>
        <div className="tabs">
          {tabs.map(t=>(
            <button key={t.id} className={`tab-btn ${tab===t.id?'active':''}`} onClick={()=>setTab(t.id)}>
              <span>{t.icon}</span> {t.label}
              {t.count!==undefined&&t.count>0&&<span className="tab-count">{t.count}</span>}
            </button>
          ))}
        </div>
        <div style={{display:'flex',gap:8,alignItems:'center'}}>
          <button className="btn-outline btn-sm" onClick={()=>loadAll()}>
            {loading?"‚è≥":"üîÑ"} Rafra√Æchir
          </button>
          <button className="btn-outline btn-outline-red btn-sm" onClick={handleDisconnect}>D√©connexion</button>
        </div>
      </header>

      {error&&<div className="error-box" style={{margin:'16px 28px 0'}}>{error}</div>}

      <main style={{padding:'24px 28px',maxWidth:1320,margin:'0 auto'}}>
        {tab==="dashboard"&&<Dashboard audits={audits} findings={findings} capa={capas} preuves={preuves} onNav={setTab}/>}
        {tab==="audits"&&<AuditsView api={api} audits={audits} findings={findings} reload={()=>loadAll()}/>}
        {tab==="findings"&&<FindingsView api={api} audits={audits} findings={findings} preuves={preuves} reload={()=>loadAll()}/>}
        {tab==="capa"&&<CapaView api={api} findings={findings} capas={capas} reload={()=>loadAll()}/>}
        {tab==="preuves"&&<PreuvesView api={api} findings={findings} capas={capas} preuves={preuves} reload={()=>loadAll()}/>}
      </main>
    </div>
  );
}

ReactDOM.createRoot(document.getElementById('app')).render(<App/>);
</script>
</body>
</html>
